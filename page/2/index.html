<html>

<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>
    JojoLegend
</title>
<link rel="shortcut icon" href="https://dzkjz.github.io//favicon.ico?v=1596645853433">
<!-- <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous"> -->
<link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://dzkjz.github.io//styles/main.css">
<!-- js -->
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<script src="https://dzkjz.github.io//media/js/jquery.sticky-sidebar.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/moment.js/2.23.0/moment.min.js"></script>


</head>

<body>
    <div class="main">
        <div class="header">
    <div class="nav">
        <div class="logo">
            <a href="https://dzkjz.github.io/">
                <img class="avatar" src="https://dzkjz.github.io//images/avatar.png?v=1596645853433" alt="">
            </a>
            <div class="site-title">
                <h1>
                    JojoLegend
                </h1>
            </div>
        </div>
        <span class="menu-btn fa fa-align-justify"></span>
        <div class="menu-container">
            <ul>
                
                    
                            <li>
                                <a href="/" class="menu">
                                    é¦–é¡µ
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/archives" class="menu">
                                    å½’æ¡£
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/tags" class="menu">
                                    æ ‡ç­¾
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/post/about" class="menu">
                                    å…³äº
                                </a>
                            </li>
                            
                                
            </ul>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        $(".menu-btn").click(function() {
            $(".menu-container").slideToggle();
        });
        $(window).resize(function() {

            if (window.matchMedia('(min-width: 960px)').matches) {
                $(".menu-container").css('display', 'block')
            } else {
                $(".menu-container").css('display', 'none')
            }

        });
    });
</script>

            <div id="main-content" class="post-container main-container">
                <div id="content" class="main-container-left">
                    
        
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://dzkjz.github.io/post/xiang-google-ti-jiao-zhan-dian-qing-qiu-shou-lu/">
                         å‘googleæäº¤ç«™ç‚¹ã€è¯·æ±‚æ”¶å½•ã€‘
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2020-07-31</time>
                    
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                        <div class="post-content-content">
                                            ç™»å½•åœ°å€ https://search.google.com/
éœ€è¦éªŒè¯åŸŸåæ‰€æœ‰æƒ
å‚è€ƒ How to Ask Google to Recrawl URLs of Your WordPress Site
æˆ– How to Ask Google to Recrawl URLs of Your WordPress Site
æäº¤é¡µé¢ indexè¯·æ±‚

ç°åœ¨æœç´¢æ¡†ä¸­è¾“å…¥é¡µé¢åœ°å€ï¼Œå›è½¦ï¼Œçœ‹æ˜¯ä¸æ˜¯é¡µé¢è¢«ç´¢å¼•äº†ï¼Œå¦‚æœéœ€è¦ç´¢å¼• ç‚¹REQUEST INDEXINGå³å¯ã€‚
æäº¤sitemap

ä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªå°æ—¶åˆ°ä¸€å¤©å°±æ”¶å½•äº†ã€‚

                                        </div>
                                        
                                            <a class="btn btn-text" href="https://dzkjz.github.io/post/xiang-google-ti-jiao-zhan-dian-qing-qiu-shou-lu/">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://dzkjz.github.io/post/laravel-shi-yong-sendgrid-de-pei-zhi/">
                        laravelä½¿ç”¨sendgridçš„é…ç½®
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2020-07-31</time>
                    
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                        <div class="post-content-content">
                                            petapi-appçš„.envæ–‡ä»¶éœ€è¦ä¿®æ”¹ï¼š
å°‡QUEUE_CONNECTION=syncæ”¹çˆ²ï¼š
QUEUE_CONNECTION=database


é€™æ¨£æ‰èƒ½ä½¿ç”¨queue jobï¼Œä¹‹å‰ä¸æ”¹å°±ä¸€ç›´ç»™ğŸ‘´æŠ¥500é”™è¯¯ï¼š

è€Œä¸”å‚è€ƒä½¿ç”¨ https://github.com/s-ichikawa/laravel-sendgrid-driver
ä¹‹å sendgrid é…ç½®å°±å¾ˆç®€å•äº†ï¼š

.env
MAIL_DRIVER=sendgrid
SENDGRID_API_KEY=&#39;YOUR_SENDGRID_API_KEY&#39;

config/services.php (In using lumen, require creating config directory and file.)
&#39;sendgrid&#39; =&amp;gt; [
  &#39;api_key&#39; =&amp;gt; env(&#39;SENDGRID_API_KEY&#39;),
],

config/mail.php
&#39;mailers&#39; =&amp;gt; [
  &#39;sendgrid&#39; =&amp;gt; [
      &#39;transport&#39; =&amp;gt; &#39;sendgrid&#39;,
  ],
],


ç”¨äº†ä¹‹åæŠ¥550é”™è¯¯
å®˜æ–¹æ–‡æ¡£å†™




550
Requested action not taken: mailbox unavailable
The userâ€™s mailbox was unavailable. Usually because it could not be found, or because of incoming policy reasons. Remove these address from your list - it is likely a fake, or it was mistyped.











æ‰€ä»¥åˆæ¢æˆäº†åŸæ¥çš„é»˜è®¤é…ç½®ï¼Œå¹¶ä¸”å‚è€ƒ https://sendgrid.com/docs/for-developers/sending-email/laravel/ é…ç½®äº†.envï¼Œç„¶åå°±okäº† portæ˜¯ç”¨çš„587+ tlsæ²¡æœ‰ç”¨ssl+465

å¦å¤–å‚è€ƒ https://laravel.io/forum/why-queue-still-waiting-when-send-mail-in-laravel å¯ä»¥åœ¨appå®¹å™¨å†…æ‰§è¡Œ
composer dumpautoload


è¿˜è¦æ³¨æ„ï¼Œä¹‹å‰ä½¿ç”¨çš„queueå®¹å™¨ï¼Œå› ä¸ºé»˜è®¤æ˜¯rootç”¨æˆ· æ— æ³•æ‰§è¡Œartisanå‘½ä»¤ æ‰€ä»¥è¿™ä¸ªå®¹å™¨å°±ç”¨ä¸ä¸Šäº†ã€‚
äºæ˜¯åˆæ”¹æˆäº†åœ¨dockerå®¹å™¨é‡ŒåŠ supervisordï¼š

ä¸è¿‡åœ¨ä½¿ç”¨supervisordå‰å¤šè¯´å‡ å¥ï¼Œ
å¹³æ—¶æ‰§è¡Œçš„ php artisan queue:workä¸€æ—¦å…³é—­terminalï¼Œå°±ä¼šä¸­æ­¢ï¼Œæ‰€ä»¥éœ€è¦ä»‹ç»ä¸€ä¸ªnohupå‘½ä»¤ï¼Œæ­¤å‘½ä»¤å¯ä»¥å¿½ç•¥terminalä¸­æ­¢ï¼Œnohup-è¿è¡Œä¸å—æŒ‚æ–­å½±å“çš„å‘½ä»¤ï¼Œå¹¶é‡‡ç”¨éttyè¾“å‡º ï¼Œé‚£ä¹ˆå‚è€ƒhttps://stackoverflow.com/a/28625847 å³å¯æ‰§è¡Œï¼š
nohup php artisan queue:work --daemon &amp;amp;
æˆ–è€…æ‰§è¡Œä¸‹é¢å‘½ä»¤æŠŠlogè¾“å‡ºåˆ°æ–‡ä»¶ä¸­
nohup php artisan queue:work --daemon &amp;gt; app/storage/logs/laravel.log &amp;amp;

å¼€å§‹è®²è§£å¦‚ä½•ä½¿ç”¨supervisord:
å®˜æ–¹è®²è§£
è¡¥å……è®²è§£
Installing Supervisor to Manage Laravel Queue Processes on Ubuntu
æ‰§è¡Œsudo apt install supervisor è¿™ä¸ªå®‰è£…ç”±äºå¯ä»¥åœ¨dockerfileä¸­å®Œæˆæ‰€ä»¥ç›´æ¥åŠ åˆ°äº†appæœåŠ¡çš„Dockerfileä¸­ã€‚
FROM php:7.2.19-fpm

# Arguments defined in docker-compose.yml
ARG user
ARG uid

# Install system dependencies
RUN apt-get update &amp;amp;&amp;amp; apt-get install -y \
    git \
    curl \
    libpng-dev \
    libonig-dev \
    libxml2-dev \
    zip \
    unzip \
	supervisor


# Clear cache
RUN apt-get clean &amp;amp;&amp;amp; rm -rf /var/lib/apt/lists/*

# Install PHP extensions
RUN docker-php-ext-install pdo_mysql mbstring exif pcntl bcmath gd

# Get latest Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Create system user to run Composer and Artisan Commands
RUN useradd -G www-data,root -u $uid -d /home/$user $user
RUN mkdir -p /home/$user/.composer &amp;amp;&amp;amp; \
    chown -R $user:$user /home/$user

# Set working directory
WORKDIR /var/www

USER $user


ç„¶åæ˜¯Supervisoré…ç½®æ–‡ä»¶ï¼Œé»˜è®¤æƒ…å†µè¿™ä¸ªé…ç½®æ–‡ä»¶éœ€è¦æ”¾åœ¨/etc/supervisor/conf.dæ–‡ä»¶å¤¹ä¸‹é¢ï¼Œæ­¤æ–‡ä»¶å¤¹ä¸‹ï¼Œå¯ä»¥åˆ›å»ºæ— æ•°ä½ éœ€è¦çš„é…ç½®æ–‡ä»¶ï¼Œåæ­£éœ€è¦supervisorç›‘è§†çš„å°±ç»™åˆ°è¿™é‡Œé¢ï¼Œé‚£è¿™ä¸ªæ–‡ä»¶å¤¹åœ¨docker-compose.prod.ymlé‡Œé¢ç›´æ¥ç”¨volumeæŒ‚è½½å¥½å°±è¡Œäº†ï¼Œæˆ‘è¿™é‡Œæ˜¯
version: &amp;quot;3.7&amp;quot;
services:
  app:
    build:
      args:
        user: petapi
        uid: 1000
      context: ./
      dockerfile: Dockerfile
    image: petapii
    container_name: petapi-app
    restart: unless-stopped
    working_dir: /var/www/
    volumes:
      - ./:/var/www
      - ./docker-compose/supervisor:/etc/supervisor/conf.d
    networks:
      - petapin

æŒ‚çš„è¿™ä¸ªæ–‡ä»¶å¤¹
- ./docker-compose/supervisor:/etc/supervisor/conf.d
ç„¶åå†åœ¨ å®¿ä¸»æœº ä¸Šä¸‹æ–‡ ./docker-compose/supervisorè·¯å¾„åˆ›å»ºåä¸ºpetapi-worker.confçš„æ–‡ä»¶ï¼Œå®¹å™¨å¯åŠ¨åï¼Œå®¹å™¨å†…å°±æŒ‚å¾—æœ‰ä¸€ä¸ª/etc/supervisor/conf.d/petapi-worker.confæ–‡ä»¶äº†ã€‚
ç¼–è¾‘æ–‡ä»¶å¦‚ä¸‹ï¼š
[program:petapi-worker]
process_name=%(program_name)s_%(process_num)02d
command=sudo php /var/www/artisan queue:work --tries=3 --sleep=3 --daemon
user=petapi
autostart=true
autorestart=true
numprocs=1
redirect_stderr=true
stopwaitsecs=3600
stdout_logfile=/var/www/storage/logs/petapi-worker-supervisor.log

æˆ‘çš„petapiæŒ‚è½½åœ¨/var/wwwä¸‹é¢ï¼Œartisanå‘½ä»¤æ‰§è¡Œä¹Ÿåœ¨æ”¹æ–‡ä»¶å¤¹è·¯å¾„ï¼Œæ‰€ä»¥commandä¸ºcommand=sudo php /var/www/artisan queue:work

ä¹Ÿå¯ä»¥ä½¿ç”¨confå†æ‰§è¡Œè„šæœ¬çš„æ–¹å¼ï¼Œå‚è€ƒ https://gist.github.com/danharper/9136507


ç”±äºéœ€è¦ç»™supervisoræ‰§è¡Œphp artisanå‘½ä»¤çš„æƒé™ï¼Œæ‰€ä»¥ç”¨æˆ·è®¾ç½®ä¸ºäº†petapiï¼Œæœ‰çš„å¦‚ï¼šHow to use Laravel Queue Worker with Supervisor  åŠInstalling Supervisor to Manage Laravel Queue Processes on Ubuntuç»™äº†ç”¨æˆ·ç»„supervisorç„¶åç»™è¿™ä¸ªç”¨æˆ·ç»„æ·»åŠ æ‰§è¡Œartisanå‘½ä»¤çš„æƒé™ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸éœ€è¦çš„ã€‚

ç„¶åæœåŠ¡å®¹å™¨å¯åŠ¨å°±æ‰§è¡Œ
sudo supervisorctl reread

sudo supervisorctl update

sudo supervisorctl start petapi-worker:*

ç›´æ¥å†™åˆ°supervisor_petapi.shè„šæœ¬é‡Œé¢ï¼Œæ–‡ä»¶åœ¨./docker-compose/supervisorå®¿ä¸»æœºæ–‡ä»¶å¤¹å†…
supervisorctl reread

supervisorctl update

supervisorctl start petapi-worker:*

ç„¶åDockerfileæ·»åŠ ï¼š
COPY --chown=$user ./docker-compose/supervisor/supervisor_petapi.sh /var/www

...
USER $user
...
CMD supervisor_petapi.sh                  

æœ‰å¼‚å¸¸:

  supervisorctl reread

error: &amp;lt;class &#39;socket.error&#39;&amp;gt;, [Errno 2] No such file or directory: file: /usr/lib/python2.7/socket.py line: 228

è¿™æ ·appå®¹å™¨å¯åŠ¨çš„æ—¶å€™å°±ä¼šæ‰§è¡Œä¸Šè¿°è„šæœ¬å‘½ä»¤äº†ã€‚
è¿˜æ˜¯æ²¡æˆåŠŸï¼Œæ˜å¤©ç»§ç»­ï¼
å‘ç°æ‰§è¡Œ
docker exec -it petapi-app bashè¿›å…¥å®¹å™¨åï¼Œç”¨æˆ·ç”±äºåœ¨Dockerfileä¸­è¢«æŒ‡å®šä¸ºäº†petapiï¼Œæ‰§è¡Œapt-getä¼šæç¤ºæ²¡æœ‰æƒé™ï¼Œæ‰€ä»¥å‚è€ƒRoot password inside a Docker containeræ‰§è¡Œdocker exec -u 0 -it petapi-app bashä»¥rootèº«ä»½ç™»å½•è¿›å…¥å³å¯
æ‰§è¡Œsupervisorctl reread
æŠ¥é”™unix:///var/run/supervisor.sock no such fileï¼Œå‚è€ƒSupervisor sock file missingæ‰§è¡Œ
service supervisor stop
service supervisor start 

æ‰§è¡Œsupervisorctl rereadæœ‰æŠ¥é”™ï¼š è¿™ä¸æ˜¯é”™ï¼›

å‚è€ƒSupervisord config changes not recognized after reread/update æ˜¯æŒ‡ï¼Œæ²¡æœ‰æ›´æ–°ï¼Œæ‰€ä»¥æ²¡æœ‰æ˜¾ç¤ºæœ‰å˜åŒ–ã€‚
ç„¶åæ‰§è¡Œsupervisorctl update
ä»¥åŠsupervisorctl start petapi-worker:*

è¿™æ¬¡æ˜¯æŠ¥é”™äº†ã€‚æ‰¾ä¸åˆ°æ–‡ä»¶ã€‚
å¦‚æœæ˜¯æŠ¥è¿™ä¸ªé”™laravel-worker: ERROR (no such group)ï¼Œå¯ä»¥çœ‹çœ‹
/etc/supervisord.confæ–‡ä»¶é…ç½®çš„
[include]
files = supervisord.d/*.conf

è¿™ä¸ªincludeéƒ¨åˆ†æ˜¯ä¸æ˜¯æŒ‡å‘çš„workeré…ç½®è·¯å¾„ï¼Œæˆ‘è¿™é‡Œæ˜¯


ç”±äºdebugéœ€è¦pså‘½ä»¤ï¼Œæ‰€ä»¥å‚è€ƒps command doesn&#39;t work in docker container,æ‰§è¡ŒRUN apt-get update &amp;amp;&amp;amp; apt-get install -y procpsæ·»åŠ ä¹‹

æ‰§è¡Œps -ef | grep supervisoræŸ¥çœ‹

ä½†æ˜¯æ‰§è¡Œservice supervisor stopåä¾ç„¶æœ‰ä¸€ä¸ª

ç´¢æ€§ç›´æ¥æ‰§è¡Œkill -s SIGTERM 468å…³é—­è¿™ä¸ª468è¿›ç¨‹ã€‚
ç„¶åæ‰§è¡Œservice supervisor startå¯åŠ¨åæŸ¥çœ‹ï¼š

ä¸‹é¢è§£é‡Šä¸€ä¸‹
/usr/bin/supervisord -c /etc/supervisor/supervisord.confï¼Œ

å‚è€ƒCreating a Configuration Fileï¼Œå¦‚æœæ‰§è¡Œç”¨æˆ·æ²¡æœ‰rootæƒé™æˆ–è€…supervisord.confæ–‡ä»¶æ²¡æœ‰æ”¾åœ¨é»˜è®¤çš„/etc/supervisord.confè·¯å¾„ï¼Œé‚£ä¹ˆ-cåé¢æ¥ä½ å®é™…é˜²æ­¢supervisord.confæ–‡ä»¶çš„è·¯å¾„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œsupervisorä¼šåœ¨å…¶å½“å‰è·¯å¾„é‡Œé¢æ‰¾è¿™ä¸ªconfæ–‡ä»¶ï¼ŒåŠ  -c å°±å¯ä»¥æŒ‡å®šå…¶ä»–ä½ç½®äº†ã€‚

ä½†æ˜¯æ‰§è¡Œsupervisorctl start petapi-worker:*

è¿™æ¬¡æ˜¯ä¾ç„¶æŠ¥é”™äº†ã€‚æ‰¾ä¸åˆ°æ–‡ä»¶ã€‚ç›´æ¥nanoç¼–è¾‘è¿™ä¸ªæ–‡ä»¶ç„¶å

ç»ˆäºç»™ğŸ‘´OKäº†ã€‚
ç„¶åæ‰§è¡Œsupervisorctl statusæŸ¥çœ‹ä¸€ä¸‹çŠ¶æ€ï¼š

è¡Œå§ã€‚
å†æ”¹ä¸€ä¸‹ã€‚
å…ˆæ‰§è¡Œsupervisorctl stop all

åŠæ‰§è¡Œservice supervisor stopåœæ‰è¿›ç¨‹ã€‚
å†æ‰§è¡Œsupervisorctl statusæŸ¥çœ‹çŠ¶æ€ï¼š

å†æ‰§è¡Œps -ef | grep supervisoræŸ¥çœ‹è¿›ç¨‹åœæ­¢å®Œæ²¡æœ‰ï¼š

OKï¼Œåœæ­¢å®Œäº†ï¼Œæˆ‘ä»¬æ”¹æ”¹è¿™ä¸ªpetapi-worker.confæ–‡ä»¶ï¼š
å»æ‰sudoåï¼š

ç„¶åæ‰§è¡Œservice supervisor startåŠ
supervisorctl reread

supervisorctl update

supervisorctl start petapi-worker:*

ç„¶åæ‰§è¡Œsupervisorctl statusæŸ¥çœ‹çŠ¶æ€

OKäº†ã€‚
æ€»ç»“
petapi-worker.confæ–‡ä»¶ï¼š
[program:petapi-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/artisan queue:work --tries=3 --sleep=3 --daemon
user=petapi
autostart=true
autorestart=true
numprocs=1
redirect_stderr=true
;stopwaitsecs=3600
stdout_logfile=/var/www/storage/logs/petapi-worker-supervisor.log

appå®¹å™¨çš„Dockerfileæ–‡ä»¶ï¼š
FROM php:7.2.19-fpm

# Arguments defined in docker-compose.yml
ARG user
ARG uid

# Install system dependencies
RUN apt-get update &amp;amp;&amp;amp; apt-get install -y \
    git \
    curl \
    libpng-dev \
    libonig-dev \
    libxml2-dev \
    zip \
    unzip \
	supervisor


# Clear cache
RUN apt-get clean &amp;amp;&amp;amp; rm -rf /var/lib/apt/lists/*

# Install PHP extensions
RUN docker-php-ext-install pdo_mysql mbstring exif pcntl bcmath gd

# Get latest Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Create system user to run Composer and Artisan Commands
RUN useradd -G www-data,root -u $uid -d /home/$user $user
RUN mkdir -p /home/$user/.composer &amp;amp;&amp;amp; \
    chown -R $user:$user /home/$user

# Set working directory
WORKDIR /var/www

USER $user

è€ƒè™‘ç»™ä¸€ä¸ªsupervisorå®¹å™¨ã€‚

å› ä¸ºsupervisorctlå‘½ä»¤æ‰§è¡Œéœ€è¦rootç”¨æˆ·ï¼Œpetapiç”¨æˆ·ä¸è¡Œã€‚

ä¹‹å‰åœ¨Dockerfileä¸­æ·»åŠ 
COPY --chown=$user  ./docker-compose/supervisor/supervisor_petapi.sh . 
...
USER $user
...
CMD /var/www/supervisor_petapi.sh
...

çš„æ–¹å¼ä¸å¯è¡Œï¼Œå› ä¸ºshè„šæœ¬é‡Œé¢çš„å‘½ä»¤æ‰§è¡Œå¿…é¡»æ˜¯rootæƒé™ï¼Œè€Œåˆ‡æ¢æˆUSER petapiåå°±æ— æ³•æ‰§è¡Œshè„šæœ¬é‡Œé¢çš„supervisorctlå‘½ä»¤äº†ã€‚
å¦å¤–ä¹Ÿä¸èƒ½å°†CMDåˆ é™¤æ¢æˆåœ¨USERåˆ‡æ¢å‰çš„RUNå‘½ä»¤ï¼Œå› ä¸ºè™½ç„¶ç”¨æˆ·æƒé™æœ‰äº†ï¼Œä½†æ˜¯å®¹å™¨æ²¡æœ‰å¯åŠ¨ï¼Œshè„šæœ¬é‡Œé¢çš„confæ–‡ä»¶æ‰§è¡Œartisanå‘½ä»¤å¿…ç„¶å¤±è´¥ã€‚
æ‰€ä»¥è€ƒè™‘ç»™ä¸€ä¸ªsupervisorå®¹å™¨ã€‚
æœ€æ–¹ä¾¿çš„æ–¹å¼ï¼š
ä¹Ÿæ˜¯æœ€åˆé€‚çš„æ–¹å¼ï¼Œè¿™æ ·ä¸€ä¸ªå®¹å™¨åªè´Ÿè´£ä¸€ä»¶äº‹ã€‚
docker-compose.prod.ymlé‡‡ç”¨php-queueæœåŠ¡ï¼Œå…¶æœåŠ¡å®¹å™¨çš„é•œåƒå°±æ˜¯è¿™ä¸ªpetapi-appçš„é•œåƒï¼Œè€Œç”¨æˆ·ä¸ç»™å‚æ•°ï¼Œåˆ™ç›´æ¥ä½¿ç”¨petapi-appä¸­å°±è®¾ç½®å¥½çš„petapiç”¨æˆ·ï¼Œç„¶åcommandå°±æ˜¯command: [&amp;quot;php&amp;quot;, &amp;quot;/var/www/app/artisan&amp;quot;, &amp;quot;queue:work&amp;quot;, &amp;quot;--daemon&amp;quot;, &amp;quot;--sleep=3&amp;quot;, &amp;quot;--tries=3&amp;quot;]
è¿™æ ·supervisoréƒ½ä¸ç”¨ã€‚
ä¸è¿‡ åŒæ—¶æˆ‘ä»¬è¿˜éœ€è¦æ‰§è¡Œä¸€ä¸ªcomposer dumpautoloadå‘½ä»¤ï¼Œå‚è€ƒUsing Docker-Compose, how to execute multiple commandsæ‰€ä»¥ï¼š
command: &amp;gt;
	bash -c &amp;quot;php artisan queue:work --sleep=3 --tries=3 &amp;amp;&amp;amp;
	composer dumpautoload&amp;quot;

å¦‚æœæ²¡æœ‰å®‰è£…bashçš„ï¼Œè¯·ä½¿ç”¨sh -c
docker-composer.prod.yml
version: &amp;quot;3.7&amp;quot;
services:
  app:
    build:
      args:
        user: petapi
        uid: 1000
      context: ./
      dockerfile: Dockerfile
    image: petapii
    container_name: petapi-app
    restart: unless-stopped
    working_dir: /var/www/
    volumes:
      - ./:/var/www
    networks:
      - petapin
  php-queue:
    restart: always
    container_name: petapi-app-queue
    working_dir: /var/www/
    image: petapii
    depends_on:
      - &amp;quot;app&amp;quot;
    command: bash -c &amp;quot;php artisan queue:work --sleep=3 --tries=3 &amp;amp;&amp;amp; composer dumpautoload&amp;quot;
    volumes:
      - ./:/var/www
    networks:
      - petapin
  frontapp:
    build:
      context: ~/petclient/dockerfiles/node/
      dockerfile:  Dockerfile
    image: frontapp
    container_name: petclient-frontapp
    restart: unless-stopped
    networks:
      - petclientn
  db:
    image: mysql:5.7
    container_name: petapi-db
    restart: unless-stopped
   #env_file:
     # - ~/petapi/pets-api/.env
    environment:
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_USER: ${DB_USERNAME}
      SERVICE_TAGS: dev
      SERVICE_NAME: mysql
    volumes:
      - ./docker-compose/mysql:/docker-entrypoint-initdb.d
      - ./docker-compose/mysql/data:/var/lib/mysql
    networks:
      - petapin
  nginx:
   # build:
    # context: ./dockerfiles/nginx/
   #  dockerfile: Dockerfile
  #  image: nginx:1.19.1-alpine-custom
    image: nginx:1.19.1-alpine
    container_name: pet-nginx
    restart: always
    depends_on:
      - app
      - frontapp
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./:/var/www
      - ./docker-compose/nginx:/etc/nginx/conf.d
      - ./docker-compose/nginx/certs:/etc/nginx/certs
    networks:
      - petapin
      - petclientn
networks:
  petapin:
    driver: bridge
  petclientn:
    driver: bridge


                                        </div>
                                        
                                            <a class="btn btn-text" href="https://dzkjz.github.io/post/laravel-shi-yong-sendgrid-de-pei-zhi/">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://dzkjz.github.io/post/mysql-docker-rong-qi-guan-yu-ru-he-chu-li-down-hou-up-shu-ju-jiu-diu-shi-de-wen-ti-yi-ji-yuan-li/">
                        Mysql Dockerå®¹å™¨å…³äºå¦‚ä½•å¤„ç†downåupæ•°æ®å°±ä¸¢å¤±çš„é—®é¢˜ä»¥åŠåŸç†
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2020-07-27</time>
                    
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                        <div class="post-content-content">
                                            Mysql Dockerå®¹å™¨å…³äºå¦‚ä½•å¤„ç†downåupæ•°æ®å°±ä¸¢å¤±çš„é—®é¢˜ä»¥åŠåŸç†
[toc]
docker-compose å¯ä»¥å¾ˆæ–¹ä¾¿çš„ç”¨äºéƒ¨ç½²å¤šå®¹å™¨ç¯å¢ƒã€‚å…¶ä¸­æ¯”è¾ƒç¹ççš„å°±æ˜¯åšåˆ°å¤šåº”ç”¨é—´æ•°æ®åˆ†ç¦»ã€‚
å®¹å™¨éšæ—¶æˆ‘ä»¬å¯ä»¥å…³é—­æ›´æ–°æ›´æ¢ï¼Œä½†æ˜¯è¦æ€ä¹ˆåšåˆ°æ•°æ®çš„è¿ç»­æ€§å°±å¾ˆå…³é”®äº†ã€‚
ä¸€ã€åœºæ™¯ä»‹ç»
æ¯”è¾ƒå¸¸è§çš„æƒ…å†µï¼Œå¦‚æœä½ è¿è¡Œèµ·ä¸€ä¸ªæ•°æ®åº“å®¹å™¨ï¼Œå¦‚æœä½ åˆ é™¤äº†è¿™ä¸ªå®¹å™¨ï¼Œé‚£å­˜åœ¨å…¶ä¸­çš„æ•°æ®ä¹Ÿå°±ä¸¢å¤±äº†ã€‚
ç‰¹åˆ«æ˜¯æ‰§è¡Œdocker-compose downç„¶åæ›´æ–°dockerfileå’Œdocker-compose.ymlæ–‡ä»¶ï¼Œå†æ‰§è¡Œdocker-compose up -dï¼Œä½ ä¹‹å‰ç½‘ç«™çš„æ•°æ®å°±ä¸¢äº†ã€‚
äºŒã€åŸç†ä»¥åŠåŸå› 

æˆ‘ä»¬åœ¨æœ‰è¿è¡Œæ•°æ®åº“å®¹å™¨çš„æœºå™¨é‡Œé¢æ¼”ç¤ºï¼›

æ‰§è¡Œdocker volume lsæŸ¥çœ‹æœåŠ¡å™¨é‡Œé¢çš„æ•°æ®å·ï¼š

é»˜è®¤driverå°±æ˜¯local ï¼Œæˆ‘ä»¬é…ç½®çš„æ•°æ®å·éƒ½åœ¨è¿™é‡Œé¢äº†ã€‚
ä¸ºäº†æŸ¥çœ‹å“ªä¸€ä¸ªæ˜¯æ•°æ®åº“å®¹å™¨çš„æ•°æ®å·ï¼Œä»¥åŠå¯¹åº”çš„è¯¦ç»†ä¿¡æ¯
æ‰§è¡Œdocker inspect æ•°æ®åº“å®¹å™¨å
ç„¶åæ‰¾åˆ° Mountséƒ¨åˆ†ï¼š

ç¬¬ä¸€ä¸ªæˆ‘ä»¬é…ç½®çš„å¯ä»¥åœ¨docker-compose.prod.ymlä¸­æ‰¾åˆ°ï¼š
  db:
    image: mysql:5.7
    container_name: ***api-db
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_USER: ${DB_USERNAME}
      SERVICE_TAGS: dev
      SERVICE_NAME: mysql
    volumes:
      - ./docker-compose/mysql:/docker-entrypoint-initdb.d

è€Œç¬¬äºŒä¸ªå¯¹åº”ç›®æ ‡åœ°å€æ˜¯/var/lib/mysqlçš„ï¼Œå› ä¸ºæˆ‘æ²¡æœ‰é…ç½®ï¼Œæ‰€ä»¥è‡ªåŠ¨ç»™äº†ä¸€ä¸ªï¼Œæ­£æ˜¯è¿™ä¸ªæ²¡æœ‰é…ç½®ï¼Œå¯¼è‡´æ¯æ¬¡docker-compose up -då°±ç”Ÿæˆä¸€ä¸ªæ–°å®¹å™¨åŠå¯¹åº”çš„æ•°æ®å·ï¼Œç„¶åä¹‹å‰çš„æ•°æ®åº“æ•°æ®å°±ä¸¢å¤±äº†ã€‚
ä¸‰ã€å¤„ç†åŠæ³•
å¦‚æœä½ é…ç½®äº†æ¯”å¦‚
  db:
    ...
    volumes:
      - ./docker-compose/mysql:/docker-entrypoint-initdb.d
      - /data/mysql:/var/lib/mysql
   #   - /data/pgsql:/var/lib/postgresql
   #   - /data/maria:/var/lib/mariadb
   #   - /data/redis:/var/lib/redis
   #   - /data/memcached:/var/lib/memcached
   #   - /data/neo4j:/var/lib/neo4j/data
    networks:
      ...

é…ç½®äº†å¯¹åº”çš„æœ¬åœ°[å®¿ä¸»æœº]æ•°æ®å·ä½ç½®ï¼Œç¬¬ä¸€æ¬¡docker-compose up -dçš„æ—¶å€™ä¼šç›´æ¥å…³è”èµ·æ¥ï¼Œè€Œä¸‹ä¸€æ¬¡æ‰§è¡Œdocker-compose up -dçš„æ—¶å€™ï¼Œdaemonæ‰§è¡Œåˆ°ç”Ÿæˆä¸€ä¸ªå¯¹åº”æ•°æ®å·ä½ç½®çš„æ—¶å€™ï¼Œå‘ç°å·²ç»ç»™äº†é…ç½®ï¼Œé‚£å°±è·³è¿‡ï¼Œä½¿ç”¨å…ˆå‰çš„ã€‚
å½“ç„¶ä¹Ÿå¯ä»¥è¿™ä¹ˆé…ç½®ï¼š
volumes:
- db-data:/var/lib/mysql
volumes:
 db-data:
  driver: local


å‚è€ƒ Running PostgreSQL using Docker Compose
å‚è€ƒ Data is lost in Mysql docker container after comminting it to a new image?

I don&#39;t know which image you&#39;re using but I believe every Dockerfile of official mysql images has following command:
VOLUME /var/lib/mysql

which means all mysql data goes to volume. From docker volume docs they specially mentioned that:
&amp;gt; Changes to a data volume will not be included when you update an image.

And this is the root cause you loss your data in newly started container.
For your question:

How to achieve this?

You can use either mounted volumes, or create a data volume container, then run mysql container with option --volumes-from. The former links contain step-by-step guide of how to do it.

I don&#39;t want to use mounted volumes because i want to link this container with another container of my application so that it can inset and update into db

I don&#39;t know what other concerns you have about mounted volumes, but as far as I can tell, using mounted volumes does not prevent you to link containers.
Hope this helps you.


å››ã€å¦‚æœä¸æ…ä¸¢å¤±ï¼Œæ€ä¹ˆæ¢å¤
å¦‚æœæ•°æ®å·éƒ½åˆ é™¤äº† docker rm å®¹å™¨çš„æ—¶å€™ æ·»åŠ äº† -v æˆ– -volumeï¼Œé‚£å°±æ‹œæ‹œï¼Œæ²¡æœ‰ä»»ä½•åŠæ³•çš„ã€‚å¦‚æœæ²¡æœ‰åˆ é™¤volume å‚è€ƒï¼š
Saving &#39;lost&#39; MYSQL database running in Docker
æ›´å¤šå¯ä»¥çœ‹å®˜æ–¹æ–‡æ¡£

                                        </div>
                                        
                                            <a class="btn btn-text" href="https://dzkjz.github.io/post/mysql-docker-rong-qi-guan-yu-ru-he-chu-li-down-hou-up-shu-ju-jiu-diu-shi-de-wen-ti-yi-ji-yuan-li/">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://dzkjz.github.io/post/jie-jue-sitemap-robotstxt-yi-ji-ti-jiao-google-index/">
                         è§£å†³ sitemap robots.txt ä»¥åŠæäº¤google index
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2020-07-26</time>
                    
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                        <div class="post-content-content">
                                            Sitemap
åœ¨nuxt appé‡Œé¢æ‰§è¡Œ
npm install @nuxtjs/sitemap

//nuxt.config.js
  modules: [
    // Doc: https://axios.nuxtjs.org/usage
    &#39;@nuxtjs/axios&#39;,
    &#39;@nuxtjs/auth&#39;,
    &#39;vue-social-sharing/nuxt&#39;,
    // Doc: https://github.com/nuxt-community/dotenv-module
    &#39;@nuxtjs/dotenv&#39;,
    &#39;cookie-universal-nuxt&#39;,//https://www.npmjs.com/package/cookie-universal-nuxt
    &#39;@nuxtjs/sitemap&#39;,
  ],

  sitemap: {
    //https://www.npmjs.com/package/@nuxtjs/sitemap
    hostname: &#39;https://&#39; + process.env.DOMAIN_NAME,
    gzip: true,
    exclude: [
      &#39;/verify/**&#39;,
      &#39;/verifynew/**&#39;,
      &#39;/password_reset/**&#39;,
      &#39;/dashboard_reset/**&#39;,
      &#39;/animals/create/**&#39;,
    ],

å…·ä½“é…ç½®å®˜æ–¹æ–‡æ¡£æœ‰è®²ã€‚
é»˜è®¤æƒ…å†µä¸‹åªæœ‰staticé¡µé¢ä¼šè‡ªåŠ¨æ·»åŠ ï¼Œå¯¹äºåŠ¨æ€çš„è·¯ç”±é¡µé¢ï¼Œparent/:childrenï¼Œè¿™æ ·çš„ï¼Œå‚è€ƒ HOW TO: Include dynamic routes in sitemap with Nuxt.js
Robot.txt
npm install @nuxtjs/robots
//nuxt.config.js
  modules: [
    // Doc: https://axios.nuxtjs.org/usage
    &#39;@nuxtjs/axios&#39;,
    &#39;@nuxtjs/auth&#39;,
    &#39;vue-social-sharing/nuxt&#39;,
    // Doc: https://github.com/nuxt-community/dotenv-module
    &#39;@nuxtjs/dotenv&#39;,
    &#39;cookie-universal-nuxt&#39;,//https://www.npmjs.com/package/cookie-universal-nuxt
    &#39;@nuxtjs/sitemap&#39;,
    &#39;@nuxtjs/robots&#39;,
  ],
        robots: [ //https://www.npmjs.com/package/@nuxtjs/robots
    {
      // UserAgent: &#39;Googlebot&#39;,
      UserAgent: &#39;*&#39;,
      Disallow: () =&amp;gt; [
        &#39;/verify&#39;,
        &#39;/verify&#39;,
        &#39;/verifynew&#39;,
        &#39;/password_reset&#39;,
        &#39;/dashboard_reset&#39;,
        &#39;/animals/create&#39;,
      ], // accepts function
      Sitemap: &#39;https://&#39; + process.env.DOMAIN_NAME + &#39;/sitemap.xml&#39;,
    }
  ],

å…·ä½“é…ç½®ä»‹ç»å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚
Ask Google to recrawl your URLs
Submit a sitemap (many URLs at once)
A sitemap is an important way for Google to discover URLs on your site. A sitemap can also include additional metadata about alternate language versions and video-, image-, or news-specific pages. Learn how to create a sitemap.
If you have not changed your sitemap since the last time Google crawled it, resubmitting the sitemap won&#39;t have any additional benefit. If you have updated pages in the sitemap, mark them with &amp;lt;lastmod&amp;gt;.
Here are the different ways that you can alert Google about your sitemap:

Submit a sitemap using the sitemaps report.
Use the ping tool. Send a GET request in your browser or the command line to this address, specifying the full URL of the sitemap. Be sure that the sitemap file is accessible:
http://www.google.com/ping?sitemap=*&amp;lt;full_URL_of_sitemap&amp;gt;*
Example:
http://www.google.com/ping?sitemap=https://example.com/sitemap.xml
Insert the following line anywhere in your robots.txt file, specifying the path to your sitemap. We will find it the next time we crawl your site:
Sitemap: http://example.com/my_sitemap.xml

Nuxté¡µé¢è·³è½¬è¿‡åº¦åŠ¨æ•ˆ
/*assets/styles/main.css*/
/*@import &#39;@vue-cookie-accept-decline.css&#39;;*/

.page-enter-active, .page-leave-active {
  transition: opacity .5s;
}

.page-enter, .page-leave-to {
  opacity: 0;
}

//nuxt.config.js 
css: [
      ...
    &#39;@/assets/styles/main.css&#39;,
      ...
  ],

å®˜æ–¹æ–‡æ¡£ï¼š
https://nuxtjs.org/api/configuration-loading
https://nuxtjs.org/api/pages-transition
//nuxt.config.js
loading: {
    color: &#39;orange&#39;,
    height: &#39;5px&#39;,
    failedColor: &#39;red&#39;,
    duration: 5000,
    continuous: true,
  },

è‡ªå®šä¹‰çš„å¯ä»¥å‚è€ƒ ä½¿ç”¨è‡ªå®šä¹‰çš„ç»„ä»¶è®¾ç½®åŠ è½½æ ·å¼
æ”¹å˜Favicon
å‚è€ƒ https://github.com/nuxt/nuxt.js/issues/903
//nuxt.config.js
link: [
      {rel: &#39;icon&#39;, type: &#39;image/x-icon&#39;, href: &#39;/tiere_favi.png&#39;},
    ]

å®˜æ–¹æ–‡æ¡£ä¹Ÿå¯ä»¥çœ‹çœ‹

                                        </div>
                                        
                                            <a class="btn btn-text" href="https://dzkjz.github.io/post/jie-jue-sitemap-robotstxt-yi-ji-ti-jiao-google-index/">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://dzkjz.github.io/post/cai-keng-ji-lu-nuxtjs-and-ant-design-vue-pei-zhi/">
                        ã€Œè¸©å‘è®°å½•ã€ Nuxt.js &amp; Ant-design-vue é…ç½®
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2020-07-25</time>
                    
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                        <div class="post-content-content">
                                            Nuxt.js &amp;amp; ant-design-vue
æœ€è¿‘å¼€å‘ä¸€ä¸ªå¸¦seoä»¥åŠéƒ¨åˆ†åå°åŠŸèƒ½çš„é¡¹ç›®ï¼Œnuxtä½œä¸ºvue ssræ¡†æ¶å¯ä»¥éå¸¸å¥½çš„å®Œæˆè¿™ä¸ªéœ€æ±‚ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©äº†ant-design-vueä½œä¸ºUIç»„ä»¶åº“ã€‚
ä»¥ä¸‹æ˜¯è¸©å‘çš„ä¸€äº›è®°å½• ï¼š
é¦–å…ˆä»‹ç»ä¸€ä¸‹é¡¹ç›®æƒ…å†µå’Œéœ€æ±‚ï¼š

Nuxt.jsæ˜¯ä¸€ä¸ª Vue.js é€šç”¨æ¡†æ¶ï¼Œé¢„è®¾äº†ä½¿ç”¨ Vue.jså¼€å‘SSRçš„å„ç§é…ç½®ã€‚é¡¹ç›®ä¸­ä½¿ç”¨çš„æ˜¯SSRæ¨¡å¼ï¼Œå› æ­¤é¦–å±æ˜¯ç”±æœåŠ¡ç«¯å®Œæˆæ¸²æŸ“ã€‚
é¡¹ç›®ä»…ç”¨åˆ°å°‘æ•°çš„UIç»„ä»¶ï¼Œå› æ­¤æˆ‘ä»¬å¸Œæœ›ä½¿ç”¨æŒ‰éœ€åŠ è½½ç»„ä»¶ï¼Œä»¥å‡å°‘ç½‘ç»œå¼€é”€ã€‚

1. æŒ‰éœ€åŠ è½½å¼•å…¥ç»„ä»¶
é¦–å…ˆæˆ‘ä»¬ç§»é™¤æ‰ nuxt.config.js ä¸­
{   css: [&#39;ant-design-vue/dist/antd.css&#39;],   // è¿™é‡Œä¼šå…¨å±€å¼•å…¥æ‰€æœ‰æ ·å¼ï¼Œä¸æ˜¯æˆ‘ä»¬æ‰€å¸Œæœ›çš„æŒ‰éœ€åŠ è½½ }

å‚è€ƒå®˜æ–¹æ–‡æ¡£antd-vue # æŒ‰éœ€åŠ è½½ï¼š
// åŒæ—¶å‚è€ƒ Nuxt-cli åˆ›å»ºé¡¹ç›®æ—¶ åˆ›å»ºçš„ plugin/antd-ui.js 
import Vue from &#39;vue&#39; import Button from &#39;ant-design-vue/lib/button&#39;; 
import &#39;ant-design-vue/lib/button/style&#39;; // æˆ–è€… ant-design-vue/lib/button/style/css åŠ è½½ css æ–‡ä»¶  
Vue.use(Button.name, Button)

ç¼–è¯‘æœªé€šè¿‡ï¼Œæç¤ºé”™è¯¯ï¼š
// https://github.com/ant-design/ant-motion/issues/44 .bezierEasingMixin(); ^ Inline JavaScript is not enabled. Is it set in your options?

æ ¹æ®æŠ¥é”™æ‰€æä¾›çš„ä¿¡æ¯ï¼Œlesså‡çº§åˆ°3.0 åï¼Œéœ€è¦ less-loaderé…ç½®ä¸€ä¸ªåŠŸèƒ½ï¼Œæ‰èƒ½æ­£å¸¸ä½¿ç”¨ï¼š
// nuxt.config.js 
{  
    build: {   
        loaders: {    
            less: {     
                javascriptEnabled: true    
            }   
        }  
    } 
}

ç¼–è¯‘é€šè¿‡ï¼Œæ‰“å¼€é¡µé¢ï¼Œè¿”å›500ï¼Œæç¤ºï¼š

image.png
ç¼–è¯‘èƒ½é€šè¿‡ï¼Œè¯´æ˜ä»£ç ç¼–è¯‘æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯serverç«¯æ‰§è¡Œæ—¶å‡ºç°äº†é”™è¯¯ã€‚å°è¯•æ³¨é‡Šæ‰plugin/antd-ui.jså¼•å…¥æ ·å¼æ–‡ä»¶è¿™è¡Œ import &#39;ant-design-vue/lib/button/style&#39;; ï¼Œserveré¦–å±æ¸²æŸ“èƒ½å¤Ÿæ­£å¸¸å¯åŠ¨ï¼Œä½†å¼•å…¥çš„buttonç»„ä»¶æ ·å¼ä¸¢å¤±ã€‚
æ‰“å¼€ ant-design-vue/lib/button/style/index.js æŸ¥çœ‹ï¼š
&#39;use strict&#39;; 
require(&#39;../../style/index.less&#39;); 
require(&#39;./index.less&#39;);  
// ant-design-vue/es/button/style/index.js 
import &#39;../../style/index.less&#39;; 
import &#39;./index.less&#39;;

å¯ä»¥çœ‹åˆ°ï¼Œantd-vueä¸ºç”Ÿäº§ç¯å¢ƒæä¾›äº†ä¸¤ç§æ¨¡å—çš„ä»£ç ã€‚ä¸ºäº†tree-shaking æˆ‘ä»¬ä¼˜å…ˆé€‰æ‹© es æ¨¡å—ã€‚

è¡¥å……çŸ¥è¯†ï¼šç°åœ¨çš„webpack@4+ æ”¯æŒè¯†åˆ«é¡¹ç›® packge.json moduleå­—æ®µï¼Œä½¿ç”¨ESModuleçš„ä¾èµ–æ›´å¥½çš„æ”¯æŒæ„å»ºä¸­çš„tree-shakingã€‚

ä¿®æ”¹ä»£ç ä¸º es/button/...ï¼Œç¼–è¯‘é€šè¿‡ï¼Œä½†é¡µé¢ä»æŠ›å‡ºä¸€500æœåŠ¡ç«¯é”™è¯¯ï¼š

image.png
æ ¹æ®é”™è¯¯æç¤ºcannot use import statementå’ŒesåŒ…ä½¿ç”¨çš„ESModuleè¯­æ³•ï¼ŒçŒœæµ‹æœåŠ¡ç«¯ä¾§æ¸²æŸ“é¡µé¢æ—¶è¯­æ³•å‡ºé”™ï¼ŒNode.js ä¸èƒ½ç›´æ¥è¯†åˆ« .jsæ–‡ä»¶å†…çš„ESModuleè¯­æ³•ã€‚
// .nuxt.config.js 
{  
    plugins: 
    [   
        {    
            src: &#39;@/plugins/antd-ui&#39;,    
            mode: &#39;client&#39; // ä»… å®¢æˆ·ç«¯ä½¿ç”¨plugin   
        }  
    ] 
}

é¡µé¢æ­£å¸¸åŠ è½½ï¼Œä½†Vue.js ç»™å‡ºäº†é”™è¯¯æç¤º

image.png
æ­¤æ—¶ï¼Œæˆ‘ä»¬å†å°†pluginä»£ç æ›¿æ¢å›libä»¥åŠç§»é™¤mode: &#39;client ï¼Œé”™è¯¯åˆå›åˆ°äº†æœ€å¼€å§‹çš„ invalid or unexpected tokenã€‚
æœç´¢Nuxtå®˜æ–¹æ–‡æ¡£ï¼š

å¦‚æœè¦ä½¿ç”¨Babelä¸ç‰¹å®šçš„ä¾èµ–å…³ç³»è¿›è¡Œè½¬æ¢ï¼Œä½ å¯ä»¥åœ¨build.transpileä¸­æ·»åŠ å®ƒä»¬ï¼Œtranspileä¸­çš„é€‰é¡¹å¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ–æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡ï¼Œç”¨äºåŒ¹é…ä¾èµ–é¡¹æ–‡ä»¶åã€‚

æ·»åŠ é…ç½®ï¼š
{ // nuxt.config.js  
    build: {   
        transpile: [/ant-design-vue/]
    } 
}

ç»ˆäºï¼ŒæœåŠ¡ç«¯æ¸²æŸ“æ­£å¸¸ï¼Œæ ·å¼ä¹Ÿæ­£å¸¸åŠ è½½ã€‚æ¥ç€å¼•å…¥ ant-design-vueå®˜æ–¹æ¨èä½¿ç”¨çš„æ’ä»¶babel-plugin-import
// nuxt.config.js 
{  
    build: {
        babel: {
            plugins: [
                [      
                    &#39;import&#39;,      
                    {       
                        libraryName: &#39;ant-design-vue&#39;,       
                        libraryDirectory: &#39;es&#39;,       
                        // é€‰æ‹©å­ç›®å½• ä¾‹å¦‚ es è¡¨ç¤º ant-design-vue/es/component       
                        // lib è¡¨ç¤º ant-design-vue/lib/component              
                        style: true       
                        // é»˜è®¤ä¸ä½¿ç”¨è¯¥é€‰é¡¹ï¼Œå³ä¸å¯¼å…¥æ ·å¼ , æ³¨æ„ ant-design-vue ä½¿ç”¨ js æ–‡ä»¶å¼•å…¥æ ·å¼       
                        // true è¡¨ç¤º import  &#39;ant-design-vue/es/component/style&#39;      
                        // &#39;css&#39; è¡¨ç¤º import &#39;ant-design-vue/es/component/style/css&#39;      
                    }     
                ]    
            ]   
        }  
    } 
}  // plugins/antd-ui.js 
import Vue from &#39;vue&#39; 
import { Button } from &#39;ant-dsign-vue&#39; // è¿™æ—¶ï¼Œå¯ä»¥é€šè¿‡ ç®€å†™çš„æ–¹å¼å¼•å…¥æ ·å¼å’Œç»„ä»¶  
Vue.use(Button)

2. pagesç›®å½•å†…å¼•å…¥ç»„ä»¶

flash.gif
ä¸Šå›¾æ˜¯åœ¨pages/index.vueå†…å¼•å…¥ç»„ä»¶ï¼Œnpm run build &amp;amp;&amp;amp; npm run start æ‰§è¡Œåçš„çº¿ä¸Šç¯å¢ƒï¼Œå¯ä»¥çœ‹åˆ°æ ·å¼åœ¨åˆ·æ–°é¦–å±æ—¶ï¼Œä¼šçœ‹åˆ°é—ªçƒçš„ç°è±¡ï¼Œè¿™é‡Œå‡ºç°çš„é—®é¢˜åœ¨äºå…¥å£æ–‡ä»¶å¹¶ä¸åŒ…å«ç»„ä»¶ï¼Œè€Œæ˜¯å¼‚æ­¥å¼•å…¥çš„ï¼Œä»ç¼–è¯‘ç»“æœä¸Šä¹Ÿå¯ä»¥çœ‹åˆ° 610kb çš„åŒ…å¯¹åº”çš„chunk vendors.pages/index ï¼Œå¹¶ä¸åœ¨entrypointå†…ï¼Œé»˜è®¤æƒ…å†µä¸‹Nuxt.js è·¯ç”±é¡µé¢å·²ç»è¢«åˆ†é…ä¸ºdynamic importï¼ŒåŒæ—¶styleæ˜¯é€šè¿‡jsè®¾ç½®åˆ°styleä¸Šçš„ï¼Œè€Œä¸æ˜¯å•ç‹¬æ‰“åŒ…å‡ºæ¥ã€‚ç»è¿‡æµ‹è¯•ï¼Œcsså•ç‹¬æ‰“åŒ…åï¼ŒUIç»„ä»¶ä»æ˜¯å•ç‹¬åˆ†åŒ…ï¼Œå³ä¾¿æ˜¯å•ç‹¬æ‰“åŒ…å‡ºæ¥ï¼Œä¾ç„¶ä¼šæœ‰æŒ‰éœ€åŠ è½½çš„é—®é¢˜ï¼Œé¦–å±ä»ä¼šé—ªçƒã€‚

build result
å› æ­¤ï¼Œå¦‚æœç»„ä»¶è¢«å¤§å¤šæ•°é¡µé¢ä½¿ç”¨ï¼Œæ¨èåœ¨ pluginå†…æ³¨å†Œï¼Œæˆ–è€…é€šè¿‡ nuxt.config.jsçš„cssç›¸å…³æ–‡ä»¶ç›´æ¥å¼•å…¥å¯¹åº”çš„ç»„ä»¶æ ·å¼ï¼ŒåŒæ—¶å…³é—­babel-import-plugin çš„ styleé€‰é¡¹ã€‚ (åæ§½ä¸€å¥ï¼ŒiViewåªèƒ½å¼•å…¥å•ä¸€å…¨å±€æ ·å¼ï¼Œä¸èƒ½æŒ‰éœ€åŠ è½½æ ·å¼ï¼Œ1.5mçš„å¤§å°éå¸¸ææ€–)
é™¤æ­¤ä»¥å¤–ï¼Œå¯ä»¥è€ƒè™‘é…ç½®webpackçš„splitchunksé…ç½®ï¼Œå®ç°è‡ªå·±çš„éœ€æ±‚ã€‚
3. è§£å†³antd-icon è¿‡å¤§ï¼ˆä¼ ç»Ÿè‰ºèƒ½
å‰é¢ç”Ÿäº§ç¯å¢ƒçš„åŒ…å¯ä»¥å‘ç°ï¼Œåªä½¿ç”¨äº†ä¸€ä¸ªButtonï¼Œå´æ‰“åŒ…äº†600kbçš„ä¾èµ–ï¼Œæ£€æŸ¥åå‘ç°æ˜¯å¼•å…¥äº†@ant-design/icon åŒ…ã€‚
å‚è€ƒï¼š https://github.com/HeskeyBaozi/reduce-antd-icons-bundle-demo
{ // nuxt.config.js  
    build: 
    {   
        extend(config, ctx) {
            config.resolve.alias[&#39;@ant-design/icons/lib/dist$&#39;] = path.resolve(__dirname, &#39;./assets/icon/antd-icon.js&#39;) // å¼•å…¥éœ€è¦çš„  
        }  
    } 
}

é¢˜å¤–è¯
â€œæŒ‰éœ€å¼•å…¥â€

image.png
https://github.com/ant-design/babel-plugin-import/issues/347
reference
https://github.com/vueComponent/ant-design-vue/issues/234
https://www.zhihu.com/question/265227812

                                        </div>
                                        
                                            <a class="btn btn-text" href="https://dzkjz.github.io/post/cai-keng-ji-lu-nuxtjs-and-ant-design-vue-pei-zhi/">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://dzkjz.github.io/post/zong-jie-nuxt-laravel-nginx-mysql-docker-ubuntu-bu-shu-de-liu-cheng/">
                        æ€»ç»“nuxt laravel nginx mysql docker ubuntuéƒ¨ç½²çš„æµç¨‹
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2020-07-19</time>
                    
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                        <div class="post-content-content">
                                            ä¸€ã€Docker
ä»€ä¹ˆæ˜¯dockerå¯ä»¥å‚è€ƒ:ä»€ä¹ˆæ˜¯ Docker
åœ¨è¿›è¡Œä¸‹é¢çš„æ“ä½œä¹‹å‰ï¼Œè¯·å…ˆå®‰è£…Docker 
é’ˆå¯¹è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯ï¼š

ä¸€ä¸ªå®¹å™¨è¿è¡Œnginx
ä¸€ä¸ªå®¹å™¨è¿è¡Œphp-fpm
ä¸€ä¸ªå®¹å™¨è¿è¡Œmysql
ä¸€ä¸ªå®¹å™¨è¿è¡Œnode

å››ä¸ªå®¹å™¨ï¼š


nginxå’Œmysqlå®¹å™¨å¯ä»¥ç›´æ¥ç”¨å®˜æ–¹çš„é•œåƒã€‚æ‰€ä»¥è¿™ä¸¤ä¸ªå®¹å™¨ä¸éœ€è¦Dockerfileï¼›


php-fpmå®¹å™¨ ä¸»è¦æ˜¯è¿è¡Œ laravelï¼›


å¦å¤–éœ€è¦ä¸€ä¸ªä¸´æ—¶å®¹å™¨ç»™å®‰è£…composerï¼Œå®‰è£…å®Œæˆååˆ é™¤è¿™ä¸ªä¸´æ—¶å®¹å™¨å°±è¡Œï¼›


nodeå®¹å™¨ç”¨äºè¿è¡Œnuxtã€‚


php-fpmå®¹å™¨æˆ‘ä»¬éœ€è¦å®‰è£…ä¸€äº›æ‰©å±•åŒ…ï¼Œæ‰§è¡Œcomposerå®‰è£…ï¼Œæ‰€ä»¥ç”¨Dockerfileé…ç½®ï¼š
æ›´å¤šDockerfileé…ç½®çš„æŒ‡ä»¤ä»‹ç»å‚è€ƒï¼šä½¿ç”¨ Dockerfile å®šåˆ¶é•œåƒ
è¯·æ³¨æ„æ•™ç¨‹ä¸­çš„

æ­¤å¤–ï¼Œè¿˜å¯ä»¥çœ‹åˆ°è¿™ä¸€ç»„å‘½ä»¤çš„æœ€åæ·»åŠ äº†æ¸…ç†å·¥ä½œçš„å‘½ä»¤ï¼Œåˆ é™¤äº†ä¸ºäº†ç¼–è¯‘æ„å»ºæ‰€éœ€è¦çš„è½¯ä»¶ï¼Œæ¸…ç†äº†æ‰€æœ‰ä¸‹è½½ã€å±•å¼€çš„æ–‡ä»¶ï¼Œå¹¶ä¸”è¿˜æ¸…ç†äº† apt ç¼“å­˜æ–‡ä»¶ã€‚è¿™æ˜¯å¾ˆé‡è¦çš„ä¸€æ­¥ï¼Œæˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼Œé•œåƒæ˜¯å¤šå±‚å­˜å‚¨ï¼Œæ¯ä¸€å±‚çš„ä¸œè¥¿å¹¶ä¸ä¼šåœ¨ä¸‹ä¸€å±‚è¢«åˆ é™¤ï¼Œä¼šä¸€ç›´è·Ÿéšç€é•œåƒã€‚å› æ­¤é•œåƒæ„å»ºæ—¶ï¼Œä¸€å®šè¦ç¡®ä¿æ¯ä¸€å±‚åªæ·»åŠ çœŸæ­£éœ€è¦æ·»åŠ çš„ä¸œè¥¿ï¼Œä»»ä½•æ— å…³çš„ä¸œè¥¿éƒ½åº”è¯¥æ¸…ç†æ‰ã€‚
å¾ˆå¤šäººåˆå­¦ Docker åˆ¶ä½œå‡ºäº†å¾ˆè‡ƒè‚¿çš„é•œåƒçš„åŸå› ä¹‹ä¸€ï¼Œå°±æ˜¯å¿˜è®°äº†æ¯ä¸€å±‚æ„å»ºçš„æœ€åä¸€å®šè¦æ¸…ç†æ‰æ— å…³æ–‡ä»¶ã€‚

ä»¥åŠå¯¹è·¯å¾„ä¸Šä¸‹æ–‡çš„è§£é‡Š

é•œåƒæ„å»ºä¸Šä¸‹æ–‡ï¼ˆContextï¼‰
è¿™ä¸ªä¹Ÿæ˜¯å¾ˆå¥‡è‘©çš„ï¼Œåˆå­¦çš„æ—¶å€™ï¼Œæ˜¯å•çº¯çš„è®¤ä¸º ä¸‹é¢è¿™ä¸ªå‘½ä»¤
COPY ./somefiles /var/www
å°±æ˜¯å¤åˆ¶Dockerfileæ‰€åœ¨çš„æ–‡ä»¶å¤¹ä¸‹somefilesæ–‡ä»¶å¤¹åŠå…¶å†…éƒ¨æ–‡ä»¶åˆ° æ­¤é•œåƒæ„å»ºçš„å®¹å™¨å†…çš„ /var/wwwç›®å½•é‡Œã€‚
ä½†æ˜¯è¿™ä¹ˆç†è§£ä¼šå‡ºé—®é¢˜ï¼Œé¦–å…ˆï¼Œå¯ä»¥ç”¨~/sub/fab/docker/somotherfiles/ è¿™ä¹ˆæŒ‡å®šå®¿ä¸»æœºæ–‡ä»¶å¤¹è·¯å¾„å—ï¼Ÿ
ç­”æ¡ˆæ˜¯ä¸è¡Œçš„ã€‚ä¼šæŠ¥é”™æ‰¾ä¸åˆ°ã€‚
ç„¶åï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ ../this/somefiles/æŒ‡å®šå®¿ä¸»æœºæ–‡ä»¶å¤¹è·¯å¾„å—ï¼Ÿ
ç­”æ¡ˆä¹Ÿæ˜¯ä¸è¡Œçš„ï¼Œä¹Ÿæ˜¯æŠ¥é”™æ‰¾ä¸åˆ°ã€‚
å…·ä½“æ¶‰åŠåˆ°çš„æ˜¯ Docker å¼•æ“ï¼Œå…·ä½“çœ‹æ•™ç¨‹è§£é‡Šï¼Œä¸è¿‡å¯ä»¥ç®€å•çš„è¿™ä¹ˆè¯´ï¼Œå°±æ˜¯æ„å»ºçš„æ—¶å€™ï¼Œåªæ‰“åŒ…dockerfileæ–‡ä»¶è·¯å¾„ä¸‹çš„æ‰€æœ‰å†…å®¹ä¼ åˆ°dockerå¼•æ“ï¼Œæ‰€ä»¥æ˜¯ä¸åŒ…å«å¤–éƒ¨çš„ä»¥åŠå¯ä»¥ç”¨~æŒ‡å®šçš„è·¯å¾„ä¸‹çš„ã€‚åŒæ—¶ä¹Ÿè¦æ³¨æ„ï¼Œè¿™ä¸ªdockerfileæ–‡ä»¶æ‰“åŒ…çš„æ‰€æœ‰å†…å®¹å¦‚æœä½ ç»™çš„æ–‡ä»¶å¤ªå¤§äº†ï¼Œé‚£ä¼ è¾“èµ·æ¥å°±ç‰›äº†ï¼Œæœ‰çš„å‡ åä¸ªGB ä¼ è¾“å¾ˆå¤´ç–¼çš„ï¼Œæ‰€ä»¥éœ€è¦æ³¨æ„ï¼Œdockerfileæ‰€åœ¨æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶å†…å®¹ï¼Œåªç•™ä¸‹éœ€è¦çš„ã€‚
è¿˜æœ‰ä¸Šé¢æ˜¯ç¬¼ç»Ÿçš„è¯´æˆæ˜¯dockerfileæ–‡ä»¶æ‰€åœ¨æ–‡ä»¶å¤¹ï¼Œå…¶å®ä¹Ÿæ˜¯ä¸å®Œå…¨æ­£ç¡®çš„ã€‚
å› ä¸ºå¯ä»¥ -f ../Dockerfilev3 è¿™ä¹ˆæŒ‡å®šéœ€è¦çš„Dockerfile é¦–å…ˆè·¯å¾„åœ¨å¤–é¢ï¼Œç„¶ååå­—ä¹Ÿä¸åŒï¼Œä¸è¿‡ä¸€èˆ¬æƒ…å†µä¸è¿™ä¹ˆå¹²ã€‚é»˜è®¤çŠ¶æ€ä¸‹å‰é¢è¯´çš„ä¸ä¸¥è°¨ä½†ä¹Ÿå¯ä»¥æ˜¯å¯¹çš„ã€‚è¿˜æœ‰å…¶å®ƒ docker build çš„ç”¨æ³•ã€‚

app å®¹å™¨ Dockerfile
FROM php:7.2.19-fpm #æŒ‡å®š åŸºç¡€é•œåƒ

# Arguments defined in docker-compose.yml
ARG user #å®šä¹‰å‚æ•°
ARG uid  #å®šä¹‰å‚æ•°

# Install system dependencies å®‰è£…ç³»ç»Ÿä¾èµ– #RUN æŒ‡ä»¤æ˜¯ç”¨æ¥æ‰§è¡Œå‘½ä»¤è¡Œå‘½ä»¤çš„
# Dockerfile æ”¯æŒ Shell ç±»çš„è¡Œå°¾æ·»åŠ  \ çš„å‘½ä»¤æ¢è¡Œæ–¹å¼ï¼Œä»¥åŠè¡Œé¦– # è¿›è¡Œæ³¨é‡Šçš„æ ¼å¼
RUN apt-get update &amp;amp;&amp;amp; apt-get install -y \
    git \
    curl \
    libpng-dev \
    libonig-dev \
    libxml2-dev \
    zip \
    unzip


# Clear cache æ¸…ç†cache
RUN apt-get clean &amp;amp;&amp;amp; rm -rf /var/lib/apt/lists/* #ä½¿ç”¨ &amp;amp;&amp;amp; å°†å„ä¸ªæ‰€éœ€å‘½ä»¤ä¸²è”èµ·æ¥

# Install PHP extensions å®‰è£…æ‰©å±•
RUN docker-php-ext-install pdo_mysql mbstring exif pcntl bcmath gd

# Get latest Composer è¿™é‡Œæ˜¯æŠŠcomposerç»™å¤åˆ¶åˆ° æœ¬Dockerfileå®šä¹‰çš„å®¹å™¨çš„ /usr/bin/composeré‡Œ
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Create system user to run Composer and Artisan Commands
# åˆ›å»ºç³»ç»Ÿç”¨æˆ·ç”¨äºæ‰§è¡Œ composerå’Œ artisan å‘½ä»¤ å®é™…æ˜¯ç»™æƒé™ã€‚
RUN useradd -G www-data,root -u $uid -d /home/$user $user
RUN mkdir -p /home/$user/.composer &amp;amp;&amp;amp; \
    chown -R $user:$user /home/$user

# Set working directory æœ¬å®¹å™¨çš„å·¥ä½œæ–‡ä»¶å¤¹
WORKDIR /var/www

USER $user #è®¾ç½®å®¹å™¨çš„ç”¨æˆ·



éœ€è¦äº†è§£æ›´å¤šæŒ‡ä»¤å¯ä»¥å‚è€ƒï¼š
COPY å¤åˆ¶æ–‡ä»¶
ADD æ›´é«˜çº§çš„å¤åˆ¶æ–‡ä»¶
[Dockerfile æœ€ä½³å®è·µæ–‡æ¡£](Dockerfile æœ€ä½³å®è·µæ–‡æ¡£)
CMD å®¹å™¨å¯åŠ¨å‘½ä»¤
ENTRYPOINT å…¥å£ç‚¹
ENV è®¾ç½®ç¯å¢ƒå˜é‡
ARG æ„å»ºå‚æ•°
VOLUME å®šä¹‰åŒ¿åå· ä¸Šé¢çš„dockerfileæ²¡æœ‰æŒ‚è½½æ•°æ®å·åˆ°å®¹å™¨å†…ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨docker-composeé‡ŒæŒ‚è½½äº†ï¼Œåé¢è®²ã€‚
EXPOSE æš´éœ²ç«¯å£ EXPOSE æŒ‡ä»¤æ˜¯å£°æ˜è¿è¡Œæ—¶å®¹å™¨æä¾›æœåŠ¡ç«¯å£ï¼Œè¿™åªæ˜¯ä¸€ä¸ªå£°æ˜ï¼Œåœ¨è¿è¡Œæ—¶å¹¶ä¸ä¼šå› ä¸ºè¿™ä¸ªå£°æ˜åº”ç”¨å°±ä¼šå¼€å¯è¿™ä¸ªç«¯å£çš„æœåŠ¡ï¼Œ æ˜ç¡® -Péšæœºæ˜ å°„ç«¯å£æ—¶ä¼šæ˜ å°„åˆ°EXPOSEçš„ç«¯å£ï¼Œ-pæŒ‡å®šæ—¶ï¼Œæ˜¯æŒ‰-pæŒ‡å®šçš„æ¥ã€‚
WORKDIR æŒ‡å®šå·¥ä½œç›®å½•
è¯·æ³¨æ„Dockerfile æ„å»ºåˆ†å±‚å­˜å‚¨çš„æ¦‚å¿µã€‚
æ¯ä¸€ä¸ª RUN éƒ½æ˜¯å¯åŠ¨ä¸€ä¸ªå®¹å™¨ã€æ‰§è¡Œå‘½ä»¤ã€ç„¶åæäº¤å­˜å‚¨å±‚æ–‡ä»¶å˜æ›´ã€‚

RUN cd /app
RUN echo &amp;quot;hello&amp;quot; &amp;gt; world.txt

å¦‚æœå°†è¿™ä¸ª Dockerfile è¿›è¡Œæ„å»ºé•œåƒè¿è¡Œåï¼Œä¼šå‘ç°æ‰¾ä¸åˆ° /app/world.txt æ–‡ä»¶ï¼Œæˆ–è€…å…¶å†…å®¹ä¸æ˜¯ hello
ç¬¬ä¸€å±‚ RUN cd /app çš„æ‰§è¡Œä»…ä»…æ˜¯å½“å‰è¿›ç¨‹çš„å·¥ä½œç›®å½•å˜æ›´ï¼Œä¸€ä¸ªå†…å­˜ä¸Šçš„å˜åŒ–è€Œå·²ï¼Œå…¶ç»“æœä¸ä¼šé€ æˆä»»ä½•æ–‡ä»¶å˜æ›´ã€‚è€Œåˆ°ç¬¬äºŒå±‚çš„æ—¶å€™ï¼Œå¯åŠ¨çš„æ˜¯ä¸€ä¸ªå…¨æ–°çš„å®¹å™¨ï¼Œè·Ÿç¬¬ä¸€å±‚çš„å®¹å™¨æ›´å®Œå…¨æ²¡å…³ç³»ï¼Œè‡ªç„¶ä¸å¯èƒ½ç»§æ‰¿å‰ä¸€å±‚æ„å»ºè¿‡ç¨‹ä¸­çš„å†…å­˜å˜åŒ–ã€‚

å› æ­¤å¦‚æœéœ€è¦æ”¹å˜ä»¥åå„å±‚çš„å·¥ä½œç›®å½•çš„ä½ç½®ï¼Œé‚£ä¹ˆåº”è¯¥ä½¿ç”¨ WORKDIR æŒ‡ä»¤ã€‚
USER æŒ‡å®šå½“å‰ç”¨æˆ·

USER æŒ‡ä»¤å’Œ WORKDIR ç›¸ä¼¼ï¼Œéƒ½æ˜¯æ”¹å˜ç¯å¢ƒçŠ¶æ€å¹¶å½±å“ä»¥åçš„å±‚ã€‚WORKDIR æ˜¯æ”¹å˜å·¥ä½œç›®å½•ï¼ŒUSER åˆ™æ˜¯æ”¹å˜ä¹‹åå±‚çš„æ‰§è¡Œ RUN, CMD ä»¥åŠ ENTRYPOINT è¿™ç±»å‘½ä»¤çš„èº«ä»½ã€‚
USER åªæ˜¯å¸®åŠ©ä½ åˆ‡æ¢åˆ°æŒ‡å®šç”¨æˆ·è€Œå·²ï¼Œè¿™ä¸ªç”¨æˆ·å¿…é¡»æ˜¯äº‹å…ˆå»ºç«‹å¥½çš„ï¼Œå¦åˆ™æ— æ³•åˆ‡æ¢ã€‚

HEALTHCHECK å¥åº·æ£€æŸ¥
ONBUILD ä¸ºä»–äººä½œå«è¡£è£³

ONBUILD æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æŒ‡ä»¤ï¼Œå®ƒåé¢è·Ÿçš„æ˜¯å…¶å®ƒæŒ‡ä»¤ï¼Œæ¯”å¦‚ RUN, COPY ç­‰ï¼Œè€Œè¿™äº›æŒ‡ä»¤ï¼Œåœ¨å½“å‰é•œåƒæ„å»ºæ—¶å¹¶ä¸ä¼šè¢«æ‰§è¡Œã€‚åªæœ‰å½“ä»¥å½“å‰é•œåƒä¸ºåŸºç¡€é•œåƒï¼Œå»æ„å»ºä¸‹ä¸€çº§é•œåƒçš„æ—¶å€™æ‰ä¼šè¢«æ‰§è¡Œã€‚

å‚è€ƒæ–‡æ¡£

laravelè¿è¡Œçš„php-fpmå®¹å™¨Dockerfileé…ç½®å¥½ä¹‹åï¼Œæ¥ä¸‹æ¥æ˜¯é…ç½®å‰ç«¯nuxtéœ€è¦çš„nodeå®¹å™¨ã€‚
nodeå®¹å™¨Dockerfile
#ä½¿ç”¨node:12-alpine ä½œä¸ºåŸºç¡€è¿›è¡Œæ„å»º
FROM node:12-alpine

#åˆ›å»º/app ç›®å½•ä½œä¸ºéƒ¨ç½²ç›®å½•,åˆ›å»ºå®¹å™¨å®ä¾‹æ—¶,æŒ‚è½½æ­¤ç›®å½•
RUN mkdir -p /app

#ç§»åŠ¨å·¥ä½œç›®å½•åˆ° /app
WORKDIR /app

#å®‰è£… bash å’Œ busybox
RUN apk update \
        &amp;amp;&amp;amp; apk upgrade \
        &amp;amp;&amp;amp; apk add --no-cache bash \
        bash-doc \
        bash-completion \
        &amp;amp;&amp;amp; /bin/bash \
        &amp;amp;&amp;amp; apk add --no-cache busybox \
        &amp;amp;&amp;amp; rm -rf /var/cache/apk/*

#å®‰è£… git
RUN apk add git
		
#è®¾ç½®nodeç¯å¢ƒå˜é‡ä¸ºproduction
ENV NODE_ENV=production

# copy the app, note .dockerignore
COPY ./pets-client /app
RUN npm install

# build necessary, even if no static files are needed,
# since it builds the server as well
RUN npm run build
RUN npm cache clean --force

# set app serving to permissive / assigned
#ENV NUXT_HOST=0.0.0.0 å·²ç»åœ¨nuxt.config.jsä¸­è®¾ç½®äº†server block
# set app port
#ENV NUXT_PORT=5000 å·²ç»åœ¨nuxt.config.jsä¸­è®¾ç½®äº†server block

#è®¾ç½®å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œçš„å‘½ä»¤
#ENTRYPOINT [ &amp;quot;npm&amp;quot;,&amp;quot;start&amp;quot; ]
CMD [&amp;quot;npm&amp;quot;,&amp;quot;start&amp;quot;]

Dockerfileéƒ¨åˆ†åˆ°æ­¤å°±ç»“æŸäº†ï¼Œæ¥ä¸‹æ¥ï¼Œéœ€è¦äº†è§£Docker-Compose
äºŒã€Docker-Compose
Docker-Compose æ˜¯ç”¨æ¥ç®¡ç†ä½ çš„å®¹å™¨çš„ï¼Œæœ‰ç‚¹åƒä¸€ä¸ªå®¹å™¨çš„ç®¡å®¶ï¼Œæƒ³è±¡ä¸€ä¸‹å½“ä½ çš„Dockerä¸­æœ‰æˆç™¾ä¸Šåƒçš„å®¹å™¨éœ€è¦å¯åŠ¨ï¼Œå¦‚æœä¸€ä¸ªä¸€ä¸ªçš„å¯åŠ¨é‚£å¾—å¤šè´¹æ—¶é—´ã€‚æœ‰äº†Docker-Composeä½ åªéœ€è¦ç¼–å†™ä¸€ä¸ªæ–‡ä»¶ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢å£°æ˜å¥½è¦å¯åŠ¨çš„å®¹å™¨ï¼Œé…ç½®ä¸€äº›å‚æ•°ï¼Œæ‰§è¡Œä¸€ä¸‹è¿™ä¸ªæ–‡ä»¶ï¼ŒDockerå°±ä¼šæŒ‰ç…§ä½ å£°æ˜çš„é…ç½®å»æŠŠæ‰€æœ‰çš„å®¹å™¨å¯åŠ¨èµ·æ¥ï¼Œåªéœ€docker-compose upå³å¯å¯åŠ¨æ‰€æœ‰çš„å®¹å™¨ï¼Œä½†æ˜¯Docker-Composeåªèƒ½ç®¡ç†å½“å‰ä¸»æœºä¸Šçš„Dockerï¼Œä¹Ÿå°±æ˜¯è¯´ä¸èƒ½å»å¯åŠ¨å…¶ä»–ä¸»æœºä¸Šçš„Dockerå®¹å™¨ã€‚
è¡¥å……

Docker Swarm
Docker Swarm æ˜¯ä¸€æ¬¾ç”¨æ¥ç®¡ç†å¤šä¸»æœºä¸Šçš„Dockerå®¹å™¨çš„å·¥å…·ï¼Œå¯ä»¥è´Ÿè´£å¸®ä½ å¯åŠ¨å®¹å™¨ï¼Œç›‘æ§å®¹å™¨çŠ¶æ€ï¼Œå¦‚æœå®¹å™¨çš„çŠ¶æ€ä¸æ­£å¸¸å®ƒä¼šå¸®ä½ é‡æ–°å¸®ä½ å¯åŠ¨ä¸€ä¸ªæ–°çš„å®¹å™¨ï¼Œæ¥æä¾›æœåŠ¡ï¼ŒåŒæ—¶ä¹Ÿæä¾›æœåŠ¡ä¹‹é—´çš„è´Ÿè½½å‡è¡¡ï¼Œè€Œè¿™äº›ä¸œè¥¿Docker-Compose æ˜¯åšä¸åˆ°çš„
Kubernetes
Kuberneteså®ƒæœ¬èº«çš„è§’è‰²å®šä½æ˜¯å’ŒDocker Swarm æ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä»–ä»¬è´Ÿè´£çš„å·¥ä½œåœ¨å®¹å™¨é¢†åŸŸæ¥è¯´æ˜¯ç›¸åŒçš„éƒ¨åˆ†ï¼Œéƒ½æ˜¯ä¸€ä¸ªè·¨ä¸»æœºçš„å®¹å™¨ç®¡ç†å¹³å°ï¼Œå½“ç„¶ä¹Ÿæœ‰è‡ªå·±ä¸€äº›ä¸ä¸€æ ·çš„ç‰¹ç‚¹ï¼Œk8sæ˜¯è°·æ­Œå…¬å¸æ ¹æ®è‡ªèº«çš„å¤šå¹´çš„è¿ç»´ç»éªŒç ”å‘çš„ä¸€æ¬¾å®¹å™¨ç®¡ç†å¹³å°ã€‚è€ŒDocker Swarmåˆ™æ˜¯ç”±Docker å…¬å¸ç ”å‘çš„ã€‚ç°åœ¨å¸¸ç”¨Kubernetes

å®ƒå…è®¸ç”¨æˆ·é€šè¿‡ä¸€ä¸ªå•ç‹¬çš„ docker-compose.yml æ¨¡æ¿æ–‡ä»¶ï¼ˆYAML æ ¼å¼ï¼‰æ¥å®šä¹‰ä¸€ç»„ç›¸å…³è”çš„åº”ç”¨å®¹å™¨ä¸ºä¸€ä¸ªé¡¹ç›®ï¼ˆprojectï¼‰ã€‚
Compose ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼š

æœåŠ¡ (service)ï¼šä¸€ä¸ªåº”ç”¨çš„å®¹å™¨ï¼Œå®é™…ä¸Šå¯ä»¥åŒ…æ‹¬è‹¥å¹²è¿è¡Œç›¸åŒé•œåƒçš„å®¹å™¨å®ä¾‹ã€‚
é¡¹ç›® (project)ï¼šç”±ä¸€ç»„å…³è”çš„åº”ç”¨å®¹å™¨ç»„æˆçš„ä¸€ä¸ªå®Œæ•´ä¸šåŠ¡å•å…ƒï¼Œåœ¨ docker-compose.yml æ–‡ä»¶ä¸­å®šä¹‰ã€‚

Compose çš„é»˜è®¤ç®¡ç†å¯¹è±¡æ˜¯é¡¹ç›®ï¼Œé€šè¿‡å­å‘½ä»¤å¯¹é¡¹ç›®ä¸­çš„ä¸€ç»„å®¹å™¨è¿›è¡Œä¾¿æ·åœ°ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚
æœ¬èŠ‚çš„å®‰è£…é“¾æ¥å·²ç»æœ‰å®‰è£…æ•™ç¨‹ï¼Œå®‰è£…æ­¤å¤„ç•¥
ç»™å‡ºæœ¬æ¬¡é¡¹ç›®çš„å®Œæˆç‰ˆæœ¬docker-compose.prod.yml
å®Œæˆç‰ˆæœ¬docker-compose.prod.yml
version: &amp;quot;3.7&amp;quot;
services:
  app:
    build:
      args:
        user: petapi
        uid: 1000
      context: ./
      dockerfile: Dockerfile
    image: petapii
    container_name: petapi-app
    restart: unless-stopped
    working_dir: /var/www/
    volumes:
      - ./:/var/www
    networks:
      - petapin
  frontapp:
    build:
      context: ~/petclient/dockerfiles/node/
      dockerfile:  Dockerfile
    image: frontapp
    container_name: petclient-frontapp
    restart: unless-stopped
    working_dir: /app
    networks:
      - petclientn
  db:
    image: mysql:5.7
    container_name: petapi-db
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_USER: ${DB_USERNAME}
      SERVICE_TAGS: dev
      SERVICE_NAME: mysql
    volumes:
      - ./docker-compose/mysql:/docker-entrypoint-initdb.d
    networks:
      - petapin
  nginx:
    image: nginx:1.19.1-alpine
    container_name: pet-nginx
    restart: always
    depends_on:
      - app
      - frontapp
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./:/var/www
      - ./docker-compose/nginx:/etc/nginx/conf.d
      - ./docker-compose/nginx/certs:/etc/nginx/certs
    networks:
      - petapin
      - petclientn
networks:
  petapin:
    driver: bridge
  petclientn:
    driver: bridge

æ¥ä¸‹æ¥ç»†åˆ†æ‹†è§£ï¼›
appéƒ¨åˆ†ï¼š
app:
    build:
      args:
        user: petapi
        uid: 1000
      context: ./
      dockerfile: Dockerfile
    image: petapii
    container_name: petapi-app
    restart: unless-stopped
    working_dir: /var/www/
    volumes:
      - ./:/var/www
    networks:
      - petapin

è¿™æ˜¯å®šä¹‰çš„ç¬¬ä¸€ä¸ªæœåŠ¡ï¼Œ
appã€phpã€‘çš„Dockerfileé‡Œï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªå‚æ•° user å’Œ uid ï¼Œè¿™é‡Œè¿›è¡Œäº†èµ‹å€¼ã€‚
å› ä¸ºä½¿ç”¨buildæŒ‡ä»¤ï¼Œæ‰€ä»¥å¿…é¡»ç»™åˆ°context å’Œ Dockerfileï¼Œè¿™ä¸ªcontextå³å·²ç»åœ¨ å‰é¢æåˆ°è¿‡çš„é•œåƒæ„å»ºä¸Šä¸‹æ–‡ã€‚
buildå¯ä»¥ä¸ç»™context ç›´æ¥ç»™è·¯å¾„å¦‚ï¼šbuild: ./dir éœ€è¦æ³¨æ„çš„æ ¼å¼æ˜¯ build:[ç©ºæ ¼]./dir ç©ºæ ¼ä¸èƒ½å°‘
image æ˜¯ç»™è¿™ä¸ªç”Ÿæˆçš„é•œåƒçš„åå­—ï¼Œå¦‚æœæ²¡æœ‰buildè€Œæ˜¯ç›´æ¥ç»™imageï¼Œdockerä¼šå»dockerhubå®˜æ–¹æœè¿™ä¸ªåŒ…ï¼Œæœåˆ°äº†å°±ç»™pullä¸‹æ¥ã€‚
app å…¶è¿è¡Œèµ·æ¥çš„å®¹å™¨åå«petapi-appï¼Œè¿™ä¸ªåå­—å¾ˆé‡è¦ï¼Œnginxçš„confé‡Œï¼Œæˆ‘ä»¬ä¼šç”¨åˆ°è¿™ä¸ªï¼š

server {
listen 80;
   listen [::]:80;
   server_name api.example.com;
   return 301 https://$http_host$request_uri;
   #rewrite ^(.*)$ https://$host$1 permanent; we just replace request to https
}
server{
listen 443 ssl;
   listen [::]:443 ssl;
   server_name api.example.com;
   #ssl on; no need this anymore please change use listen 443 ssl only
   ssl_certificate /etc/nginx/certs/cert.pem;
   ssl_certificate_key /etc/nginx/certs/key.pem;
   #ssl_session_timeout 5m;
   #ssl_protocols read blow info please;
   # By default nginx uses â€œssl_protocols TLSv1 TLSv1.1 TLSv1.2â€ and 
#â€œssl_ciphers HIGH:!aNULL:!MD5â€, so configuring them explicitly is 
#generally not needed.
   index index.php index.html;
   error_log /var/log/nginx/error.log;
   access_log /var/log/nginx/access.log;
   root /var/www/public;
   location ~ \.php$ {
           try_files $uri =404;
           fastcgi_split_path_info ^(.+\.php)(/.+)$;
           fastcgi_pass petapi-app:9000;
           fastcgi_index index.php;
           include fastcgi_params;
           fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
           fastcgi_param PATH_INFO $fastcgi_path_info;
           }
   location / {
            try_files $uri $uri/ /index.php?$query_string;
            gzip_static on;
            }
    }   


æ³¨æ„ fastcgi_pass petapi-app:9000; æˆ‘ä»¬ç”¨åˆ°äº†container_name å³è¿™ä¸ªappå®¹å™¨çš„åå­—ã€‚9000æ˜¯é»˜è®¤php-fpmçš„ç«¯å£ã€‚
å…¶æ¬¡ï¼Œæˆ‘ä»¬Dockerfileä¹‹å‰æ²¡æœ‰è®¾ç½®æ•°æ®å·ï¼Œè¿™é‡Œè®¾ç½®äº†åŠ è½½ docker-compose.prod.ymlæ‰€åœ¨æ–‡ä»¶å¤¹å…¨éƒ¨å†…å®¹ åˆ°å®¹å™¨ä¸­
restart:  æŒ‡å®šå®¹å™¨é€€å‡ºåçš„é‡å¯ç­–ç•¥ä¸ºå§‹ç»ˆé‡å¯ã€‚è¯¥å‘½ä»¤å¯¹ä¿æŒæœåŠ¡å§‹ç»ˆè¿è¡Œååˆ†æœ‰æ•ˆï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ¨èé…ç½®ä¸º always æˆ–è€… unless-stoppedã€‚
networks:  é…ç½®å®¹å™¨è¿æ¥çš„ç½‘ç»œã€‚è¿™ä¸ªç½‘ç»œä¸»è¦æ˜¯ç»™æœåŠ¡å®¹å™¨ä¹‹é—´é€šä¿¡çš„ï¼Œdbæˆ‘ä»¬ç”¨çš„mysqlé€šè¿‡è¿™ä¸ªç½‘ç»œå’Œappé€šä¿¡ï¼Œnginxä¹Ÿé€šè¿‡è¿™ä¸ªç½‘ç»œå’Œappé€šä¿¡ã€‚è¿™ä¸‰ä¸ªå…¬ç”¨çš„ petapin è¿™ä¸ªç½‘è·¯ï¼Œè¿™ä¸ªç½‘ç»œæ˜¯åœ¨ å¤–å±‚ networks:ä¸­å®šä¹‰çš„ã€‚
ä¸€èˆ¬æ¥è¯´ï¼Œdocker -compose å°±æ˜¯ï¼š
version: 
services:
networks:

è¿™ä¸‰ä¸ªã€‚networks çš„ driver å¯ä»¥å‚è€ƒ network_modeã€‚  é”™å•¦ï¼networks åº”è¯¥å‚è€ƒ Network configuration reference
å…³äºnetworkså’Œlinks è¯·çœ‹ Networking in Compose

compose é»˜è®¤ä¼šæä¾›ä¸€ä¸ªnetwork ï¼Œæ¯ä¸ªæœåŠ¡éƒ½ä¼šåŠ å…¥è¿™ä¸ªnetworkï¼Œä¸”é»˜è®¤äº’é€šï¼Œå®ƒä»¬ä¹‹é—´ä»¥ä¸€ä¸ªåŸºäºå®¹å™¨åç”Ÿæˆçš„åä½œåŒºåˆ†ã€‚
ä¸€èˆ¬æ¥è¯´ç½‘ç»œååŸºäºé¡¹ç›®åã€é¡¹ç›®åŸºäºå­˜æ”¾å…¶çš„æ–‡ä»¶å¤¹åã€‘
æ¯”å¦‚è¯´, å‡è®¾ä½ çš„appå­˜æ”¾äºä¸€ä¸ªå«myappçš„æ–‡ä»¶å¤¹é‡Œ, ä½ çš„ docker-compose.yml é…ç½®å¦‚ä¸‹:
version: &amp;quot;3&amp;quot;
services:
web:
build: .
ports:
    - &amp;quot;8000:8000&amp;quot;
db:
  image: postgres
  ports:
    - &amp;quot;8001:5432&amp;quot;

å½“ä½ æ‰§è¡Œ docker-compose up,çš„æ—¶å€™ ï¼Œä¼šæœ‰å¦‚ä¸‹æµç¨‹:

ä¸€ä¸ªåå«myapp_defaultçš„ç½‘ç»œè¢«åˆ›å»º ã€‚
ä½¿ç”¨ webé…ç½®åˆ›å»ºä¸€ä¸ªå®¹å™¨. è¯¥å®¹å™¨åŠ å…¥ myapp_default ç½‘ç»œå¹¶ä¸”èµ‹äºˆä¸€ä¸ªæ ‡è¯†å web.
ä½¿ç”¨ dbé…ç½®åˆ›å»ºä¸€ä¸ªå®¹å™¨.  è¯¥å®¹å™¨åŠ å…¥ myapp_default ç½‘ç»œå¹¶ä¸”èµ‹äºˆä¸€ä¸ªæ ‡è¯†å db.

æ¯ä¸€ä¸ªå®¹å™¨éƒ½å¯ä»¥é€šè¿‡æ ‡è¯†åweb,dbæŸ¥è¯¢åˆ°è¿™ä¸¤å®¹å™¨ï¼Œå¹¶è·å¾—è¿™ä¸¤å®¹å™¨çš„ipåœ°å€ï¼Œæ¯”å¦‚ï¼Œwebå®¹å™¨é‡Œçš„ç¨‹åºä»£ç å¯ä»¥é€šè¿‡postgres:5342é“¾æ¥åˆ°dbå®¹å™¨ï¼Œå°±å¯ä»¥ä½¿ç”¨postgresæ•°æ®åº“å•¦ã€‚
It is important to note the distinction between HOST_PORT and CONTAINER_PORT. In the above example, for db, the HOST_PORT is 8001 and the container port is 5432 (postgres default). Networked service-to-service communication use the CONTAINER_PORT. When HOST_PORT is defined, the service is accessible outside the swarm as well.
Within the web container, your connection string to db would look like postgres://db:5432, and from the host machine, the connection string would look like postgres://{DOCKER_IP}:8001.
Linksäº†è§£å°±è¡Œ
è¿™ä¸ªå‚è€ƒ linkså°†ä¼šåœ¨ä»Šåè¢«ç§»é™¤ï¼ŒåæœŸè¿™ä¸ªæ²¡æœ‰äº†ï¼Œç°åœ¨äº†è§£å°±è¡Œï¼Œä¸æ¨èä½¿ç”¨ã€‚
Links allow you to define extra aliases by which a service is reachable from another service. They are not required to enable services to communicate - by default, any service can reach any other service at that serviceâ€™s name. In the following example, db is reachable from web at the hostnames db and database:
version: &amp;quot;3&amp;quot;
services:

web:
  build: .
  links:
    - &amp;quot;db:database&amp;quot;
db:
  image: postgres

See the links reference for more information.
NETWORKS
æˆ‘ä»¬è¿™é‡Œç”¨çš„å°±æ˜¯è¿™ä¸ªã€‚

æ›´å¤šçš„æŒ‡ä»¤å‚è€ƒ docker compose æŒ‡ä»¤
frontappé…ç½®å‚è€ƒä¸Šé¢çš„è‡ªå·±ç†è§£ï¼Œ
dbéƒ¨åˆ†ï¼š
  db:
    image: mysql:5.7
    container_name: petapi-db
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_USER: ${DB_USERNAME}
      SERVICE_TAGS: dev
      SERVICE_NAME: mysql
    volumes:
      - ./docker-compose/mysql:/docker-entrypoint-initdb.d
    networks:
      - petapin

æ•°æ®åº“åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªå¯¼å…¥çš„æ“ä½œï¼Œå¦‚æœä»¥åç½‘ç«™ä¸»æœºè¿ç§»ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥æ‰“åŒ…å¯¼å…¥ï¼Œæ•™ç¨‹åœ¨cnblogæœ‰ã€‚
æ•°æ®åº“éƒ¨åˆ†å…¶ä½™çš„éƒ½æ²¡å•¥å¥½è¯´çš„ï¼Œä¸»è¦æ˜¯environmenté‡Œçš„é…ç½®ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä½¿ç”¨çš„æ˜¯
environment:
  RACK_ENV: development
  SHOW: &#39;true&#39;
  SESSION_SECRET:
environment:
  - RACK_ENV=development
  - SHOW=true
  - SESSION_SECRET

è¿™ç§èµ‹å€¼æ ¼å¼ã€‚
ä½†æ˜¯${...} æ€ä¹ˆç†è§£ï¼Ÿ

You can use environment variables in configuration values with a Bash-like ${VARIABLE} syntax - see variable substitution for full details.
å°±æ˜¯è¯´ï¼Œ${...}æ˜¯å¯ä»¥è¯»å–è®¾ç½®åœ¨.envæ–‡ä»¶ä¸­çš„å€¼çš„ï¼Œä½†æ˜¯å¿…é¡»åœ¨æ‰§è¡Œ docker-compose upçš„æ—¶å€™ï¼Œå¦‚æœåœ¨æ‰§è¡Œçš„æ—¶å€™å¦è¡Œèµ‹å€¼ --name=...ä¼šè¦†ç›–.envä¸­çš„å€¼ã€‚.envæ–‡ä»¶ä¸­é…ç½®çš„å€¼åªåœ¨ docker-compose upæ‰§è¡Œçš„æ—¶å€™èµ·ä½œç”¨ï¼Œdocker stack deployä¸èµ·ä½œç”¨ã€‚
å…¶ä»–ç”¨æ³•ï¼š ${VARIABLE:-default}åŠ${VARIABLE-default} åŠ${VARIABLE:?err}åŠ${VARIABLE?err}

ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸Šé¢é…ç½®dbå®¹å™¨çš„å€¼ï¼Œåœ¨docker-compose upçš„æ—¶å€™ï¼Œè¯»å–åŒç›®å½•ä¸‹.envæ–‡ä»¶ä¸­é…ç½®çš„å€¼ã€‚
nginxéƒ¨åˆ†
nginx:
    image: nginx:1.19.1-alpine
    container_name: pet-nginx
    restart: always
    depends_on:
      - app
      - frontapp
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./:/var/www
      - ./docker-compose/nginx:/etc/nginx/conf.d
      - ./docker-compose/nginx/certs:/etc/nginx/certs
    networks:
      - petapin
      - petclientn

nginxé…ç½®ä¸­æˆ‘ä»¬ä½¿ç”¨äº†ä¸¤ä¸ªconfï¼Œpetapi.confåŠ petclient.confå­˜æ”¾äº ./docker-compose/nginxç›®å½•ä¸‹ã€‚é€šè¿‡volumesé…ç½®ï¼ŒåŠ è½½åˆ°äº†nginxå®¹å™¨å†…çš„/etc/nginx/conf.dæ–‡ä»¶å¤¹ä¸­ã€‚
ç„¶åæ˜¯sslçš„key.pemå’Œcert.pemæ–‡ä»¶å­˜æ”¾åœ¨./docker-compose/nginx/certsæ–‡ä»¶å¤¹ä¸‹ã€‚é€šè¿‡volumesé…ç½®ï¼ŒåŠ è½½åˆ°äº†nginxå®¹å™¨å†…çš„/etc/nginx/certsæ–‡ä»¶å¤¹å†…ã€‚
ä¸ºä»€ä¹ˆé…ç½® ./åŠ è½½åˆ°/var/wwwæ–‡ä»¶å¤¹ä¸­å‘¢ï¼Ÿ
æˆ‘ä»¬çœ‹çœ‹petapi.conf:
server {
   listen 80;
        ç•¥...
     }
server{
   listen 443 ssl;
        listen [::]:443 ssl;
        server_name api.example.com;
        ssl_certificate /etc/nginx/certs/cert.pem;
        ssl_certificate_key /etc/nginx/certs/key.pem;
        index index.php index.html;
        error_log /var/log/nginx/error.log;
        access_log /var/log/nginx/access.log;
        root /var/www/public;
        location ~ \.php$ {
                try_files $uri =404;
                fastcgi_split_path_info ^(.+\.php)(/.+)$;
                fastcgi_pass petapi-app:9000;
                fastcgi_index index.php;
                }
        location / {
                 try_files $uri $uri/ /index.php?$query_string;
                 gzip_static on;
                 }
         }

å†çœ‹ç›®å½•ç»“æ„
drwxrwxr-x 16 ***** *****     4096 Jul 18 15:05 ./
drwxrwxr-x  4 ***** *****      4096 Jul 13 07:09 ../
drwxrwxr-x 11 ***** *****      4096 Jul 12 17:00 app/
-rw-rw-r--  1 ***** *****      1686 Jul 12 17:00 artisan
drwxrwxr-x  3 ***** *****      4096 Jul 12 17:00 bootstrap/ 
-rw-rw-r--  1 ***** *****      1660 Jul 12 17:00 composer.json
-rw-rw-r--  1 ***** *****    208927 Jul 12 17:00 composer.lock
drwxrwxr-x  2 ***** *****      4096 Jul 12 17:00 config/
drwxrwxr-x  5 ***** *****      4096 Jul 12 17:00 database/
drwxrwxr-x  4 ***** *****      4096 Jul 16 06:15 docker-compose/
-rw-rw-r--  1 ***** *****      1806 Jul 18 13:06 docker-compose.prod.yml
-rw-rw-r--  1 ***** *****       741 Jul 12 17:12 Dockerfile
drwxrwxr-x  3 ***** *****      4096 Jul 15 18:07 dockerfiles/
-rw-rw-r--  1 ***** *****       220 Jul 12 17:00 .editorconfig
-rw-rw-r--  1 ***** *****       844 Jul 12 18:37 .env
-rw-rw-r--  1 ***** *****       778 Jul 12 17:00 .env.example
drwxrwxr-x  8 ***** *****      4096 Jul 12 17:00 .git/
-rw-rw-r--  1 ***** *****       111 Jul 12 17:00 .gitattributes
-rw-rw-r--  1 ***** *****       163 Jul 12 17:00 .gitignore
drwxrwxr-x  2 ***** *****      4096 Jul 12 17:00 .idea/
-rw-rw-r--  1 ***** *****      1013 Jul 12 17:00 package.json
-rw-rw-r--  1 ***** *****    462139 Jul 12 17:00 package-lock.json
-rw-rw-r--  1 ***** *****      1197 Jul 12 17:00 phpunit.xml
drwxrwxr-x  2 ***** *****      4096 Jul 13 14:46 public/
-rw-rw-r--  1 ***** *****      4497 Jul 12 17:00 README.md
drwxrwxr-x  6 ***** *****      4096 Jul 12 17:00 resources/
drwxrwxr-x  2 ***** *****      4096 Jul 12 17:00 routes/
-rw-rw-r--  1 ***** *****       563 Jul 12 17:00 server.php
drwxrwxr-x  5 ***** ********   4096 Jul 12 17:00 storage/
-rw-rw-r--  1 ***** *****       174 Jul 12 17:00 .styleci.yml
drwxrwxr-x  4 ***** *****      4096 Jul 12 17:00 tests/
drwxr-xr-x 48 ***** *****      4096 Jul 12 18:28 vendor/
-rw-rw-r--  1 ***** *****       538 Jul 12 17:00 webpack.mix.js

nginxåœ¨ api.example.com:80æˆ–443è¯·æ±‚çš„æ—¶å€™ï¼Œ80å¼ºåˆ¶è½¬443ï¼Œç„¶åçœ‹443ä¸­å¤„ç†é€»è¾‘ã€‚
å®¹å™¨ä¸­çš„root /var/www/public/å¯¹åº”çš„å°±æ˜¯å®¿ä¸»æœº publicæ–‡ä»¶å¤¹ã€‚
location / {
	try_files $uri $uri/ /index.php?$query_string;
	gzip_static on;
	}

è®¿é—®çš„æ—¶å€™ï¼Œå°è¯•çš„æ˜¯æ¯”å¦‚	http://api.exampl.com/api/pigs/all/1ä¼šè§£æå‡ºuri api/pigs/all/1ï¼Œè¿™ä¸ªuriæ–‡ä»¶åœ¨publicç›®å½•ä¸­æ˜¯æ²¡æœ‰çš„ã€‚
publicç›®å½•ï¼š
drwxrwxr-x  2 ***** ***** 4096 Jul 13 14:46 ./
drwxrwxr-x 16 ***** ***** 4096 Jul 18 15:05 ../
-rw-rw-r--  1 ***** *****    0 Jul 12 17:00 favicon.ico
-rw-rw-r--  1 ***** *****  603 Jul 12 17:00 .htaccess
-rw-rw-r--  1 ***** ***** 1823 Jul 12 17:00 index.php
-rw-rw-r--  1 ***** *****   24 Jul 12 17:00 robots.txt
lrwxrwxrwx  1 ***** *****   27 Jul 13 14:46 storage -&amp;gt; /var/www/storage/app/public
-rw-rw-r--  1 ***** ***** 1194 Jul 12 17:00 web.config

æ‰€ä»¥ç›´æ¥è·³è§£æ/index.php?$query_string; ç„¶å$query_stringå°±æ˜¯api/pigs/all/1ï¼Œç„¶åå°±æ˜¯laravelå·¥ä½œé€»è¾‘äº†ã€‚è§£æå‡ºrequestï¼Œparameters...
æ‰€ä»¥è¿™ä¸ªåŠ è½½åˆ°nginxä¸­æ˜¯å¿…è¦çš„ï¼Œå¦‚æœä¸ç”¨try_fileså‘¢ã€æ²¡è¯•è¿‡ã€‘ï¼Ÿé‚£åº”è¯¥å°±appå®¹å™¨å¼€ä¸€ä¸ªç«¯å£[æ¯”å¦‚12343]ï¼Œç„¶ånginxä½¿ç”¨proxy_pass petapi-app:å¼€çš„ç«¯å£å·[12343] ï¼Œè¿™æ ·å°±okäº†å§ã€‚
æ¥ä¸‹æ¥çœ‹çœ‹sslé…ç½®ï¼Œå‰é¢è¯´åˆ°

sslçš„key.pemå’Œcert.pemæ–‡ä»¶å­˜æ”¾åœ¨./docker-compose/nginx/certsæ–‡ä»¶å¤¹ä¸‹ã€‚é€šè¿‡volumesé…ç½®ï¼ŒåŠ è½½åˆ°äº†nginxå®¹å™¨å†…çš„/etc/nginx/certsæ–‡ä»¶å¤¹å†…ã€‚

æ‰€ä»¥ssléƒ¨åˆ†çš„é…ç½®æœ‰ï¼š
ssl_certificate /etc/nginx/certs/cert.pem;
ssl_certificate_key /etc/nginx/certs/key.pem;

åŒæ ·çš„æ¥çœ‹çœ‹
frontappéƒ¨åˆ†çš„confé…ç½®ï¼š
server {
listen 80;
listen [::]:80;
server_name example.com www.example.com;
return 301 https://$http_host$request_uri;
#rewrite ^(.*)$ https://$host$1 permanent; we just replace request to https
}
server{
listen 443 ssl;
listen [::]:443 ssl;
server_name example.com www.example.com;
#ssl on; no need this anymore please change use listen 443 ssl only
ssl_certificate /etc/nginx/certs/cert.pem;
ssl_certificate_key /etc/nginx/certs/key.pem;
#ssl_session_timeout 5m;
#ssl_protocols read blow info please;
# By default nginx uses â€œssl_protocols TLSv1 TLSv1.1 TLSv1.2â€ and 
#â€œssl_ciphers HIGH:!aNULL:!MD5â€, so configuring them explicitly is generally 
#not needed.
index index.php index.html;
error_log /var/log/nginx/error.log;
access_log /var/log/nginx/access.log;
root /var/www/public;
location ~ \.php$ {
try_files $uri =404;
fastcgi_split_path_info ^(.+\.php)(/.+)$;
fastcgi_pass frontapp:9000;
fastcgi_index index.php;
include fastcgi_params;
fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
fastcgi_param PATH_INFO $fastcgi_path_info;
}
location / {
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header Host  $http_host;
proxy_set_header X-Nginx-Proxy true;
proxy_set_header Connection &amp;quot;&amp;quot;;
proxy_pass http://frontapp:8000; #å› ä¸ºåœ¨nuxtä¸­ serveré…ç½®å°±è¿™ä¸ª
gzip_static on;
}
}

ä¸petapi.confä¸åŒçš„å°±æ˜¯
location / {
                proxy_set_header X-Real-IP $remote_addr;
				proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
				proxy_set_header Host  $http_host;
				proxy_set_header X-Nginx-Proxy true;
				proxy_set_header Connection &amp;quot;&amp;quot;;
				proxy_pass http://frontapp:8000; #å› ä¸ºåœ¨nuxtä¸­ serveré…ç½®å°±è¿™ä¸ª
                gzip_static on;
                }

proxy_passä¸€å®šæ˜¯ http://å¼€å¤´+ip+:+ç«¯å£ï¼Œ
ipç”¨äº†å®¹å™¨å‚æ•°ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºå•¥nginxå®¹å™¨çš„depends_onè®¾ç½®äº†appå’Œfrontappä¸¤ä¸ªå®¹å™¨ï¼Œå› ä¸ºè¦ç”¨å•Šã€‚
ç«¯å£è®¾ç½®ä¸º8000æ˜¯å› ä¸ºnuxtä¸­nuxt.config.jså€¼ä¸ºï¼š
  server: {
    port: 8000, // default: 3000
    host: &#39;0.0.0.0&#39;, // default: localhost,
    timing: false
    // timing: {
    //   total: true
    // }
  },

ç«¯å£ç»™è®¾ç½®äº†8000ï¼Œnodeçš„Dockerfileæˆ‘ä»¬ä¹Ÿå°±æ²¡æœ‰å¼€ç«¯å£äº†ã€‚
å¦‚æœç»™docker-compose.prod.ymlåŠ ä¸€ä¸ª
  frontapp:
    build:
      context: ~/petclient/dockerfiles/node/
      dockerfile:  Dockerfile
    image: frontapp
    container_name: petclient-frontapp
    restart: unless-stopped
    working_dir: /app
    ports:
     - 800:8000
    networks:
      - petclientn

æ³¨æ„å…¶ä¸­
    ports:
     - 800:8000

åŠ ä¸Šäº†å°±å¯ä»¥é€šè¿‡å®¿ä¸»æœºip[å½“å‰ç¯å¢ƒä¸‹å°±æ˜¯æœåŠ¡å™¨ip]:8000ç›´æ¥è®¿é—®nuxtåº”ç”¨ã€‚æˆ‘ä»¬è¿™é‡Œä¸ç”¨ï¼Œåªæ˜¯è¯´åŸç†å¦‚æ­¤ã€‚ä½†æ˜¯å¦‚æœä½ ç»™å¼€ä¸ª443ç«¯å£è®¿é—®è¿™ä¸ª8000ç«¯å£ï¼Œä¼šä¸è¡Œï¼Œä¼šæŠ¥ç«¯å£å·²ç»è¢«(å°±æ˜¯nginxå®¹å™¨)å ç”¨ã€‚
docker-compose.prod.ymlé…ç½®å®Œäº†ï¼Œç„¶åæ‰§è¡Œ docker-compose -f docker-compose.prod.yml build app frontappç»™çˆ·ç”Ÿæˆè¿™ä¸¤å®¹å™¨çš„é•œåƒå‡ºæ¥ã€‚ç”Ÿæˆå®Œäº† æ‰§è¡Œ docker-compose -f docker-compose.prod.yml up -då°±å¯ä»¥è·‘èµ·æ¥äº†ã€‚æ‰§è¡Œå‘½ä»¤åˆ‡æ¢åˆ° docker-compose.prod.ymlæ–‡ä»¶çš„ç›®å½•ä¸‹ï¼Œè¿™æ ·-fæŒ‡å®šå…å¾—ç»™ä¸€ä¸²é•¿çš„åœ°å€ã€‚
ä¸‰ã€laravelå‘å¸ƒéœ€è¦å‡†å¤‡çš„æ–‡ä»¶å’Œç”Ÿäº§ç¯å¢ƒè¦åšçš„ä¸€äº›æ“ä½œ
laravelçš„ä»£ç ï¼Œæˆ‘æ˜¯ç›´æ¥git clone ä¸‹æ¥ç„¶åè¿›åˆ°appå®¹å™¨é‡Œ
æ‰§è¡Œ
cp .env.example .env .envæ–‡ä»¶ã€‚
ç‰¹åˆ«æ³¨æ„
APP_ENV=production
APP_DEBUG=false
APP_URL

php artisan key:generate ç”Ÿæˆkey
ç„¶åè‡ªå·±é…ç½®.envæ–‡ä»¶ä¸­çš„å€¼ï¼Œmailå•Š jwtå•Š mysqlä¹‹ç±»çš„ã€‚
php artisan migrate æ•°æ®åº“
ç„¶åå°±æ˜¯è¿›å…¥dbæ•°æ®åº“å®¹å™¨ï¼Œæ£€æŸ¥ç”¨æˆ·ï¼Œè¡¨ï¼Œå¯¼å…¥æ‰“åŒ…çš„æ•°æ®åº“ã€‚
æ¥ç€å°±æ˜¯æŠŠstorageé‡Œçš„æ–‡ä»¶ç”¨rsyncç»™ä¼ åˆ°æœåŠ¡å™¨[å®¿ä¸»æœº]çš„laravelå­˜æ”¾æ–‡ä»¶å¤¹é‡Œçš„storageå¯¹åº”çš„æ–‡ä»¶å¤¹é‡Œã€‚
å†åœ¨appå®¹å™¨æ‰§è¡Œ
php artisan storage:link
ç„¶åå°±å¯ä»¥ç”¨äº†ã€‚
php artisan optimize
è‡³äºé‚®ä»¶ï¼Œéœ€è¦å¼€å¯queueï¼Œä»¥åŠsupervisorã€‚ã€æš‚ç¼ºã€‘ã€ä¸ç”¨supervisorä¹Ÿå¯ä»¥å¼€å¯queueå¹¶ç¡®ä¿ä¸service down å‚è€ƒæ›´æ–°éƒ¨åˆ† ã€‘
å››ã€nuxté‡åˆ°çš„å‘
å¦‚æœæœ‰ä»£ç ç”¨åˆ°äº†
target: (process.env.NODE_ENV === &amp;quot;production&amp;quot;) ? process.env.API_URL : &amp;quot;http://petapi.test/api&amp;quot;,
è¿™æ ·çš„ï¼Œé‚£envæ–‡ä»¶å¿…é¡»è¦æœ‰ã€‚å¦åˆ™å¿…ç„¶æŠ¥target null ç±»å‹é”™è¯¯ã€‚
è¿˜è¦å®‰è£…dotenv ,ä¸”é…ç½®å¦‚ä¸‹ï¼š
require(&#39;dotenv&#39;).config(); //https://github.com/nuxt-community/proxy-module/issues/3


export default{
    ...
    modules: [
   ...
    // Doc: https://github.com/nuxt-community/dotenv-module
    &#39;@nuxtjs/dotenv&#39;,
    ...
  ],
        ...
}


æˆ‘è¿™ä¸ªç›´æ¥ç”¨çš„ssrï¼Œç›®å‰è¿˜æ˜¯æœ‰ä¸ªé—®é¢˜å°±æ˜¯jsåŒ…å¤ªå¤§ï¼Œè¦ç²¾ç®€ä¸€ä¸‹ã€‚è™½ç„¶nuxtå¯ä»¥ç›´æ¥æsslä¸ç”¨nginxï¼Œä½†æ˜¯è¿™é‡Œ443ç«¯å£è¢«nginxå ç”¨äº†ï¼Œå¦å¤–nginxè¿˜æ˜¯æ¯”nodeè¦å¼ºã€‚node+nginxæ¨èã€‚
ä¹Ÿæ˜¯å‚è€ƒçš„ https://jonathanmh.com/deploying-a-nuxt-js-app-with-docker/
å…ˆç›´æ¥git cloneä»£ç ï¼Œç„¶åCOPYåˆ°frontappå®¹å™¨ï¼Œç„¶ånpm installï¼Œbuildï¼Œstartã€Dockerfileé‡Œæœ‰é…ç½®ã€‘ã€‚
è¿™é‡Œå…¶å®å¯ä»¥ç”¨volumeåŠ è½½åˆ°å®¹å™¨çš„ï¼Œæˆ‘æ˜¯COPYï¼Œåæ­£å‰ç«¯ä¹Ÿæ²¡å•¥å˜åŒ–ï¼Œå˜åŒ–äº†å°±åˆè¦install buildä¸€å¥—ï¼Œvolumeé—®é¢˜ä¸å¤§ã€‚
å› ä¸ºnuxtå¼€å‘çš„.gitignoreæ²¡æœ‰æ·»åŠ staticæ–‡ä»¶å¤¹ï¼Œæ‰€ä»¥git cloneçš„æ—¶å€™å°±æœ‰äº†staticæ–‡ä»¶å¤¹é‡Œçš„æ–‡ä»¶ï¼Œå°±ä¸rsyncä¸Šä¼ äº†ã€‚
è®°å¾—nano .envæ·»åŠ  .envæ–‡ä»¶å¹¶é…ç½®éœ€è¦çš„å€¼ã€‚
æˆ‘é…ç½®çš„å°±æœ‰ï¼š
API_URL=&amp;quot;https://api.example.com/api&amp;quot;
NODE_ENV=&amp;quot;production&amp;quot;
AUTH_URL=&amp;quot;https://api.example.com/api/auth&amp;quot;

äº”ã€mysql
æ‰§è¡Œdocker cp ./****.sql ***api-db:/tmp/copyåˆ°mysqlé‡Œï¼›
è¿™ä¸ªå®¹å™¨ç”¨çš„é»˜è®¤çš„æ²¡æœ‰bashï¼Œåªæœ‰shã€‚
ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤ã€‚
mysql -uroot -p
show databases;
use databaseA;
show datatables;
selecr * from datatableA1;
source æ‰“åŒ…çš„åœ°å€.sql ã€è¿™ä¸ªç”¨æ¥å¯¼å…¥çš„ã€‘
exit
å…­ã€nginx
ä¸Šé¢æåˆ°çš„petapi.confå’Œpetclient.confæ˜¯æ€ä¹ˆåŠ è½½è¿›nginxçš„å‘¢ï¼Ÿ
é¦–å…ˆè¿™ä¸¤ä¸ªé€šè¿‡docker-compose.prod.yml åŠ è½½è¿›äº†å®¹å™¨çš„ /etc/nginx/conf.dæ–‡ä»¶å¤¹é‡Œï¼Œç„¶å
çœ‹çœ‹nginx.confæ–‡ä»¶ï¼š
æ‰§è¡Œdocker exec -it pet-nginx shè¿›åˆ°nginxå®¹å™¨ï¼Œå› ä¸ºæ²¡æœ‰å®‰è£…bashæ‰€ä»¥ç”¨shã€‚
æ‰¾åˆ°nginx.confæ‰“å¼€ï¼š
user  nginx;
worker_processes  auto;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;
events {
	worker_connections  1024;
}
http {
	include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &amp;quot;$request&amp;quot; &#39;
                      &#39;$status $body_bytes_sent &amp;quot;$http_referer&amp;quot; &#39;
                      &#39;&amp;quot;$http_user_agent&amp;quot; &amp;quot;$http_x_forwarded_for&amp;quot;&#39;;

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;

    include /etc/nginx/conf.d/*.conf;
}

æ³¨æ„å°±æ˜¯æœ€åä¸€è¡Œinclude /etc/nginx/conf.d/*.conf;å¼•å…¥äº†è¿™ä¸¤ä¸ªconfæ–‡ä»¶ã€‚
åŒæ—¶æˆ‘ä»¬æ³¨æ„æƒé™ï¼š
drwxr-xr-x    1 root     root          4096 Jul 18 15:11 ..
drwxrwxr-x    2 1000     1000          4096 Jul 15 16:54 certs
drwxrwxr-x    3 1000     1000          4096 Jul 19 18:06 conf.d
-rw-r--r--    1 root     root          1077 Jul  7 16:14 fastcgi.conf
-rw-r--r--    1 root     root          1007 Jul  7 16:14 fastcgi_params
-rw-r--r--    1 root     root          2837 Jul  7 16:14 koi-utf
-rw-r--r--    1 root     root          2223 Jul  7 16:14 koi-win
-rw-r--r--    1 root     root          5231 Jul  7 16:14 mime.types
lrwxrwxrwx    1 root     root            22 Jul 10 20:27 modules -&amp;gt; /usr/lib/nginx/modules
-rw-r--r--    1 root     root           646 Jul  7 16:14 nginx.conf
-rw-r--r--    1 root     root           636 Jul  7 16:14 scgi_params
-rw-r--r--    1 root     root           664 Jul  7 16:14 uwsgi_params
-rw-r--r--    1 root     root          3610 Jul  7 16:14 win-utf

è¿™é‡Œé¢certså’Œconf.dæ–‡ä»¶å¤¹çš„ownerå’Œç»„éƒ½æ˜¯1000ï¼Œå°±æ˜¯appå®¹å™¨é‡Œçš„ç”¨æˆ·ã€‚é‡Œé¢çš„æ–‡ä»¶ä¹Ÿæ˜¯è¿™æ ·çš„ã€‚
drwxr-xr-x    1 root     root          4096 Jul 18 15:11 ..
drwxrwxr-x    2 1000     1000          4096 Jul 15 16:54 certs
-rw-rw-r--    1 1000     1000          1465 Jul 19 18:06 petapi.conf
-rw-rw-r--    1 1000     1000          1709 Jul 18 15:07 petclient.conf

æ³¨æ„è¿™æ˜¯åœ¨nginxå®¹å™¨é‡Œäº†ã€‚
å¯¹æ¯”ä¸€çœ‹ certsæ–‡ä»¶å¤¹å¥½åƒé‡å¤äº†ã€‚å¯ä»¥æ”¹ï¼Œè¿™æ · æ³¨é‡Šæ‰- ./docker-compose/nginx/certs:/etc/nginx/certs
ç„¶åæŠŠpetapi.confå’Œpetclient.confé‡ŒåŠ è½½sslæ–‡ä»¶çš„è·¯å¾„ç”±ï¼š
ssl_certificate /etc/nginx/certs/cert.pem;
ssl_certificate_key /etc/nginx/certs/key.pem;

æ”¹ä¸ºï¼š
ssl_certificate /etc/nginx/conf.d/certs/cert.pem;
ssl_certificate_key /etc/nginx/conf.d/certs/key.pem;

nginxè§£æä»£ç†é…ç½®ï¼Œæ¯”å¦‚ï¼š
location /some/path/ {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_pass http://localhost:8000;
}

å‚è€ƒï¼šNGINX Reverse Proxy
è¿˜æœ‰ä¸ªUpstream å‚è€ƒ Securing HTTP Traffic to Upstream Servers
ä»¥åŠ Use NGINX As A Reverse Proxy To Your Containerized Docker Applications
ä»¥åŠ How to set up an easy and secure reverse proxy with Docker, Nginx &amp;amp; Letsencrypt
ç›®å‰å­˜åœ¨çš„bugï¼š
ç½‘ç«™æ ‡é¢˜æ²¡æœ‰
privacyæ²¡æœ‰ã€å·²æ·»åŠ é¡µé¢ã€‘ï¼Œcontactä¹ˆæœ‰ã€ä¸è¦ã€‘ï¼Œfooteræ²¡æœ‰ã€å·²æ·»åŠ ã€‘ï¼Œé‚®ä»¶ ã€åæœŸç”³è¯·äº†æœåŠ¡åæ›´æ–°envæ–‡ä»¶å³å¯ã€‘jwtæ²¡é…ç½®ã€å·²é…ç½®ã€‘ï¼Œæ²¡å¼€queueã€è§ä¸‹æ–¹ã€‘ï¼Œrecaptchaæ²¡é…ç½®ã€å·²ç»è®¾ç½®ä¸ºç”±envæ–‡ä»¶é…ç½®ã€‘ã€‚
è‡³äºqueueï¼ŒåŸæœ¬æ‰“ç®—ä½¿ç”¨supervisordï¼Œä½†æ˜¯å‚è€ƒï¼š
[Advice] Best approach to getting Supervisor setup with a docker compose setup?

â€‹	There is no need for supervisor, just add another php service to your file (same volumes) and add a command line with your queue cmd.
php-queue:
 restart: always
 image: php:7.2-fpm
 command: php artisan queue:work
 volumes:
        - ./www:/var/www

è¿™é‡Œé¢restart alwayså°±èƒ½ä¿è¯é‡å¯ç»´æŠ¤äº†ã€‚
If I wanted to have multiple works would I just setup multiple php-queue containers? Would I need to be concerned about running to many PHP containers on one server?

If you mean multiple queues then i think that queue:work has a --queue argument so you can specify multiple queues.
If you mean multiple processes then you can use the scale argument in docker-compose, something like:
docker-compose up -d --scale php-queue=3

For Swarm mode you can use the replicas option.
Option --scale webserver=3 will create 3 instances of webserver service (you can choose any number of instances you like)

That is an interesting approach. How would you handle reboots and auto running the command?

Thats what restart: always does, it will restart the container if it crashes and autostarts them on boot. If you are using Swarm then you should use restart-policy instead.

I would spin up an new container for supervisor Just use the same app path
Remember you need an redis also

å¦‚æœç¡®å®éœ€è¦supervisordå¯ä»¥å‚è€ƒHow to keep Laravel Queue system running on server ï¼Œä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨bashè„šæœ¬ï¼š
Running the Laravel Scheduler and Queue with Docker
æ‰€ä»¥æœ€åå®Œæˆç‰ˆæœ¬çš„docker-composer.prod.ymlå¦‚ä¸‹ï¼š
ä¸ƒã€æ›´æ–°
Updated docker-compose-prod.yml
version: &amp;quot;3.7&amp;quot;
services:
  app:
    build:
      args:
        user: petapi
        uid: 1000
      context: ./
      dockerfile: Dockerfile
    image: petapii
    container_name: petapi-app
    restart: unless-stopped
    working_dir: /var/www/
    volumes:
      - ./:/var/www
    networks:
      - petapin
  php-queue:
    image: php:7.2.19-fpm
    container_name: petapi-app-queue
    command: php artisan queue:work
    working_dir: /var/www/
    restart: always
    volumes:
      - ./:/var/www
    networks:
      - petapin
  frontapp:
    build:
      context: ~/petclient/dockerfiles/node/
      dockerfile:  Dockerfile
    image: frontapp
    container_name: petclient-frontapp
    restart: unless-stopped
    working_dir: /app
    networks:
      - petclientn
  db:
    image: mysql:5.7
    container_name: petapi-db
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_USER: ${DB_USERNAME}
      SERVICE_TAGS: dev
      SERVICE_NAME: mysql
    volumes:
      - ./docker-compose/mysql:/docker-entrypoint-initdb.d
    networks:
      - petapin
  nginx:
    image: nginx:1.19.1-alpine
    container_name: pet-nginx
    restart: always
    depends_on:
      - app
      - frontapp
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./:/var/www
      - ./docker-compose/nginx:/etc/nginx/conf.d
      - ./docker-compose/nginx/certs:/etc/nginx/certs
    networks:
      - petapin
      - petclientn
networks:
  petapin:
    driver: bridge
  petclientn:
    driver: bridge

ç”±äºè¿›è¡Œäº†ä¸€äº›æºä»£ç çš„æ›´æ–°ï¼Œç‰¹åˆ«æ˜¯å‰ç«¯çš„ä»£ç ï¼Œæ‰€ä»¥è¿™é‡Œé¡ºå¸¦è®²è§£ä¸€ä¸‹ä»¥åä¹Ÿå¯ä»¥å‚è€ƒï¼Œå¦‚ä½•è¿›è¡Œæ›´æ–°ã€‚
è¯·å¼€å§‹å‰å‚è€ƒ [Updated docker-compose-prod.yml](#Updated docker-compose-prod.yml) æŠŠdocker-compose-prod.yml æ›´æ”¹å®Œæ¯•ã€‚
ä¸ƒã€ï¼ˆä¸€ï¼‰ SQLæ•°æ®åº“è¿ç§»
é¦–å…ˆæ˜¯åç«¯apiï¼Œå¦‚æœéœ€è¦å¤§æ›´æ–°ç‰¹åˆ«æ˜¯æ¶‰åŠåˆ°æ•°æ®åº“çš„ï¼Œsqlæ•°æ®åº“å¤‡ä»½å¾ˆé‡è¦ã€‚
ä¸¤ç§æ–¹å¼:
ç¬¬ä¸€ç§ï¼Œæ‰‹åŠ¨ã€ä¸ºäº†èµ°ä¸€éæµç¨‹ã€‘
æ‰§è¡Œdocker exec -it petapi-db bashè¿›å…¥dbå®¹å™¨

æ‰§è¡Œmysql -uroot -p å¹¶è¾“å…¥å¯†ç ï¼Œç™»å½•æ•°æ®åº“

ç™»å½•åæ‰§è¡Œshow databases;æ£€æŸ¥æ•°æ®åº“ï¼Œç„¶åç¡®è®¤æˆ‘ä»¬è¦å¤‡ä»½çš„æ•°æ®åº“

æ¥ä¸‹æ¥æ‰§è¡Œexité€€å‡ºæ•°æ®åº“ç™»å½•ï¼Œ
åœ¨dbå®¹å™¨shellæ‰§è¡Œmysqldump -uroot -p ***api &amp;gt; backup.sql å°±å¯ä»¥äº†ï¼Œæ ¼å¼å‚è€ƒHow To Import and Export Databases in MySQL or MariaDB with Dockerä¸ºï¼š
mysqldump -u username -p database_name &amp;gt; dump.sql  


å¯ä»¥æ‰§è¡Œhead -n 5 backup.sql æ£€æŸ¥ç»“æœï¼›5ä¸å¤Ÿå¯ä»¥è®¾ç½®20

ç”±äºæˆ‘ä»¬çš„dbå®¹å™¨æŠŠæ•°æ®å·è®¾ç½®åœ¨äº†docker-entrypoint-initdb.dæ–‡ä»¶å¤¹é‡Œï¼Œæ‰€ä»¥æœ€å¥½æ˜¯å¤‡ä»½åˆ°è¿™æ–‡ä»¶å¤¹é‡Œã€‚è¿™æ ·å®¿ä¸»æœºå¤‡ä»½åï¼Œå®¿ä¸»æœºå¯ä»¥ç›´æ¥æ‹¿åˆ°ï¼Œè¿™é‡Œæˆ‘å°±ç›´æ¥ç»™mvåˆ°æ–‡ä»¶å¤¹é‡Œå»äº†ã€‚
exité€€å‡ºå®¹å™¨ï¼Œç„¶åå°±å¯ä»¥åœ¨å®¿ä¸»æœº docker-compose.prod.ymlçš„ä¸Šä¸‹æ–‡./docker-compose/mysqlæ–‡ä»¶å¤¹è·¯å¾„é‡Œçœ‹åˆ°æˆ‘ä»¬åˆšdumpæ‰“åŒ…çš„æ•°æ®åº“å¤‡ä»½æ–‡ä»¶äº†ã€‚

æ¥ä¸‹æ¥å°±æ˜¯å‚è€ƒä¹‹å‰çš„å¯¼å…¥æ–¹æ³•å¯¼å…¥åˆ°æ–°æ•°æ®åº“å³å¯ã€‚
ç¬¬äºŒç§ï¼Œä½¿ç”¨databack/mysql-backup
å»ºè®®ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œå› ä¸ºå¯ä»¥è‡ªåŠ¨æ‰§è¡Œå¤‡ä»½ã€‚å³ä½¿ä¸è¿ç§»ï¼Œå¹³æ—¶çš„è¿ç»´ä¹Ÿåº”è¯¥è¿™ä¹ˆåšå¥½å¤‡ä»½æ¯”è¾ƒå®‰å…¨ã€‚å¤‡ä»½å®Œæˆä¹‹åï¼Œå»ºè®®ç›´æ¥å‘é€æˆ–ä¸Šä¼ åˆ°åº“ã€‚
ä¸ƒã€ï¼ˆäºŒï¼‰pull æ›´æ–°åçš„laravel apiåç«¯ä»£ç 
å…¶å®å°±æ˜¯é‡å¤æ“ä½œ ä¸‰ã€laravelå‘å¸ƒéœ€è¦å‡†å¤‡çš„æ–‡ä»¶å’Œç”Ÿäº§ç¯å¢ƒè¦åšçš„ä¸€äº›æ“ä½œ
ä¸ƒã€ï¼ˆä¸‰ï¼‰ å‰ç«¯éƒ¨åˆ†
æ•´ä½“æ¥è¯´å¯ä»¥å‚è€ƒå››ã€nuxté‡åˆ°çš„å‘ ï¼Œè¿™é‡Œå½“ç„¶è¯¦ç»†è®²è§£ä¸€ä¸‹ã€‚
é¦–å…ˆæ˜¯æŠŠä»£ç æ›´æ–°åˆ°githubã€‚
æ‰§è¡Œ ssh user_name@server_ip_addressç™»å½•åˆ°æœåŠ¡å™¨ã€‚
nodeçš„Dockerfileä¸éœ€è¦æ›´æ–°äº†ã€‚
æˆ‘ä»¬ç›´æ¥åˆ‡åˆ° nodeå®¹å™¨Dockerfile ä¸Šä¸‹æ–‡çš„è·¯å¾„ ./pet-clientä¸‹ï¼Œå‚è€ƒ [docker-compose.prod.yml](#Updated docker-compose-prod.yml)ä¸­frontappéƒ¨åˆ†å®šä¹‰çš„context:context: ~/petclient/dockerfiles/node/ ï¼Œå³åˆ‡æ¢åˆ°çš„è·¯å¾„æ˜¯~/petclient/dockerfiles/node/pet-client è¿™é‡Œé¢å°±æ˜¯æˆ‘ä»¬å‰ç«¯ä»£ç å­˜æ”¾çš„ä½ç½®äº†ã€‚
åœ¨ ~/petclient/dockerfiles/node/è¿™ä¸ªè·¯å¾„ä¸‹æ‰§è¡Œï¼šrm -rf pets-client/åˆ é™¤æ‰å‰ç«¯ä»£ç ï¼Œå› ä¸ºæˆ‘ä»¬çš„å®¹å™¨é•œåƒï¼Œæ‰“åŒ…çš„æ—¶å€™æ˜¯ç›´æ¥COPYåˆ°å®¹å™¨å†…çš„ã€‚æ›´æ–°çš„æ—¶å€™ï¼Œåˆ é™¤è¿™ä¸ªæ–‡ä»¶å¤¹ï¼Œç„¶åç¨ååˆ é™¤é•œåƒï¼Œé‡æ–°æ‰“åŒ…å¯åŠ¨å³å¯ã€‚
ç„¶åæ‰§è¡Œ git clone https://github.com/****/******.git æŠŠä»£ç æ‹‰åˆ°å®¿ä¸»æœºå†…ã€‚å¦‚æœå·²ç»cloneè¿‡çš„ å¯ä»¥git pull https://github.com/****/******.gitè¿›è¡Œupdateã€‚
ç„¶ååˆ‡æ¢åˆ°docker-compose.prod.ymlæ‰€åœ¨æ–‡ä»¶å¤¹è·¯å¾„ä¸‹æ‰§è¡Œ: docker-compose -f docker-compose.prod.yml downå…³é—­æ‰€æœ‰æœåŠ¡ã€‚


è¿™ä¸ªè­¦å‘Šæ˜¯å› ä¸ºæˆ‘ä»¬ç¼–è¾‘è¿‡docker-compose.prod.ymlï¼Œä½†æ˜¯è¿è¡Œçš„æœåŠ¡å¹¶ä¸æ˜¯è¿™ä¸ªç¼–è¾‘è¿‡çš„ã€‚ä»¥åæœ€å¥½æ˜¯å…¨éƒ¨åœäº†ä¹‹åï¼Œå†ç¼–è¾‘ã€‚

æ¥ä¸‹æ¥æ‰§è¡Œ docker ps -aæŸ¥çœ‹å®¹å™¨ï¼Œç§»é™¤æ‰æ—§ç‰ˆæœ¬çš„å®¹å™¨ã€‚
æ¥ä¸‹æ¥æ‰§è¡Œ docker imagesæŸ¥çœ‹é•œåƒï¼Œç„¶åæ‰§è¡Œdocker rmi é•œåƒåçš„æ–¹å¼ç§»é™¤æ‰nodeï¼Œfrontappé•œåƒï¼Œ
ç„¶åæ‰§è¡Œdocker-compose -f docker-compose.prod.yml build frontapp æ„å»ºfrontappçš„é•œåƒã€‚
æ„å»ºå®Œæˆ æ‰§è¡Œ docker-compose -f docker-compose.prod.yml up -då³å¯ã€‚
å®¹å™¨å®Œå…¨æ„å»ºå¥½äº†å¹¶å¯åŠ¨ä¹‹åï¼Œç»§ç»­ä¸‹é¢çš„æ“ä½œã€‚
ä¸ƒã€ï¼ˆå››ï¼‰é…ç½®.envæ–‡ä»¶

å¦‚æœdocker-compose.ymlæ–‡ä»¶å’ŒDockerfileæå‰éœ€è¦.envæ–‡ä»¶ä¸­è®¾ç½®çš„å€¼ï¼Œé‚£æ­¤æ­¥éª¤éœ€è¦åœ¨buildå‰æ“ä½œã€‚
å› ä¸ºåç«¯apiæ˜¯æ•°æ®å·æŒ‚è½½åˆ°å®¹å™¨å†…çš„ï¼Œæ‰€ä»¥.envæ–‡ä»¶å¯ä»¥å®¿ä¸»æœºé‡Œç¼–è¾‘ã€‚
frontappæ˜¯COPYåˆ°å®¹å™¨å†…çš„ï¼Œæ‰€ä»¥éœ€è¦åˆ‡æ¢åˆ°å®¹å™¨å†…ï¼Œæˆ–è€…åœ¨buildå‰å»ºç«‹å¥½ï¼Œbuildæ‰§è¡Œçš„æ—¶å€™ç›´æ¥COPYåˆ°å®¹å™¨å†…äº†ï¼Œå»ºè®®æå‰åœ¨petclientè¢«cloneåˆ°æœ¬åœ°åå°±ç¼–è¾‘å¥½ã€‚
å¦‚æœæ˜¯éœ€è¦å®¹å™¨å†…ä¿®æ”¹ï¼Œ
æ‰§è¡Œdocker exec -it petclient-frontapp bashè¿›å…¥å®¹å™¨å†…ã€‚
æ‰§è¡Œ vi .env ç„¶åç¼–è¾‘ç„¶åä¿å­˜é€€å‡ºã€‚

å®Œæˆã€‚
è¡¥å……ï¼Œæœ€å¥½ç²¾ç®€ä¸€ä¸‹css åŠ jsä»£ç ã€‚
ä¸ƒã€ï¼ˆäº”ï¼‰å‚è€ƒMysql Dockerå®¹å™¨å…³äºå¦‚ä½•å¤„ç†downåupæ•°æ®å°±ä¸¢å¤±çš„é—®é¢˜ä»¥åŠåŸç† é˜²æ­¢æ¯æ¬¡é‡æ–°é…ç½®æ•°æ®åº“
docker-compose.prod.ymlæ›´æ–°ä¸ºï¼š
version: &amp;quot;3.7&amp;quot;
services:
  app:
    build:
      args:
        user: petapi
        uid: 1000
      context: ./
      dockerfile: Dockerfile
    image: petapii
    container_name: petapi-app
    restart: unless-stopped
    working_dir: /var/www/
    volumes:
      - ./:/var/www
    networks:
      - petapin
  php-queue:
    restart: always
    container_name: petapi-app-queue
    working_dir: /var/www/
    image: php:7.2.19-fpm
    command: php artisan queue:work
    volumes:
      - ./:/var/www
    networks:
      - petapin
  frontapp:
    build:
      context: ~/petclient/dockerfiles/node/
      dockerfile:  Dockerfile
    image: frontapp
    container_name: petclient-frontapp
    restart: unless-stopped
    networks:
      - petclientn
  db:
    image: mysql:5.7
    container_name: petapi-db
    restart: unless-stopped
    env_file:
      - ~/petapi/pets-api/.env
    environment:
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_USER: ${DB_USERNAME}
      SERVICE_TAGS: dev
      SERVICE_NAME: mysql
    volumes:
      - ./docker-compose/mysql:/docker-entrypoint-initdb.d
      - ./docker-compose/mysql/data:/var/lib/mysql
    networks:
      - petapin
  nginx:
    image: nginx:1.19.1-alpine
    container_name: pet-nginx
    restart: always
    depends_on:
      - app
      - frontapp
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./:/var/www
      - ./docker-compose/nginx:/etc/nginx/conf.d
      - ./docker-compose/nginx/certs:/etc/nginx/certs
    networks:
      - petapin
      - petclientn
networks:
  petapin:
    driver: bridge
  petclientn:
    driver: bridge

å…«ã€ssl cronJob ä¸ supervisorä»‹ç»

                                        </div>
                                        
                                            <a class="btn btn-text" href="https://dzkjz.github.io/post/zong-jie-nuxt-laravel-nginx-mysql-docker-ubuntu-bu-shu-de-liu-cheng/">Read More ~</a>
                            </div>
                </div>
            </article>
            
                <!-- ç¿»é¡µ -->
                
    <div class="pagination-container">
        
            <a href="https://dzkjz.github.io/" class="page-btn btn">ä¸Šä¸€é¡µ</a>
            
                
    </div>
    
                </div>
                <!--  -->
                <div class="main-container-middle"></div>
                <!--  -->
                <div id="sidebar" class="main-container-right">

                    <!-- ä¸ªäººä¿¡æ¯ -->
                    
    <div class="id_card i-card">
        <div class="id_card-avatar" style="background-image: url(https://dzkjz.github.io//images/avatar.png?v=1596645853433)">
        </div>
        <h1 class="id_card-title">
            JojoLegend
        </h1>
        <h2 class="id_card-description">
            Something for age
        </h2>
        <!--  -->
        <div class="id_card-sns">
            <!-- github -->
            
                    <!-- twitter -->
                    
                            <!-- weibo -->
                            
                                    <!-- facebook -->
                                    

        </div>
    </div>
    

                        <!-- å…¬å‘Šæ  -->
                        

                </div>
            </div>



            <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | 
  <a class="rss" href="https://dzkjz.github.io//atom.xml" target="_blank">RSS</a>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>

    </div>
    <script>
        $('#sidebar').stickySidebar({
            topSpacing: 80,
            // bottomSpacing: 60
        });
    </script>
</body>

</html>