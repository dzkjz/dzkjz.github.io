<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://dzkjz.github.io/</id>
    <title>JojoLegend</title>
    <updated>2020-07-31T10:19:40.069Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://dzkjz.github.io/"/>
    <link rel="self" href="https://dzkjz.github.io/atom.xml"/>
    <subtitle>Something for age</subtitle>
    <logo>https://dzkjz.github.io/images/avatar.png</logo>
    <icon>https://dzkjz.github.io/favicon.ico</icon>
    <rights>All rights reserved 2020, JojoLegend</rights>
    <entry>
        <title type="html"><![CDATA[laravelä½¿ç”¨sendgridçš„é…ç½®]]></title>
        <id>https://dzkjz.github.io/post/laravel-shi-yong-sendgrid-de-pei-zhi/</id>
        <link href="https://dzkjz.github.io/post/laravel-shi-yong-sendgrid-de-pei-zhi/">
        </link>
        <updated>2020-07-30T16:55:49.000Z</updated>
        <content type="html"><![CDATA[<p><code>petapi-app</code>çš„<code>.env</code>æ–‡ä»¶éœ€è¦ä¿®æ”¹ï¼š</p>
<p>å°‡<code>QUEUE_CONNECTION=sync</code>æ”¹çˆ²ï¼š</p>
<pre><code>QUEUE_CONNECTION=database
</code></pre>
<figure data-type="image" tabindex="1"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/20200731015131.png" alt="" loading="lazy"></figure>
<p>é€™æ¨£æ‰èƒ½ä½¿ç”¨queue jobï¼Œä¹‹å‰ä¸æ”¹å°±ä¸€ç›´ç»™ğŸ‘´æŠ¥500é”™è¯¯ï¼š</p>
<figure data-type="image" tabindex="2"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/20200731005112.png" alt="" loading="lazy"></figure>
<p><s>è€Œä¸”å‚è€ƒä½¿ç”¨ <code>https://github.com/s-ichikawa/laravel-sendgrid-driver</code></s></p>
<p><s>ä¹‹å sendgrid é…ç½®å°±å¾ˆç®€å•äº†ï¼š</s></p>
<blockquote>
<p>.env</p>
<pre><code>MAIL_DRIVER=sendgrid
SENDGRID_API_KEY='YOUR_SENDGRID_API_KEY'
</code></pre>
<p>config/services.php (In using lumen, require creating config directory and file.)</p>
<pre><code>'sendgrid' =&gt; [
  'api_key' =&gt; env('SENDGRID_API_KEY'),
],
</code></pre>
<p>config/mail.php</p>
<pre><code>'mailers' =&gt; [
  'sendgrid' =&gt; [
      'transport' =&gt; 'sendgrid',
  ],
],
</code></pre>
</blockquote>
<p>ç”¨äº†ä¹‹åæŠ¥550é”™è¯¯</p>
<p>å®˜æ–¹æ–‡æ¡£å†™</p>
<blockquote>
<table>
<thead>
<tr>
<th>550</th>
<th><code>Requested action not taken: mailbox unavailable</code></th>
<th>The userâ€™s mailbox was unavailable. Usually because it could not be found, or because of incoming policy reasons. Remove these address from your list - it is likely a fake, or it was mistyped.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<p><strong>æ‰€ä»¥åˆæ¢æˆäº†åŸæ¥çš„é»˜è®¤é…ç½®ï¼Œå¹¶ä¸”å‚è€ƒ https://sendgrid.com/docs/for-developers/sending-email/laravel/ é…ç½®äº†<code>.env</code>ï¼Œç„¶åå°±okäº† portæ˜¯ç”¨çš„587+ tlsæ²¡æœ‰ç”¨ssl+465</strong></p>
<figure data-type="image" tabindex="3"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/20200731015038.png" alt="" loading="lazy"></figure>
<p>å¦å¤–å‚è€ƒ <code>https://laravel.io/forum/why-queue-still-waiting-when-send-mail-in-laravel</code> å¯ä»¥åœ¨appå®¹å™¨å†…æ‰§è¡Œ</p>
<pre><code>composer dumpautoload
</code></pre>
<figure data-type="image" tabindex="4"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/20200731014523.png" alt="" loading="lazy"></figure>
<p>è¿˜è¦æ³¨æ„ï¼Œä¹‹å‰ä½¿ç”¨çš„queueå®¹å™¨ï¼Œå› ä¸ºé»˜è®¤æ˜¯rootç”¨æˆ· æ— æ³•æ‰§è¡Œartisanå‘½ä»¤ æ‰€ä»¥è¿™ä¸ªå®¹å™¨å°±ç”¨ä¸ä¸Šäº†ã€‚</p>
<p>äºæ˜¯åˆæ”¹æˆäº†åœ¨dockerå®¹å™¨é‡ŒåŠ <code>supervisord</code>ï¼š</p>
<blockquote>
<p>ä¸è¿‡åœ¨ä½¿ç”¨supervisordå‰å¤šè¯´å‡ å¥ï¼Œ</p>
<p>å¹³æ—¶æ‰§è¡Œçš„ <code>php artisan queue:work</code>ä¸€æ—¦å…³é—­terminalï¼Œå°±ä¼šä¸­æ­¢ï¼Œæ‰€ä»¥éœ€è¦ä»‹ç»ä¸€ä¸ª<a href="https://linux.die.net/man/1/nohup"><code>nohup</code></a>å‘½ä»¤ï¼Œæ­¤å‘½ä»¤å¯ä»¥å¿½ç•¥terminalä¸­æ­¢ï¼Œ<em>nohup-è¿è¡Œä¸å—æŒ‚æ–­å½±å“çš„å‘½ä»¤ï¼Œå¹¶é‡‡ç”¨éttyè¾“å‡º</em> ï¼Œé‚£ä¹ˆå‚è€ƒhttps://stackoverflow.com/a/28625847 å³å¯æ‰§è¡Œï¼š</p>
<p><code>nohup php artisan queue:work --daemon &amp;</code></p>
<p>æˆ–è€…æ‰§è¡Œä¸‹é¢å‘½ä»¤æŠŠlogè¾“å‡ºåˆ°æ–‡ä»¶ä¸­</p>
<p><code>nohup php artisan queue:work --daemon &gt; app/storage/logs/laravel.log &amp;</code></p>
</blockquote>
<p>å¼€å§‹è®²è§£å¦‚ä½•ä½¿ç”¨supervisord:</p>
<p><a href="https://laravel.com/docs/7.x/queues#supervisor-configuration">å®˜æ–¹è®²è§£</a></p>
<p><a href="https://medium.com/@rohit_shirke/configuring-supervisor-for-laravel-queues-81e555e550c6">è¡¥å……è®²è§£</a></p>
<p><a href="https://blog.whabash.com/posts/installing-supervisor-manage-laravel-queue-processes-ubuntu">Installing Supervisor to Manage Laravel Queue Processes on Ubuntu</a></p>
<p>æ‰§è¡Œ<code>sudo apt install supervisor</code> è¿™ä¸ªå®‰è£…ç”±äºå¯ä»¥åœ¨dockerfileä¸­å®Œæˆæ‰€ä»¥ç›´æ¥åŠ åˆ°äº†appæœåŠ¡çš„Dockerfileä¸­ã€‚</p>
<pre><code>FROM php:7.2.19-fpm

# Arguments defined in docker-compose.yml
ARG user
ARG uid

# Install system dependencies
RUN apt-get update &amp;&amp; apt-get install -y \
    git \
    curl \
    libpng-dev \
    libonig-dev \
    libxml2-dev \
    zip \
    unzip \
	supervisor


# Clear cache
RUN apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/*

# Install PHP extensions
RUN docker-php-ext-install pdo_mysql mbstring exif pcntl bcmath gd

# Get latest Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Create system user to run Composer and Artisan Commands
RUN useradd -G www-data,root -u $uid -d /home/$user $user
RUN mkdir -p /home/$user/.composer &amp;&amp; \
    chown -R $user:$user /home/$user

# Set working directory
WORKDIR /var/www

USER $user

</code></pre>
<p>ç„¶åæ˜¯Supervisoré…ç½®æ–‡ä»¶ï¼Œé»˜è®¤æƒ…å†µè¿™ä¸ªé…ç½®æ–‡ä»¶éœ€è¦æ”¾åœ¨/etc/supervisor/conf.dæ–‡ä»¶å¤¹ä¸‹é¢ï¼Œæ­¤æ–‡ä»¶å¤¹ä¸‹ï¼Œå¯ä»¥åˆ›å»ºæ— æ•°ä½ éœ€è¦çš„é…ç½®æ–‡ä»¶ï¼Œåæ­£éœ€è¦supervisorç›‘è§†çš„å°±ç»™åˆ°è¿™é‡Œé¢ï¼Œé‚£è¿™ä¸ªæ–‡ä»¶å¤¹åœ¨<code>docker-compose.prod.yml</code>é‡Œé¢ç›´æ¥ç”¨volumeæŒ‚è½½å¥½å°±è¡Œäº†ï¼Œæˆ‘è¿™é‡Œæ˜¯</p>
<pre><code class="language-yml">version: &quot;3.7&quot;
services:
  app:
    build:
      args:
        user: petapi
        uid: 1000
      context: ./
      dockerfile: Dockerfile
    image: petapii
    container_name: petapi-app
    restart: unless-stopped
    working_dir: /var/www/
    volumes:
      - ./:/var/www
      - ./docker-compose/supervisor:/etc/supervisor/conf.d
    networks:
      - petapin
</code></pre>
<p>æŒ‚çš„è¿™ä¸ªæ–‡ä»¶å¤¹</p>
<p><code>- ./docker-compose/supervisor:/etc/supervisor/conf.d</code></p>
<p>ç„¶åå†åœ¨ å®¿ä¸»æœº ä¸Šä¸‹æ–‡ <code>./docker-compose/supervisor</code>è·¯å¾„åˆ›å»ºåä¸º<code>petapi-worker.conf</code>çš„æ–‡ä»¶ï¼Œå®¹å™¨å¯åŠ¨åï¼Œå®¹å™¨å†…å°±æŒ‚å¾—æœ‰ä¸€ä¸ª<code>/etc/supervisor/conf.d/petapi-worker.conf</code>æ–‡ä»¶äº†ã€‚</p>
<p>ç¼–è¾‘æ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<pre><code class="language-conf">[program:petapi-worker]
process_name=%(program_name)s_%(process_num)02d
command=sudo php /var/www/artisan queue:work --tries=3 --sleep=3 --daemon
user=petapi
autostart=true
autorestart=true
numprocs=1
redirect_stderr=true
stopwaitsecs=3600
stdout_logfile=/var/www/storage/logs/petapi-worker-supervisor.log
</code></pre>
<p>æˆ‘çš„petapiæŒ‚è½½åœ¨/var/wwwä¸‹é¢ï¼Œartisanå‘½ä»¤æ‰§è¡Œä¹Ÿåœ¨æ”¹æ–‡ä»¶å¤¹è·¯å¾„ï¼Œæ‰€ä»¥commandä¸º<code>command=sudo php /var/www/artisan queue:work</code></p>
<blockquote>
<p>ä¹Ÿå¯ä»¥ä½¿ç”¨confå†æ‰§è¡Œè„šæœ¬çš„æ–¹å¼ï¼Œå‚è€ƒ https://gist.github.com/danharper/9136507</p>
</blockquote>
<blockquote>
<p><strong>ç”±äºéœ€è¦ç»™supervisoræ‰§è¡Œphp artisanå‘½ä»¤çš„æƒé™ï¼Œæ‰€ä»¥ç”¨æˆ·è®¾ç½®ä¸ºäº†petapiï¼Œæœ‰çš„å¦‚ï¼š<a href="https://ekn.me/2019-11-05/how-to-use-laravel-queue-worker-with-supervisor">How to use Laravel Queue Worker with Supervisor </a> åŠ<a href="https://blog.whabash.com/posts/installing-supervisor-manage-laravel-queue-processes-ubuntu">Installing Supervisor to Manage Laravel Queue Processes on Ubuntu</a>ç»™äº†ç”¨æˆ·ç»„supervisorç„¶åç»™è¿™ä¸ªç”¨æˆ·ç»„æ·»åŠ æ‰§è¡Œartisanå‘½ä»¤çš„æƒé™ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸éœ€è¦çš„ã€‚</strong></p>
</blockquote>
<p>ç„¶åæœåŠ¡å®¹å™¨å¯åŠ¨å°±æ‰§è¡Œ</p>
<pre><code>sudo supervisorctl reread

sudo supervisorctl update

sudo supervisorctl start petapi-worker:*
</code></pre>
<p><s>ç›´æ¥å†™åˆ°supervisor_petapi.shè„šæœ¬é‡Œé¢ï¼Œæ–‡ä»¶åœ¨<code>./docker-compose/supervisor</code>å®¿ä¸»æœºæ–‡ä»¶å¤¹å†…</s></p>
<pre><code class="language-sh">supervisorctl reread

supervisorctl update

supervisorctl start petapi-worker:*
</code></pre>
<p><s>ç„¶åDockerfileæ·»åŠ ï¼š</s></p>
<pre><code>COPY --chown=$user ./docker-compose/supervisor/supervisor_petapi.sh /var/www

...
USER $user
...
CMD supervisor_petapi.sh                  
</code></pre>
<p><s>æœ‰å¼‚å¸¸:</s></p>
<blockquote>
<pre><code>  supervisorctl reread
</code></pre>
<p>error: &lt;class 'socket.error'&gt;, [Errno 2] No such file or directory: file: /usr/lib/python2.7/socket.py line: 228</p>
</blockquote>
<p><s>è¿™æ ·appå®¹å™¨å¯åŠ¨çš„æ—¶å€™å°±ä¼šæ‰§è¡Œä¸Šè¿°è„šæœ¬å‘½ä»¤äº†ã€‚</s></p>
<h3 id="è¿˜æ˜¯æ²¡æˆåŠŸæ˜å¤©ç»§ç»­">è¿˜æ˜¯æ²¡æˆåŠŸï¼Œæ˜å¤©ç»§ç»­ï¼</h3>
<p>å‘ç°æ‰§è¡Œ</p>
<p><code>docker exec -it petapi-app bash</code>è¿›å…¥å®¹å™¨åï¼Œç”¨æˆ·ç”±äºåœ¨Dockerfileä¸­è¢«æŒ‡å®šä¸ºäº†petapiï¼Œæ‰§è¡Œ<code>apt-get</code>ä¼šæç¤ºæ²¡æœ‰æƒé™ï¼Œæ‰€ä»¥å‚è€ƒ<a href="https://stackoverflow.com/questions/28721699/root-password-inside-a-docker-container">Root password inside a Docker container</a>æ‰§è¡Œ<code>docker exec -u 0 -it petapi-app bash</code>ä»¥rootèº«ä»½ç™»å½•è¿›å…¥å³å¯</p>
<p>æ‰§è¡Œ<code>supervisorctl reread</code></p>
<p>æŠ¥é”™<code>unix:///var/run/supervisor.sock no such file</code>ï¼Œå‚è€ƒ<a href="https://serverfault.com/questions/808732/supervisor-sock-file-missing">Supervisor sock file missing</a>æ‰§è¡Œ</p>
<pre><code>service supervisor stop
service supervisor start 
</code></pre>
<p><s>æ‰§è¡Œ<code>supervisorctl reread</code>æœ‰æŠ¥é”™ï¼š</s> è¿™ä¸æ˜¯é”™ï¼›</p>
<figure data-type="image" tabindex="5"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/20200731141643.png" alt="" loading="lazy"></figure>
<p>å‚è€ƒ<a href="https://stackoverflow.com/questions/41618674/supervisord-config-changes-not-recognized-after-reread-update">Supervisord config changes not recognized after reread/update</a> æ˜¯æŒ‡ï¼Œæ²¡æœ‰æ›´æ–°ï¼Œæ‰€ä»¥æ²¡æœ‰æ˜¾ç¤ºæœ‰å˜åŒ–ã€‚</p>
<p>ç„¶åæ‰§è¡Œ<code>supervisorctl update</code></p>
<p>ä»¥åŠ<code>supervisorctl start petapi-worker:*</code></p>
<figure data-type="image" tabindex="6"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/20200731142051.png" alt="" loading="lazy"></figure>
<p>è¿™æ¬¡æ˜¯æŠ¥é”™äº†ã€‚æ‰¾ä¸åˆ°æ–‡ä»¶ã€‚</p>
<p>å¦‚æœæ˜¯æŠ¥è¿™ä¸ªé”™<a href="https://stackoverflow.com/questions/54811044/why-i-get-this-error-laravel-worker-error-no-such-group">laravel-worker: ERROR (no such group)</a>ï¼Œå¯ä»¥çœ‹çœ‹</p>
<p><code>/etc/supervisord.conf</code>æ–‡ä»¶é…ç½®çš„</p>
<pre><code>[include]
files = supervisord.d/*.conf
</code></pre>
<p>è¿™ä¸ªincludeéƒ¨åˆ†æ˜¯ä¸æ˜¯æŒ‡å‘çš„workeré…ç½®è·¯å¾„ï¼Œæˆ‘è¿™é‡Œæ˜¯</p>
<figure data-type="image" tabindex="7"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/20200731142741.png" alt="" loading="lazy"></figure>
<blockquote>
<p>ç”±äºdebugéœ€è¦pså‘½ä»¤ï¼Œæ‰€ä»¥å‚è€ƒ<a href="https://stackoverflow.com/questions/26982274/ps-command-doesnt-work-in-docker-container">ps command doesn't work in docker container</a>,æ‰§è¡Œ<code>RUN apt-get update &amp;&amp; apt-get install -y procps</code>æ·»åŠ ä¹‹</p>
</blockquote>
<p>æ‰§è¡Œ<code>ps -ef | grep supervisor</code>æŸ¥çœ‹</p>
<figure data-type="image" tabindex="8"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/20200731143919.png" alt="" loading="lazy"></figure>
<p>ä½†æ˜¯æ‰§è¡Œ<code>service supervisor stop</code>åä¾ç„¶æœ‰ä¸€ä¸ª</p>
<figure data-type="image" tabindex="9"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/20200731144343.png" alt="" loading="lazy"></figure>
<p>ç´¢æ€§ç›´æ¥æ‰§è¡Œ<code>kill -s SIGTERM 468</code>å…³é—­è¿™ä¸ª468è¿›ç¨‹ã€‚</p>
<p>ç„¶åæ‰§è¡Œ<code>service supervisor start</code>å¯åŠ¨åæŸ¥çœ‹ï¼š</p>
<figure data-type="image" tabindex="10"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/20200731144534.png" alt="" loading="lazy"></figure>
<p>ä¸‹é¢è§£é‡Šä¸€ä¸‹</p>
<p><code>/usr/bin/supervisord -c /etc/supervisor/supervisord.conf</code>ï¼Œ</p>
<blockquote>
<p>å‚è€ƒ<a href="http://supervisord.org/installing.html#creating-a-configuration-file">Creating a Configuration File</a>ï¼Œå¦‚æœæ‰§è¡Œç”¨æˆ·æ²¡æœ‰rootæƒé™æˆ–è€…supervisord.confæ–‡ä»¶æ²¡æœ‰æ”¾åœ¨é»˜è®¤çš„/etc/supervisord.confè·¯å¾„ï¼Œé‚£ä¹ˆ-cåé¢æ¥ä½ å®é™…é˜²æ­¢supervisord.confæ–‡ä»¶çš„è·¯å¾„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œsupervisorä¼šåœ¨å…¶å½“å‰è·¯å¾„é‡Œé¢æ‰¾è¿™ä¸ªconfæ–‡ä»¶ï¼ŒåŠ  -c å°±å¯ä»¥æŒ‡å®šå…¶ä»–ä½ç½®äº†ã€‚</p>
</blockquote>
<p>ä½†æ˜¯æ‰§è¡Œ<code>supervisorctl start petapi-worker:*</code></p>
<figure data-type="image" tabindex="11"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/20200731142051.png" alt="" loading="lazy"></figure>
<p>è¿™æ¬¡æ˜¯ä¾ç„¶æŠ¥é”™äº†ã€‚æ‰¾ä¸åˆ°æ–‡ä»¶ã€‚ç›´æ¥nanoç¼–è¾‘è¿™ä¸ªæ–‡ä»¶ç„¶å</p>
<figure data-type="image" tabindex="12"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/20200731151403.png" alt="" loading="lazy"></figure>
<p>ç»ˆäºç»™ğŸ‘´OKäº†ã€‚</p>
<p>ç„¶åæ‰§è¡Œ<code>supervisorctl status</code>æŸ¥çœ‹ä¸€ä¸‹çŠ¶æ€ï¼š</p>
<figure data-type="image" tabindex="13"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/20200731151632.png" alt="" loading="lazy"></figure>
<p>è¡Œå§ã€‚</p>
<p>å†æ”¹ä¸€ä¸‹ã€‚</p>
<p>å…ˆæ‰§è¡Œ<code>supervisorctl stop all</code></p>
<figure data-type="image" tabindex="14"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/20200731152456.png" alt="" loading="lazy"></figure>
<p>åŠæ‰§è¡Œ<code>service supervisor stop</code>åœæ‰è¿›ç¨‹ã€‚</p>
<p>å†æ‰§è¡Œ<code>supervisorctl status</code>æŸ¥çœ‹çŠ¶æ€ï¼š</p>
<figure data-type="image" tabindex="15"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/20200731151828.png" alt="" loading="lazy"></figure>
<p>å†æ‰§è¡Œ<code>ps -ef | grep supervisor</code>æŸ¥çœ‹è¿›ç¨‹åœæ­¢å®Œæ²¡æœ‰ï¼š</p>
<figure data-type="image" tabindex="16"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/20200731151941.png" alt="" loading="lazy"></figure>
<p>OKï¼Œåœæ­¢å®Œäº†ï¼Œæˆ‘ä»¬æ”¹æ”¹è¿™ä¸ªpetapi-worker.confæ–‡ä»¶ï¼š</p>
<p>å»æ‰sudoåï¼š</p>
<figure data-type="image" tabindex="17"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/20200731152052.png" alt="" loading="lazy"></figure>
<p>ç„¶åæ‰§è¡Œ<code>service supervisor start</code>åŠ</p>
<pre><code>supervisorctl reread

supervisorctl update

supervisorctl start petapi-worker:*
</code></pre>
<p>ç„¶åæ‰§è¡Œ<code>supervisorctl status</code>æŸ¥çœ‹çŠ¶æ€</p>
<figure data-type="image" tabindex="18"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/20200731152816.png" alt="" loading="lazy"></figure>
<p>OKäº†ã€‚</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<h4 id="petapi-workerconfæ–‡ä»¶">petapi-worker.confæ–‡ä»¶ï¼š</h4>
<pre><code>[program:petapi-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/artisan queue:work --tries=3 --sleep=3 --daemon
user=petapi
autostart=true
autorestart=true
numprocs=1
redirect_stderr=true
;stopwaitsecs=3600
stdout_logfile=/var/www/storage/logs/petapi-worker-supervisor.log
</code></pre>
<h4 id="appå®¹å™¨çš„dockerfileæ–‡ä»¶">appå®¹å™¨çš„Dockerfileæ–‡ä»¶ï¼š</h4>
<pre><code>FROM php:7.2.19-fpm

# Arguments defined in docker-compose.yml
ARG user
ARG uid

# Install system dependencies
RUN apt-get update &amp;&amp; apt-get install -y \
    git \
    curl \
    libpng-dev \
    libonig-dev \
    libxml2-dev \
    zip \
    unzip \
	supervisor


# Clear cache
RUN apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/*

# Install PHP extensions
RUN docker-php-ext-install pdo_mysql mbstring exif pcntl bcmath gd

# Get latest Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Create system user to run Composer and Artisan Commands
RUN useradd -G www-data,root -u $uid -d /home/$user $user
RUN mkdir -p /home/$user/.composer &amp;&amp; \
    chown -R $user:$user /home/$user

# Set working directory
WORKDIR /var/www

USER $user
</code></pre>
<p>è€ƒè™‘ç»™ä¸€ä¸ªsupervisorå®¹å™¨ã€‚</p>
<blockquote>
<p>å› ä¸ºsupervisorctlå‘½ä»¤æ‰§è¡Œéœ€è¦rootç”¨æˆ·ï¼Œpetapiç”¨æˆ·ä¸è¡Œã€‚</p>
</blockquote>
<p>ä¹‹å‰åœ¨Dockerfileä¸­æ·»åŠ </p>
<pre><code>COPY --chown=$user  ./docker-compose/supervisor/supervisor_petapi.sh . 
...
USER $user
...
CMD /var/www/supervisor_petapi.sh
...
</code></pre>
<p>çš„æ–¹å¼ä¸å¯è¡Œï¼Œå› ä¸ºshè„šæœ¬é‡Œé¢çš„å‘½ä»¤æ‰§è¡Œå¿…é¡»æ˜¯rootæƒé™ï¼Œè€Œåˆ‡æ¢æˆUSER petapiåå°±æ— æ³•æ‰§è¡Œshè„šæœ¬é‡Œé¢çš„supervisorctlå‘½ä»¤äº†ã€‚</p>
<p>å¦å¤–ä¹Ÿä¸èƒ½å°†CMDåˆ é™¤æ¢æˆåœ¨USERåˆ‡æ¢å‰çš„RUNå‘½ä»¤ï¼Œå› ä¸ºè™½ç„¶ç”¨æˆ·æƒé™æœ‰äº†ï¼Œä½†æ˜¯å®¹å™¨æ²¡æœ‰å¯åŠ¨ï¼Œshè„šæœ¬é‡Œé¢çš„confæ–‡ä»¶æ‰§è¡Œartisanå‘½ä»¤å¿…ç„¶å¤±è´¥ã€‚</p>
<p>æ‰€ä»¥è€ƒè™‘ç»™ä¸€ä¸ªsupervisorå®¹å™¨ã€‚</p>
<h2 id="æœ€æ–¹ä¾¿çš„æ–¹å¼">æœ€æ–¹ä¾¿çš„æ–¹å¼ï¼š</h2>
<p>ä¹Ÿæ˜¯æœ€åˆé€‚çš„æ–¹å¼ï¼Œè¿™æ ·ä¸€ä¸ªå®¹å™¨åªè´Ÿè´£ä¸€ä»¶äº‹ã€‚</p>
<p><code>docker-compose.prod.yml</code>é‡‡ç”¨php-queueæœåŠ¡ï¼Œå…¶æœåŠ¡å®¹å™¨çš„é•œåƒå°±æ˜¯è¿™ä¸ªpetapi-appçš„é•œåƒï¼Œè€Œç”¨æˆ·ä¸ç»™å‚æ•°ï¼Œåˆ™ç›´æ¥ä½¿ç”¨petapi-appä¸­å°±è®¾ç½®å¥½çš„petapiç”¨æˆ·ï¼Œç„¶åcommandå°±æ˜¯<code>command: [&quot;php&quot;, &quot;/var/www/app/artisan&quot;, &quot;queue:work&quot;, &quot;--daemon&quot;, &quot;--sleep=3&quot;, &quot;--tries=3&quot;]</code></p>
<p>è¿™æ ·supervisoréƒ½ä¸ç”¨ã€‚</p>
<p>ä¸è¿‡ åŒæ—¶æˆ‘ä»¬è¿˜éœ€è¦æ‰§è¡Œä¸€ä¸ª<code>composer dumpautoload</code>å‘½ä»¤ï¼Œå‚è€ƒ<a href="https://stackoverflow.com/questions/30063907/using-docker-compose-how-to-execute-multiple-commands">Using Docker-Compose, how to execute multiple commands</a>æ‰€ä»¥ï¼š</p>
<pre><code>command: &gt;
	bash -c &quot;php artisan queue:work --sleep=3 --tries=3 &amp;&amp;
	composer dumpautoload&quot;
</code></pre>
<p>å¦‚æœæ²¡æœ‰å®‰è£…bashçš„ï¼Œè¯·ä½¿ç”¨<code>sh -c</code></p>
<h4 id="docker-composerprodyml"><code>docker-composer.prod.yml</code></h4>
<pre><code class="language-yml">version: &quot;3.7&quot;
services:
  app:
    build:
      args:
        user: petapi
        uid: 1000
      context: ./
      dockerfile: Dockerfile
    image: petapii
    container_name: petapi-app
    restart: unless-stopped
    working_dir: /var/www/
    volumes:
      - ./:/var/www
    networks:
      - petapin
  php-queue:
    restart: always
    container_name: petapi-app-queue
    working_dir: /var/www/
    image: petapii
    depends_on:
      - &quot;app&quot;
    command: bash -c &quot;php artisan queue:work --sleep=3 --tries=3 &amp;&amp; composer dumpautoload&quot;
    volumes:
      - ./:/var/www
    networks:
      - petapin
  frontapp:
    build:
      context: ~/petclient/dockerfiles/node/
      dockerfile:  Dockerfile
    image: frontapp
    container_name: petclient-frontapp
    restart: unless-stopped
    networks:
      - petclientn
  db:
    image: mysql:5.7
    container_name: petapi-db
    restart: unless-stopped
   #env_file:
     # - ~/petapi/pets-api/.env
    environment:
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_USER: ${DB_USERNAME}
      SERVICE_TAGS: dev
      SERVICE_NAME: mysql
    volumes:
      - ./docker-compose/mysql:/docker-entrypoint-initdb.d
      - ./docker-compose/mysql/data:/var/lib/mysql
    networks:
      - petapin
  nginx:
   # build:
    # context: ./dockerfiles/nginx/
   #  dockerfile: Dockerfile
  #  image: nginx:1.19.1-alpine-custom
    image: nginx:1.19.1-alpine
    container_name: pet-nginx
    restart: always
    depends_on:
      - app
      - frontapp
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./:/var/www
      - ./docker-compose/nginx:/etc/nginx/conf.d
      - ./docker-compose/nginx/certs:/etc/nginx/certs
    networks:
      - petapin
      - petclientn
networks:
  petapin:
    driver: bridge
  petclientn:
    driver: bridge
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Mysql Dockerå®¹å™¨å…³äºå¦‚ä½•å¤„ç†downåupæ•°æ®å°±ä¸¢å¤±çš„é—®é¢˜ä»¥åŠåŸç†]]></title>
        <id>https://dzkjz.github.io/post/mysql-docker-rong-qi-guan-yu-ru-he-chu-li-down-hou-up-shu-ju-jiu-diu-shi-de-wen-ti-yi-ji-yuan-li/</id>
        <link href="https://dzkjz.github.io/post/mysql-docker-rong-qi-guan-yu-ru-he-chu-li-down-hou-up-shu-ju-jiu-diu-shi-de-wen-ti-yi-ji-yuan-li/">
        </link>
        <updated>2020-07-27T07:45:51.000Z</updated>
        <content type="html"><![CDATA[<p>Mysql Dockerå®¹å™¨å…³äºå¦‚ä½•å¤„ç†downåupæ•°æ®å°±ä¸¢å¤±çš„é—®é¢˜ä»¥åŠåŸç†</p>
<p>[toc]</p>
<p>docker-compose å¯ä»¥å¾ˆæ–¹ä¾¿çš„ç”¨äºéƒ¨ç½²å¤šå®¹å™¨ç¯å¢ƒã€‚å…¶ä¸­æ¯”è¾ƒç¹ççš„å°±æ˜¯åšåˆ°å¤šåº”ç”¨é—´æ•°æ®åˆ†ç¦»ã€‚</p>
<p>å®¹å™¨éšæ—¶æˆ‘ä»¬å¯ä»¥å…³é—­æ›´æ–°æ›´æ¢ï¼Œä½†æ˜¯è¦æ€ä¹ˆåšåˆ°æ•°æ®çš„è¿ç»­æ€§å°±å¾ˆå…³é”®äº†ã€‚</p>
<h2 id="ä¸€-åœºæ™¯ä»‹ç»">ä¸€ã€åœºæ™¯ä»‹ç»</h2>
<p>æ¯”è¾ƒå¸¸è§çš„æƒ…å†µï¼Œå¦‚æœä½ è¿è¡Œèµ·ä¸€ä¸ªæ•°æ®åº“å®¹å™¨ï¼Œå¦‚æœä½ åˆ é™¤äº†è¿™ä¸ªå®¹å™¨ï¼Œé‚£å­˜åœ¨å…¶ä¸­çš„æ•°æ®ä¹Ÿå°±ä¸¢å¤±äº†ã€‚</p>
<p>ç‰¹åˆ«æ˜¯æ‰§è¡Œ<code>docker-compose down</code>ç„¶åæ›´æ–°dockerfileå’Œdocker-compose.ymlæ–‡ä»¶ï¼Œå†æ‰§è¡Œ<code>docker-compose up -d</code>ï¼Œä½ ä¹‹å‰ç½‘ç«™çš„æ•°æ®å°±ä¸¢äº†ã€‚</p>
<h2 id="äºŒ-åŸç†ä»¥åŠåŸå› ">äºŒã€åŸç†ä»¥åŠåŸå› </h2>
<blockquote>
<p>æˆ‘ä»¬åœ¨æœ‰è¿è¡Œæ•°æ®åº“å®¹å™¨çš„æœºå™¨é‡Œé¢æ¼”ç¤ºï¼›</p>
</blockquote>
<p>æ‰§è¡Œ<code>docker volume ls</code>æŸ¥çœ‹æœåŠ¡å™¨é‡Œé¢çš„æ•°æ®å·ï¼š</p>
<figure data-type="image" tabindex="1"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/20200727152424.png" alt="" loading="lazy"></figure>
<p>é»˜è®¤driverå°±æ˜¯local ï¼Œæˆ‘ä»¬é…ç½®çš„æ•°æ®å·éƒ½åœ¨è¿™é‡Œé¢äº†ã€‚</p>
<p>ä¸ºäº†æŸ¥çœ‹å“ªä¸€ä¸ªæ˜¯æ•°æ®åº“å®¹å™¨çš„æ•°æ®å·ï¼Œä»¥åŠå¯¹åº”çš„è¯¦ç»†ä¿¡æ¯</p>
<p>æ‰§è¡Œ<code>docker inspect æ•°æ®åº“å®¹å™¨å</code></p>
<p>ç„¶åæ‰¾åˆ° Mountséƒ¨åˆ†ï¼š</p>
<figure data-type="image" tabindex="2"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/20200727152753.png" alt="" loading="lazy"></figure>
<p>ç¬¬ä¸€ä¸ªæˆ‘ä»¬é…ç½®çš„å¯ä»¥åœ¨docker-compose.prod.ymlä¸­æ‰¾åˆ°ï¼š</p>
<pre><code class="language-yml">  db:
    image: mysql:5.7
    container_name: ***api-db
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_USER: ${DB_USERNAME}
      SERVICE_TAGS: dev
      SERVICE_NAME: mysql
    volumes:
      - ./docker-compose/mysql:/docker-entrypoint-initdb.d
</code></pre>
<p>è€Œç¬¬äºŒä¸ªå¯¹åº”ç›®æ ‡åœ°å€æ˜¯<code>/var/lib/mysql</code>çš„ï¼Œå› ä¸ºæˆ‘æ²¡æœ‰é…ç½®ï¼Œæ‰€ä»¥è‡ªåŠ¨ç»™äº†ä¸€ä¸ªï¼Œæ­£æ˜¯è¿™ä¸ªæ²¡æœ‰é…ç½®ï¼Œå¯¼è‡´æ¯æ¬¡<code>docker-compose up -d</code>å°±ç”Ÿæˆä¸€ä¸ªæ–°å®¹å™¨åŠå¯¹åº”çš„æ•°æ®å·ï¼Œç„¶åä¹‹å‰çš„æ•°æ®åº“æ•°æ®å°±ä¸¢å¤±äº†ã€‚</p>
<h2 id="ä¸‰-å¤„ç†åŠæ³•">ä¸‰ã€å¤„ç†åŠæ³•</h2>
<p>å¦‚æœä½ é…ç½®äº†æ¯”å¦‚</p>
<pre><code class="language-yml">  db:
    ...
    volumes:
      - ./docker-compose/mysql:/docker-entrypoint-initdb.d
      - /data/mysql:/var/lib/mysql
   #   - /data/pgsql:/var/lib/postgresql
   #   - /data/maria:/var/lib/mariadb
   #   - /data/redis:/var/lib/redis
   #   - /data/memcached:/var/lib/memcached
   #   - /data/neo4j:/var/lib/neo4j/data
    networks:
      ...
</code></pre>
<p>é…ç½®äº†å¯¹åº”çš„æœ¬åœ°[å®¿ä¸»æœº]æ•°æ®å·ä½ç½®ï¼Œç¬¬ä¸€æ¬¡<code>docker-compose up -d</code>çš„æ—¶å€™ä¼šç›´æ¥å…³è”èµ·æ¥ï¼Œè€Œä¸‹ä¸€æ¬¡æ‰§è¡Œ<code>docker-compose up -d</code>çš„æ—¶å€™ï¼Œdaemonæ‰§è¡Œåˆ°ç”Ÿæˆä¸€ä¸ªå¯¹åº”æ•°æ®å·ä½ç½®çš„æ—¶å€™ï¼Œå‘ç°å·²ç»ç»™äº†é…ç½®ï¼Œé‚£å°±è·³è¿‡ï¼Œä½¿ç”¨å…ˆå‰çš„ã€‚</p>
<p>å½“ç„¶ä¹Ÿå¯ä»¥è¿™ä¹ˆé…ç½®ï¼š</p>
<pre><code class="language-yml">volumes:
- db-data:/var/lib/mysql
volumes:
 db-data:
  driver: local
</code></pre>
<blockquote>
<p>å‚è€ƒ <a href="https://linuxhint.com/run_postgresql_docker_compose/">Running PostgreSQL using Docker Compose</a></p>
<p>å‚è€ƒ <a href="https://stackoverflow.com/questions/43297384/data-is-lost-in-mysql-docker-container-after-comminting-it-to-a-new-image">Data is lost in Mysql docker container after comminting it to a new image?</a></p>
<blockquote>
<p>I don't know which image you're using but I believe every <code>Dockerfile</code> of <a href="https://github.com/docker-library/mysql">official mysql images</a> has following command:</p>
<pre><code>VOLUME /var/lib/mysql
</code></pre>
<p>which means all mysql data goes to volume. From <a href="https://docs.docker.com/engine/tutorials/dockervolumes/">docker volume docs</a> they specially mentioned that:</p>
<pre><code>&gt; Changes to a data volume will not be included when you update an image.
</code></pre>
<p>And this is the root cause you loss your data in newly started container.</p>
<p>For your question:</p>
<blockquote>
<p>How to achieve this?</p>
</blockquote>
<p>You can use either <a href="https://docs.docker.com/engine/tutorials/dockervolumes/#mount-a-host-directory-as-a-data-volume">mounted volumes</a>, or create a <a href="https://docs.docker.com/engine/tutorials/dockervolumes/#creating-and-mounting-a-data-volume-container">data volume container</a>, then run mysql container with option <code>--volumes-from</code>. The former links contain step-by-step guide of how to do it.</p>
<blockquote>
<p>I don't want to use mounted volumes because i want to link this container with another container of my application so that it can inset and update into db</p>
</blockquote>
<p>I don't know what other concerns you have about mounted volumes, but as far as I can tell, using mounted volumes does not prevent you to link containers.</p>
<p>Hope this helps you.</p>
</blockquote>
</blockquote>
<h2 id="å››-å¦‚æœä¸æ…ä¸¢å¤±æ€ä¹ˆæ¢å¤">å››ã€å¦‚æœä¸æ…ä¸¢å¤±ï¼Œæ€ä¹ˆæ¢å¤</h2>
<p>å¦‚æœæ•°æ®å·éƒ½åˆ é™¤äº† docker rm å®¹å™¨çš„æ—¶å€™ æ·»åŠ äº† -v æˆ– -volumeï¼Œé‚£å°±æ‹œæ‹œï¼Œæ²¡æœ‰ä»»ä½•åŠæ³•çš„ã€‚å¦‚æœæ²¡æœ‰åˆ é™¤volume å‚è€ƒï¼š</p>
<p><a href="https://www.primozker.in/post/saving-lost-data-docker/">Saving 'lost' MYSQL database running in Docker</a></p>
<p>æ›´å¤šå¯ä»¥çœ‹<a href="https://docs.docker.com/storage/volumes/">å®˜æ–¹æ–‡æ¡£</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ è§£å†³ sitemap robots.txt ä»¥åŠæäº¤google index]]></title>
        <id>https://dzkjz.github.io/post/jie-jue-sitemap-robotstxt-yi-ji-ti-jiao-google-index/</id>
        <link href="https://dzkjz.github.io/post/jie-jue-sitemap-robotstxt-yi-ji-ti-jiao-google-index/">
        </link>
        <updated>2020-07-26T12:48:03.000Z</updated>
        <content type="html"><![CDATA[<h2 id="sitemap"><a href="#https://www.npmjs.com/package/@nuxtjs/sitemap">Sitemap</a></h2>
<p>åœ¨nuxt appé‡Œé¢æ‰§è¡Œ</p>
<pre><code class="language-powershell">npm install @nuxtjs/sitemap
</code></pre>
<pre><code class="language-js">//nuxt.config.js
  modules: [
    // Doc: https://axios.nuxtjs.org/usage
    '@nuxtjs/axios',
    '@nuxtjs/auth',
    'vue-social-sharing/nuxt',
    // Doc: https://github.com/nuxt-community/dotenv-module
    '@nuxtjs/dotenv',
    'cookie-universal-nuxt',//https://www.npmjs.com/package/cookie-universal-nuxt
    '@nuxtjs/sitemap',
  ],

  sitemap: {
    //https://www.npmjs.com/package/@nuxtjs/sitemap
    hostname: 'https://' + process.env.DOMAIN_NAME,
    gzip: true,
    exclude: [
      '/verify/**',
      '/verifynew/**',
      '/password_reset/**',
      '/dashboard_reset/**',
      '/animals/create/**',
    ],
</code></pre>
<p>å…·ä½“é…ç½®<a href="#https://www.npmjs.com/package/@nuxtjs/sitemap">å®˜æ–¹æ–‡æ¡£</a>æœ‰è®²ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹åªæœ‰staticé¡µé¢ä¼šè‡ªåŠ¨æ·»åŠ ï¼Œå¯¹äºåŠ¨æ€çš„è·¯ç”±é¡µé¢ï¼Œ<code>parent/:children</code>ï¼Œè¿™æ ·çš„ï¼Œå‚è€ƒ <a href="#https://elision.design/en/blog/dynamic-routes-in-sitemap-with-nuxt-js">HOW TO: Include dynamic routes in sitemap with Nuxt.js</a></p>
<h2 id="robottxt"><a href="#https://www.npmjs.com/package/@nuxtjs/robots">Robot.txt</a></h2>
<p><code>npm install @nuxtjs/robots</code></p>
<pre><code class="language-js">//nuxt.config.js
  modules: [
    // Doc: https://axios.nuxtjs.org/usage
    '@nuxtjs/axios',
    '@nuxtjs/auth',
    'vue-social-sharing/nuxt',
    // Doc: https://github.com/nuxt-community/dotenv-module
    '@nuxtjs/dotenv',
    'cookie-universal-nuxt',//https://www.npmjs.com/package/cookie-universal-nuxt
    '@nuxtjs/sitemap',
    '@nuxtjs/robots',
  ],
        robots: [ //https://www.npmjs.com/package/@nuxtjs/robots
    {
      // UserAgent: 'Googlebot',
      UserAgent: '*',
      Disallow: () =&gt; [
        '/verify',
        '/verify',
        '/verifynew',
        '/password_reset',
        '/dashboard_reset',
        '/animals/create',
      ], // accepts function
      Sitemap: 'https://' + process.env.DOMAIN_NAME + '/sitemap.xml',
    }
  ],
</code></pre>
<p>å…·ä½“é…ç½®ä»‹ç»å‚è€ƒ<a href="#https://www.npmjs.com/package/@nuxtjs/robots">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
<h2 id="ask-google-to-recrawl-your-urls"><a href="https://support.google.com/webmasters/answer/6065812">Ask Google to recrawl your URLs</a></h2>
<p>Submit a sitemap (many URLs at once)</p>
<p>A sitemap is an important way for Google to discover URLs on your site. A sitemap can also include additional metadata about alternate language versions and video-, image-, or news-specific pages. <a href="https://support.google.com/webmasters/answer/156184">Learn how to create a sitemap.</a></p>
<p>If you have not changed your sitemap since the last time Google crawled it, resubmitting the sitemap won't have any additional benefit. If you have updated pages in the sitemap, mark them with <code>&lt;lastmod&gt;</code>.</p>
<p>Here are the different ways that you can alert Google about your sitemap:</p>
<ul>
<li><strong>Submit a sitemap using the <a href="https://support.google.com/webmasters/answer/7451001">sitemaps report</a>.</strong></li>
<li><strong>Use the ping tool.</strong> Send a GET request in your browser or the command line to this address, specifying the full URL of the sitemap. Be sure that the sitemap file is accessible:<br>
<code>http://www.google.com/ping?sitemap=*&lt;full_URL_of_sitemap&gt;*</code><br>
<strong>Example:</strong><br>
<code>http://www.google.com/ping?sitemap=https://example.com/sitemap.xml</code></li>
<li><strong>Insert the following line anywhere in your <code>robots.txt</code> file</strong>, specifying the path to your sitemap. We will find it the next time we crawl your site:<br>
<code>Sitemap: http://example.com/my_sitemap.xml</code></li>
</ul>
<h2 id="nuxté¡µé¢è·³è½¬è¿‡åº¦åŠ¨æ•ˆ">Nuxté¡µé¢è·³è½¬è¿‡åº¦åŠ¨æ•ˆ</h2>
<pre><code class="language-css">/*assets/styles/main.css*/
/*@import '@vue-cookie-accept-decline.css';*/

.page-enter-active, .page-leave-active {
  transition: opacity .5s;
}

.page-enter, .page-leave-to {
  opacity: 0;
}
</code></pre>
<pre><code class="language-js">//nuxt.config.js 
css: [
      ...
    '@/assets/styles/main.css',
      ...
  ],
</code></pre>
<p>å®˜æ–¹æ–‡æ¡£ï¼š</p>
<p>https://nuxtjs.org/api/configuration-loading</p>
<p>https://nuxtjs.org/api/pages-transition</p>
<pre><code class="language-js">//nuxt.config.js
loading: {
    color: 'orange',
    height: '5px',
    failedColor: 'red',
    duration: 5000,
    continuous: true,
  },
</code></pre>
<p>è‡ªå®šä¹‰çš„å¯ä»¥å‚è€ƒ <a href="#https://nuxtjs.org/api/configuration-loading#using-a-custom-loading-component">ä½¿ç”¨è‡ªå®šä¹‰çš„ç»„ä»¶è®¾ç½®åŠ è½½æ ·å¼</a></p>
<h2 id="æ”¹å˜favicon">æ”¹å˜Favicon</h2>
<p>å‚è€ƒ https://github.com/nuxt/nuxt.js/issues/903</p>
<pre><code class="language-js">//nuxt.config.js
link: [
      {rel: 'icon', type: 'image/x-icon', href: '/tiere_favi.png'},
    ]
</code></pre>
<p><a href="#https://nuxtjs.org/guide/assets/">å®˜æ–¹æ–‡æ¡£</a>ä¹Ÿå¯ä»¥çœ‹çœ‹</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ã€Œè¸©å‘è®°å½•ã€ Nuxt.js & Ant-design-vue é…ç½®]]></title>
        <id>https://dzkjz.github.io/post/cai-keng-ji-lu-nuxtjs-and-ant-design-vue-pei-zhi/</id>
        <link href="https://dzkjz.github.io/post/cai-keng-ji-lu-nuxtjs-and-ant-design-vue-pei-zhi/">
        </link>
        <updated>2020-07-25T06:42:01.000Z</updated>
        <content type="html"><![CDATA[<h1 id="nuxtjs-ant-design-vue">Nuxt.js &amp; ant-design-vue</h1>
<p>æœ€è¿‘å¼€å‘ä¸€ä¸ªå¸¦seoä»¥åŠéƒ¨åˆ†åå°åŠŸèƒ½çš„é¡¹ç›®ï¼Œnuxtä½œä¸ºvue ssræ¡†æ¶å¯ä»¥éå¸¸å¥½çš„å®Œæˆè¿™ä¸ªéœ€æ±‚ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©äº†<code>ant-design-vue</code>ä½œä¸ºUIç»„ä»¶åº“ã€‚</p>
<p>ä»¥ä¸‹æ˜¯è¸©å‘çš„ä¸€äº›è®°å½• ï¼š</p>
<p>é¦–å…ˆä»‹ç»ä¸€ä¸‹é¡¹ç›®æƒ…å†µå’Œéœ€æ±‚ï¼š</p>
<ul>
<li>Nuxt.jsæ˜¯ä¸€ä¸ª Vue.js é€šç”¨æ¡†æ¶ï¼Œé¢„è®¾äº†ä½¿ç”¨ Vue.jså¼€å‘SSRçš„å„ç§é…ç½®ã€‚é¡¹ç›®ä¸­ä½¿ç”¨çš„æ˜¯SSRæ¨¡å¼ï¼Œå› æ­¤é¦–å±æ˜¯ç”±<strong>æœåŠ¡ç«¯å®Œæˆæ¸²æŸ“</strong>ã€‚</li>
<li>é¡¹ç›®ä»…ç”¨åˆ°å°‘æ•°çš„UIç»„ä»¶ï¼Œå› æ­¤æˆ‘ä»¬å¸Œæœ›ä½¿ç”¨æŒ‰éœ€åŠ è½½ç»„ä»¶ï¼Œä»¥å‡å°‘ç½‘ç»œå¼€é”€ã€‚</li>
</ul>
<h2 id="1-æŒ‰éœ€åŠ è½½å¼•å…¥ç»„ä»¶">1. æŒ‰éœ€åŠ è½½å¼•å…¥ç»„ä»¶</h2>
<p>é¦–å…ˆæˆ‘ä»¬ç§»é™¤æ‰ nuxt.config.js ä¸­</p>
<pre><code class="language-js">{   css: ['ant-design-vue/dist/antd.css'],   // è¿™é‡Œä¼šå…¨å±€å¼•å…¥æ‰€æœ‰æ ·å¼ï¼Œä¸æ˜¯æˆ‘ä»¬æ‰€å¸Œæœ›çš„æŒ‰éœ€åŠ è½½ }
</code></pre>
<p>å‚è€ƒå®˜æ–¹æ–‡æ¡£antd-vue # æŒ‰éœ€åŠ è½½ï¼š</p>
<pre><code class="language-js">// åŒæ—¶å‚è€ƒ Nuxt-cli åˆ›å»ºé¡¹ç›®æ—¶ åˆ›å»ºçš„ plugin/antd-ui.js 
import Vue from 'vue' import Button from 'ant-design-vue/lib/button'; 
import 'ant-design-vue/lib/button/style'; // æˆ–è€… ant-design-vue/lib/button/style/css åŠ è½½ css æ–‡ä»¶  
Vue.use(Button.name, Button)
</code></pre>
<p>ç¼–è¯‘æœªé€šè¿‡ï¼Œæç¤ºé”™è¯¯ï¼š</p>
<pre><code class="language-shell">// https://github.com/ant-design/ant-motion/issues/44 .bezierEasingMixin(); ^ Inline JavaScript is not enabled. Is it set in your options?
</code></pre>
<p>æ ¹æ®æŠ¥é”™æ‰€æä¾›çš„ä¿¡æ¯ï¼Œlesså‡çº§åˆ°3.0 åï¼Œéœ€è¦ less-loaderé…ç½®ä¸€ä¸ªåŠŸèƒ½ï¼Œæ‰èƒ½æ­£å¸¸ä½¿ç”¨ï¼š</p>
<pre><code class="language-js">// nuxt.config.js 
{  
    build: {   
        loaders: {    
            less: {     
                javascriptEnabled: true    
            }   
        }  
    } 
}
</code></pre>
<p>ç¼–è¯‘é€šè¿‡ï¼Œæ‰“å¼€é¡µé¢ï¼Œè¿”å›500ï¼Œæç¤ºï¼š</p>
<figure data-type="image" tabindex="1"><img src="https://i0.wp.com/upload-images.jianshu.io/upload_images/4655331-6b7d1982b438ab82.png" alt="img" loading="lazy"></figure>
<p>image.png</p>
<p>ç¼–è¯‘èƒ½é€šè¿‡ï¼Œè¯´æ˜ä»£ç ç¼–è¯‘æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯serverç«¯æ‰§è¡Œæ—¶å‡ºç°äº†é”™è¯¯ã€‚å°è¯•æ³¨é‡Šæ‰plugin/antd-ui.jså¼•å…¥æ ·å¼æ–‡ä»¶è¿™è¡Œ import 'ant-design-vue/lib/button/style'; ï¼Œserveré¦–å±æ¸²æŸ“èƒ½å¤Ÿæ­£å¸¸å¯åŠ¨ï¼Œä½†å¼•å…¥çš„buttonç»„ä»¶æ ·å¼ä¸¢å¤±ã€‚</p>
<p>æ‰“å¼€ ant-design-vue/lib/button/style/index.js æŸ¥çœ‹ï¼š</p>
<pre><code class="language-js">'use strict'; 
require('../../style/index.less'); 
require('./index.less');  
// ant-design-vue/es/button/style/index.js 
import '../../style/index.less'; 
import './index.less';
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œantd-vueä¸ºç”Ÿäº§ç¯å¢ƒæä¾›äº†ä¸¤ç§æ¨¡å—çš„ä»£ç ã€‚ä¸ºäº†tree-shaking æˆ‘ä»¬ä¼˜å…ˆé€‰æ‹© es æ¨¡å—ã€‚</p>
<blockquote>
<p>è¡¥å……çŸ¥è¯†ï¼šç°åœ¨çš„webpack@4+ æ”¯æŒè¯†åˆ«é¡¹ç›® packge.json moduleå­—æ®µï¼Œä½¿ç”¨ESModuleçš„ä¾èµ–æ›´å¥½çš„æ”¯æŒæ„å»ºä¸­çš„tree-shakingã€‚</p>
</blockquote>
<p>ä¿®æ”¹ä»£ç ä¸º es/button/...ï¼Œç¼–è¯‘é€šè¿‡ï¼Œä½†é¡µé¢ä»æŠ›å‡ºä¸€500æœåŠ¡ç«¯é”™è¯¯ï¼š</p>
<figure data-type="image" tabindex="2"><img src="https://i0.wp.com/upload-images.jianshu.io/upload_images/4655331-ae7c35452bf86a74.png" alt="img" loading="lazy"></figure>
<p>image.png</p>
<p>æ ¹æ®é”™è¯¯æç¤ºcannot use import statementå’ŒesåŒ…ä½¿ç”¨çš„ESModuleè¯­æ³•ï¼ŒçŒœæµ‹æœåŠ¡ç«¯ä¾§æ¸²æŸ“é¡µé¢æ—¶è¯­æ³•å‡ºé”™ï¼ŒNode.js ä¸èƒ½ç›´æ¥è¯†åˆ« .jsæ–‡ä»¶å†…çš„ESModuleè¯­æ³•ã€‚</p>
<pre><code class="language-js">// .nuxt.config.js 
{  
    plugins: 
    [   
        {    
            src: '@/plugins/antd-ui',    
            mode: 'client' // ä»… å®¢æˆ·ç«¯ä½¿ç”¨plugin   
        }  
    ] 
}
</code></pre>
<p>é¡µé¢æ­£å¸¸åŠ è½½ï¼Œä½†Vue.js ç»™å‡ºäº†é”™è¯¯æç¤º</p>
<figure data-type="image" tabindex="3"><img src="https://i0.wp.com/upload-images.jianshu.io/upload_images/4655331-e03fb922189d9a8c.png" alt="img" loading="lazy"></figure>
<p>image.png</p>
<p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å†å°†pluginä»£ç æ›¿æ¢å›libä»¥åŠç§»é™¤mode: 'client ï¼Œé”™è¯¯åˆå›åˆ°äº†æœ€å¼€å§‹çš„ invalid or unexpected tokenã€‚</p>
<p>æœç´¢Nuxtå®˜æ–¹æ–‡æ¡£ï¼š</p>
<blockquote>
<p>å¦‚æœè¦ä½¿ç”¨Babelä¸ç‰¹å®šçš„ä¾èµ–å…³ç³»è¿›è¡Œè½¬æ¢ï¼Œä½ å¯ä»¥åœ¨build.transpileä¸­æ·»åŠ å®ƒä»¬ï¼Œtranspileä¸­çš„é€‰é¡¹å¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ–æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡ï¼Œç”¨äºåŒ¹é…ä¾èµ–é¡¹æ–‡ä»¶åã€‚</p>
</blockquote>
<p>æ·»åŠ é…ç½®ï¼š</p>
<pre><code class="language-js">{ // nuxt.config.js  
    build: {   
        transpile: [/ant-design-vue/]
    } 
}
</code></pre>
<p>ç»ˆäºï¼ŒæœåŠ¡ç«¯æ¸²æŸ“æ­£å¸¸ï¼Œæ ·å¼ä¹Ÿæ­£å¸¸åŠ è½½ã€‚æ¥ç€å¼•å…¥ ant-design-vueå®˜æ–¹æ¨èä½¿ç”¨çš„æ’ä»¶babel-plugin-import</p>
<pre><code class="language-js">// nuxt.config.js 
{  
    build: {
        babel: {
            plugins: [
                [      
                    'import',      
                    {       
                        libraryName: 'ant-design-vue',       
                        libraryDirectory: 'es',       
                        // é€‰æ‹©å­ç›®å½• ä¾‹å¦‚ es è¡¨ç¤º ant-design-vue/es/component       
                        // lib è¡¨ç¤º ant-design-vue/lib/component              
                        style: true       
                        // é»˜è®¤ä¸ä½¿ç”¨è¯¥é€‰é¡¹ï¼Œå³ä¸å¯¼å…¥æ ·å¼ , æ³¨æ„ ant-design-vue ä½¿ç”¨ js æ–‡ä»¶å¼•å…¥æ ·å¼       
                        // true è¡¨ç¤º import  'ant-design-vue/es/component/style'      
                        // 'css' è¡¨ç¤º import 'ant-design-vue/es/component/style/css'      
                    }     
                ]    
            ]   
        }  
    } 
}  // plugins/antd-ui.js 
import Vue from 'vue' 
import { Button } from 'ant-dsign-vue' // è¿™æ—¶ï¼Œå¯ä»¥é€šè¿‡ ç®€å†™çš„æ–¹å¼å¼•å…¥æ ·å¼å’Œç»„ä»¶  
Vue.use(Button)
</code></pre>
<h2 id="2-pagesç›®å½•å†…å¼•å…¥ç»„ä»¶">2. pagesç›®å½•å†…å¼•å…¥ç»„ä»¶</h2>
<figure data-type="image" tabindex="4"><img src="https://i0.wp.com/upload-images.jianshu.io/upload_images/4655331-8123f1ba7bbc27a8.gif" alt="img" loading="lazy"></figure>
<p>flash.gif</p>
<p>ä¸Šå›¾æ˜¯åœ¨pages/index.vueå†…å¼•å…¥ç»„ä»¶ï¼Œnpm run build &amp;&amp; npm run start æ‰§è¡Œåçš„çº¿ä¸Šç¯å¢ƒï¼Œå¯ä»¥çœ‹åˆ°æ ·å¼åœ¨åˆ·æ–°é¦–å±æ—¶ï¼Œä¼šçœ‹åˆ°é—ªçƒçš„ç°è±¡ï¼Œè¿™é‡Œå‡ºç°çš„é—®é¢˜åœ¨äºå…¥å£æ–‡ä»¶å¹¶ä¸åŒ…å«ç»„ä»¶ï¼Œè€Œæ˜¯å¼‚æ­¥å¼•å…¥çš„ï¼Œä»ç¼–è¯‘ç»“æœä¸Šä¹Ÿå¯ä»¥çœ‹åˆ° 610kb çš„åŒ…å¯¹åº”çš„chunk vendors.pages/index ï¼Œå¹¶ä¸åœ¨entrypointå†…ï¼Œé»˜è®¤æƒ…å†µä¸‹Nuxt.js è·¯ç”±é¡µé¢å·²ç»è¢«åˆ†é…ä¸ºdynamic importï¼ŒåŒæ—¶styleæ˜¯é€šè¿‡jsè®¾ç½®åˆ°styleä¸Šçš„ï¼Œè€Œä¸æ˜¯å•ç‹¬æ‰“åŒ…å‡ºæ¥ã€‚ç»è¿‡æµ‹è¯•ï¼Œcsså•ç‹¬æ‰“åŒ…åï¼ŒUIç»„ä»¶ä»æ˜¯å•ç‹¬åˆ†åŒ…ï¼Œå³ä¾¿æ˜¯å•ç‹¬æ‰“åŒ…å‡ºæ¥ï¼Œä¾ç„¶ä¼šæœ‰æŒ‰éœ€åŠ è½½çš„é—®é¢˜ï¼Œé¦–å±ä»ä¼šé—ªçƒã€‚</p>
<figure data-type="image" tabindex="5"><img src="https://i0.wp.com/upload-images.jianshu.io/upload_images/4655331-1dd3852daa2d8ff2.png" alt="img" loading="lazy"></figure>
<p>build result</p>
<p>å› æ­¤ï¼Œå¦‚æœç»„ä»¶è¢«å¤§å¤šæ•°é¡µé¢ä½¿ç”¨ï¼Œæ¨èåœ¨ pluginå†…æ³¨å†Œï¼Œæˆ–è€…é€šè¿‡ nuxt.config.jsçš„cssç›¸å…³æ–‡ä»¶ç›´æ¥å¼•å…¥å¯¹åº”çš„ç»„ä»¶æ ·å¼ï¼ŒåŒæ—¶å…³é—­babel-import-plugin çš„ styleé€‰é¡¹ã€‚ (åæ§½ä¸€å¥ï¼ŒiViewåªèƒ½å¼•å…¥å•ä¸€å…¨å±€æ ·å¼ï¼Œä¸èƒ½æŒ‰éœ€åŠ è½½æ ·å¼ï¼Œ1.5mçš„å¤§å°éå¸¸ææ€–)</p>
<p>é™¤æ­¤ä»¥å¤–ï¼Œå¯ä»¥è€ƒè™‘é…ç½®webpackçš„splitchunksé…ç½®ï¼Œå®ç°è‡ªå·±çš„éœ€æ±‚ã€‚</p>
<h2 id="3-è§£å†³antd-icon-è¿‡å¤§ä¼ ç»Ÿè‰ºèƒ½">3. è§£å†³antd-icon è¿‡å¤§ï¼ˆä¼ ç»Ÿè‰ºèƒ½</h2>
<p>å‰é¢ç”Ÿäº§ç¯å¢ƒçš„åŒ…å¯ä»¥å‘ç°ï¼Œåªä½¿ç”¨äº†ä¸€ä¸ªButtonï¼Œå´æ‰“åŒ…äº†600kbçš„ä¾èµ–ï¼Œæ£€æŸ¥åå‘ç°æ˜¯å¼•å…¥äº†@ant-design/icon åŒ…ã€‚</p>
<p>å‚è€ƒï¼š https://github.com/HeskeyBaozi/reduce-antd-icons-bundle-demo</p>
<pre><code class="language-js">{ // nuxt.config.js  
    build: 
    {   
        extend(config, ctx) {
            config.resolve.alias['@ant-design/icons/lib/dist$'] = path.resolve(__dirname, './assets/icon/antd-icon.js') // å¼•å…¥éœ€è¦çš„  
        }  
    } 
}
</code></pre>
<h2 id="é¢˜å¤–è¯">é¢˜å¤–è¯</h2>
<p><strong>â€œæŒ‰éœ€å¼•å…¥â€</strong></p>
<figure data-type="image" tabindex="6"><img src="https://i0.wp.com/upload-images.jianshu.io/upload_images/4655331-2faf55ca3844885e.png" alt="img" loading="lazy"></figure>
<p>image.png</p>
<p>https://github.com/ant-design/babel-plugin-import/issues/347</p>
<h2 id="reference">reference</h2>
<p>https://github.com/vueComponent/ant-design-vue/issues/234<br>
https://www.zhihu.com/question/265227812</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[æ€»ç»“nuxt laravel nginx mysql docker ubuntuéƒ¨ç½²çš„æµç¨‹]]></title>
        <id>https://dzkjz.github.io/post/zong-jie-nuxt-laravel-nginx-mysql-docker-ubuntu-bu-shu-de-liu-cheng/</id>
        <link href="https://dzkjz.github.io/post/zong-jie-nuxt-laravel-nginx-mysql-docker-ubuntu-bu-shu-de-liu-cheng/">
        </link>
        <updated>2020-07-19T06:40:35.000Z</updated>
        <content type="html"><![CDATA[<h2 id="ä¸€-docker">ä¸€ã€Docker</h2>
<p>ä»€ä¹ˆæ˜¯dockerå¯ä»¥å‚è€ƒ:<a href="https://yeasy.gitbook.io/docker_practice/introduction/what">ä»€ä¹ˆæ˜¯ Docker</a></p>
<p>åœ¨è¿›è¡Œä¸‹é¢çš„æ“ä½œä¹‹å‰ï¼Œè¯·å…ˆ<a href="https://yeasy.gitbook.io/docker_practice/install">å®‰è£…Docker </a></p>
<p>é’ˆå¯¹è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯ï¼š</p>
<ol>
<li>ä¸€ä¸ªå®¹å™¨è¿è¡Œnginx</li>
<li>ä¸€ä¸ªå®¹å™¨è¿è¡Œphp-fpm</li>
<li>ä¸€ä¸ªå®¹å™¨è¿è¡Œmysql</li>
<li>ä¸€ä¸ªå®¹å™¨è¿è¡Œnode</li>
</ol>
<p>å››ä¸ªå®¹å™¨ï¼š</p>
<ul>
<li>
<p>nginxå’Œmysqlå®¹å™¨å¯ä»¥ç›´æ¥ç”¨å®˜æ–¹çš„é•œåƒã€‚<em>æ‰€ä»¥è¿™ä¸¤ä¸ªå®¹å™¨ä¸éœ€è¦Dockerfile</em>ï¼›</p>
</li>
<li>
<p>php-fpmå®¹å™¨ ä¸»è¦æ˜¯è¿è¡Œ laravelï¼›</p>
</li>
<li>
<p>å¦å¤–éœ€è¦ä¸€ä¸ªä¸´æ—¶å®¹å™¨ç»™å®‰è£…composerï¼Œå®‰è£…å®Œæˆååˆ é™¤è¿™ä¸ªä¸´æ—¶å®¹å™¨å°±è¡Œï¼›</p>
</li>
<li>
<p>nodeå®¹å™¨ç”¨äºè¿è¡Œnuxtã€‚</p>
</li>
</ul>
<p>php-fpmå®¹å™¨æˆ‘ä»¬éœ€è¦å®‰è£…ä¸€äº›æ‰©å±•åŒ…ï¼Œæ‰§è¡Œcomposerå®‰è£…ï¼Œæ‰€ä»¥ç”¨Dockerfileé…ç½®ï¼š</p>
<p>æ›´å¤šDockerfileé…ç½®çš„æŒ‡ä»¤ä»‹ç»å‚è€ƒï¼š<a href="https://yeasy.gitbook.io/docker_practice/image/build">ä½¿ç”¨ Dockerfile å®šåˆ¶é•œåƒ</a></p>
<p>è¯·æ³¨æ„æ•™ç¨‹ä¸­çš„</p>
<blockquote>
<p>æ­¤å¤–ï¼Œè¿˜å¯ä»¥çœ‹åˆ°è¿™ä¸€ç»„å‘½ä»¤çš„æœ€åæ·»åŠ äº†æ¸…ç†å·¥ä½œçš„å‘½ä»¤ï¼Œåˆ é™¤äº†ä¸ºäº†ç¼–è¯‘æ„å»ºæ‰€éœ€è¦çš„è½¯ä»¶ï¼Œæ¸…ç†äº†æ‰€æœ‰ä¸‹è½½ã€å±•å¼€çš„æ–‡ä»¶ï¼Œå¹¶ä¸”è¿˜æ¸…ç†äº† <code>apt</code> ç¼“å­˜æ–‡ä»¶ã€‚è¿™æ˜¯å¾ˆé‡è¦çš„ä¸€æ­¥ï¼Œæˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼Œé•œåƒæ˜¯å¤šå±‚å­˜å‚¨ï¼Œæ¯ä¸€å±‚çš„ä¸œè¥¿å¹¶ä¸ä¼šåœ¨ä¸‹ä¸€å±‚è¢«åˆ é™¤ï¼Œä¼šä¸€ç›´è·Ÿéšç€é•œåƒã€‚å› æ­¤é•œåƒæ„å»ºæ—¶ï¼Œä¸€å®šè¦ç¡®ä¿æ¯ä¸€å±‚åªæ·»åŠ çœŸæ­£éœ€è¦æ·»åŠ çš„ä¸œè¥¿ï¼Œä»»ä½•æ— å…³çš„ä¸œè¥¿éƒ½åº”è¯¥æ¸…ç†æ‰ã€‚</p>
<p><strong>å¾ˆå¤šäººåˆå­¦ Docker åˆ¶ä½œå‡ºäº†å¾ˆè‡ƒè‚¿çš„é•œåƒçš„åŸå› ä¹‹ä¸€ï¼Œå°±æ˜¯å¿˜è®°äº†æ¯ä¸€å±‚æ„å»ºçš„æœ€åä¸€å®šè¦æ¸…ç†æ‰æ— å…³æ–‡ä»¶ã€‚</strong></p>
</blockquote>
<p>ä»¥åŠå¯¹è·¯å¾„ä¸Šä¸‹æ–‡çš„è§£é‡Š</p>
<blockquote>
<h3 id="é•œåƒæ„å»ºä¸Šä¸‹æ–‡context"><a href="https://yeasy.gitbook.io/docker_practice/image/build#jing-xiang-gou-jian-shang-xia-wen-context">é•œåƒæ„å»ºä¸Šä¸‹æ–‡ï¼ˆContextï¼‰</a></h3>
<p>è¿™ä¸ªä¹Ÿæ˜¯å¾ˆå¥‡è‘©çš„ï¼Œåˆå­¦çš„æ—¶å€™ï¼Œæ˜¯å•çº¯çš„è®¤ä¸º ä¸‹é¢è¿™ä¸ªå‘½ä»¤</p>
<p>COPY ./somefiles /var/www</p>
<p>å°±æ˜¯å¤åˆ¶Dockerfileæ‰€åœ¨çš„æ–‡ä»¶å¤¹ä¸‹somefilesæ–‡ä»¶å¤¹åŠå…¶å†…éƒ¨æ–‡ä»¶åˆ° æ­¤é•œåƒæ„å»ºçš„å®¹å™¨å†…çš„ /var/wwwç›®å½•é‡Œã€‚</p>
<p>ä½†æ˜¯è¿™ä¹ˆç†è§£ä¼šå‡ºé—®é¢˜ï¼Œé¦–å…ˆï¼Œå¯ä»¥ç”¨~/sub/fab/docker/somotherfiles/ è¿™ä¹ˆæŒ‡å®šå®¿ä¸»æœºæ–‡ä»¶å¤¹è·¯å¾„å—ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯ä¸è¡Œçš„ã€‚ä¼šæŠ¥é”™æ‰¾ä¸åˆ°ã€‚</p>
<p>ç„¶åï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ ../this/somefiles/æŒ‡å®šå®¿ä¸»æœºæ–‡ä»¶å¤¹è·¯å¾„å—ï¼Ÿ</p>
<p>ç­”æ¡ˆä¹Ÿæ˜¯ä¸è¡Œçš„ï¼Œä¹Ÿæ˜¯æŠ¥é”™æ‰¾ä¸åˆ°ã€‚</p>
<p>å…·ä½“æ¶‰åŠåˆ°çš„æ˜¯ Docker å¼•æ“ï¼Œå…·ä½“çœ‹æ•™ç¨‹è§£é‡Šï¼Œä¸è¿‡å¯ä»¥ç®€å•çš„è¿™ä¹ˆè¯´ï¼Œå°±æ˜¯æ„å»ºçš„æ—¶å€™ï¼Œåªæ‰“åŒ…dockerfileæ–‡ä»¶è·¯å¾„ä¸‹çš„<strong>æ‰€æœ‰å†…å®¹</strong>ä¼ åˆ°dockerå¼•æ“ï¼Œæ‰€ä»¥æ˜¯ä¸åŒ…å«å¤–éƒ¨çš„ä»¥åŠå¯ä»¥ç”¨~æŒ‡å®šçš„è·¯å¾„ä¸‹çš„ã€‚åŒæ—¶ä¹Ÿè¦æ³¨æ„ï¼Œè¿™ä¸ªdockerfileæ–‡ä»¶æ‰“åŒ…çš„æ‰€æœ‰å†…å®¹å¦‚æœä½ ç»™çš„æ–‡ä»¶å¤ªå¤§äº†ï¼Œé‚£ä¼ è¾“èµ·æ¥å°±ç‰›äº†ï¼Œæœ‰çš„å‡ åä¸ªGB ä¼ è¾“å¾ˆå¤´ç–¼çš„ï¼Œæ‰€ä»¥éœ€è¦æ³¨æ„ï¼Œdockerfileæ‰€åœ¨æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶å†…å®¹ï¼Œåªç•™ä¸‹éœ€è¦çš„ã€‚</p>
<p>è¿˜æœ‰ä¸Šé¢æ˜¯ç¬¼ç»Ÿçš„è¯´æˆæ˜¯dockerfileæ–‡ä»¶æ‰€åœ¨æ–‡ä»¶å¤¹ï¼Œå…¶å®ä¹Ÿæ˜¯ä¸å®Œå…¨æ­£ç¡®çš„ã€‚</p>
<p>å› ä¸ºå¯ä»¥ -f ../Dockerfilev3 è¿™ä¹ˆæŒ‡å®šéœ€è¦çš„Dockerfile é¦–å…ˆè·¯å¾„åœ¨å¤–é¢ï¼Œç„¶ååå­—ä¹Ÿä¸åŒï¼Œä¸è¿‡ä¸€èˆ¬æƒ…å†µä¸è¿™ä¹ˆå¹²ã€‚é»˜è®¤çŠ¶æ€ä¸‹å‰é¢è¯´çš„ä¸ä¸¥è°¨ä½†ä¹Ÿå¯ä»¥æ˜¯å¯¹çš„ã€‚è¿˜æœ‰<a href="https://yeasy.gitbook.io/docker_practice/image/build#qi-ta-docker-build-de-yong-fa">å…¶å®ƒ <code>docker build</code> çš„ç”¨æ³•ã€‚</a></p>
</blockquote>
<h5 id="app-å®¹å™¨-dockerfile">app å®¹å™¨ Dockerfile</h5>
<pre><code class="language-yml">FROM php:7.2.19-fpm #æŒ‡å®š åŸºç¡€é•œåƒ

# Arguments defined in docker-compose.yml
ARG user #å®šä¹‰å‚æ•°
ARG uid  #å®šä¹‰å‚æ•°

# Install system dependencies å®‰è£…ç³»ç»Ÿä¾èµ– #RUN æŒ‡ä»¤æ˜¯ç”¨æ¥æ‰§è¡Œå‘½ä»¤è¡Œå‘½ä»¤çš„
# Dockerfile æ”¯æŒ Shell ç±»çš„è¡Œå°¾æ·»åŠ  \ çš„å‘½ä»¤æ¢è¡Œæ–¹å¼ï¼Œä»¥åŠè¡Œé¦– # è¿›è¡Œæ³¨é‡Šçš„æ ¼å¼
RUN apt-get update &amp;&amp; apt-get install -y \
    git \
    curl \
    libpng-dev \
    libonig-dev \
    libxml2-dev \
    zip \
    unzip


# Clear cache æ¸…ç†cache
RUN apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/* #ä½¿ç”¨ &amp;&amp; å°†å„ä¸ªæ‰€éœ€å‘½ä»¤ä¸²è”èµ·æ¥

# Install PHP extensions å®‰è£…æ‰©å±•
RUN docker-php-ext-install pdo_mysql mbstring exif pcntl bcmath gd

# Get latest Composer è¿™é‡Œæ˜¯æŠŠcomposerç»™å¤åˆ¶åˆ° æœ¬Dockerfileå®šä¹‰çš„å®¹å™¨çš„ /usr/bin/composeré‡Œ
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Create system user to run Composer and Artisan Commands
# åˆ›å»ºç³»ç»Ÿç”¨æˆ·ç”¨äºæ‰§è¡Œ composerå’Œ artisan å‘½ä»¤ å®é™…æ˜¯ç»™æƒé™ã€‚
RUN useradd -G www-data,root -u $uid -d /home/$user $user
RUN mkdir -p /home/$user/.composer &amp;&amp; \
    chown -R $user:$user /home/$user

# Set working directory æœ¬å®¹å™¨çš„å·¥ä½œæ–‡ä»¶å¤¹
WORKDIR /var/www

USER $user #è®¾ç½®å®¹å™¨çš„ç”¨æˆ·

</code></pre>
<blockquote>
<p>éœ€è¦äº†è§£æ›´å¤šæŒ‡ä»¤å¯ä»¥å‚è€ƒï¼š</p>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/copy">COPY å¤åˆ¶æ–‡ä»¶</a></p>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/add">ADD æ›´é«˜çº§çš„å¤åˆ¶æ–‡ä»¶</a></p>
<p>[Dockerfile æœ€ä½³å®è·µæ–‡æ¡£](Dockerfile æœ€ä½³å®è·µæ–‡æ¡£)</p>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/cmd">CMD å®¹å™¨å¯åŠ¨å‘½ä»¤</a></p>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/entrypoint">ENTRYPOINT å…¥å£ç‚¹</a></p>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/env">ENV è®¾ç½®ç¯å¢ƒå˜é‡</a></p>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/arg">ARG æ„å»ºå‚æ•°</a></p>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/volume">VOLUME å®šä¹‰åŒ¿åå·</a> ä¸Šé¢çš„dockerfileæ²¡æœ‰æŒ‚è½½æ•°æ®å·åˆ°å®¹å™¨å†…ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨docker-composeé‡ŒæŒ‚è½½äº†ï¼Œåé¢è®²ã€‚</p>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/expose">EXPOSE æš´éœ²ç«¯å£</a> <code>EXPOSE</code> æŒ‡ä»¤æ˜¯å£°æ˜è¿è¡Œæ—¶å®¹å™¨æä¾›æœåŠ¡ç«¯å£ï¼Œè¿™åªæ˜¯ä¸€ä¸ªå£°æ˜ï¼Œåœ¨è¿è¡Œæ—¶å¹¶ä¸ä¼šå› ä¸ºè¿™ä¸ªå£°æ˜åº”ç”¨å°±ä¼šå¼€å¯è¿™ä¸ªç«¯å£çš„æœåŠ¡ï¼Œ æ˜ç¡® -Péšæœºæ˜ å°„ç«¯å£æ—¶ä¼šæ˜ å°„åˆ°EXPOSEçš„ç«¯å£ï¼Œ-pæŒ‡å®šæ—¶ï¼Œæ˜¯æŒ‰-pæŒ‡å®šçš„æ¥ã€‚</p>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/workdir">WORKDIR æŒ‡å®šå·¥ä½œç›®å½•</a></p>
<p><strong>è¯·æ³¨æ„<code>Dockerfile</code> æ„å»ºåˆ†å±‚å­˜å‚¨çš„æ¦‚å¿µã€‚</strong></p>
<p>æ¯ä¸€ä¸ª <code>RUN</code> éƒ½æ˜¯å¯åŠ¨ä¸€ä¸ªå®¹å™¨ã€æ‰§è¡Œå‘½ä»¤ã€ç„¶åæäº¤å­˜å‚¨å±‚æ–‡ä»¶å˜æ›´ã€‚</p>
<blockquote>
<pre><code class="language-yml">RUN cd /app
RUN echo &quot;hello&quot; &gt; world.txt
</code></pre>
<p>å¦‚æœå°†è¿™ä¸ª <code>Dockerfile</code> è¿›è¡Œæ„å»ºé•œåƒè¿è¡Œåï¼Œä¼šå‘ç°æ‰¾ä¸åˆ° <code>/app/world.txt</code> æ–‡ä»¶ï¼Œæˆ–è€…å…¶å†…å®¹ä¸æ˜¯ <code>hello</code></p>
<p>ç¬¬ä¸€å±‚ <code>RUN cd /app</code> çš„æ‰§è¡Œä»…ä»…æ˜¯å½“å‰è¿›ç¨‹çš„å·¥ä½œç›®å½•å˜æ›´ï¼Œä¸€ä¸ªå†…å­˜ä¸Šçš„å˜åŒ–è€Œå·²ï¼Œå…¶ç»“æœä¸ä¼šé€ æˆä»»ä½•æ–‡ä»¶å˜æ›´ã€‚è€Œåˆ°ç¬¬äºŒå±‚çš„æ—¶å€™ï¼Œå¯åŠ¨çš„æ˜¯ä¸€ä¸ªå…¨æ–°çš„å®¹å™¨ï¼Œè·Ÿç¬¬ä¸€å±‚çš„å®¹å™¨æ›´å®Œå…¨æ²¡å…³ç³»ï¼Œè‡ªç„¶ä¸å¯èƒ½ç»§æ‰¿å‰ä¸€å±‚æ„å»ºè¿‡ç¨‹ä¸­çš„å†…å­˜å˜åŒ–ã€‚</p>
</blockquote>
<p>å› æ­¤å¦‚æœéœ€è¦æ”¹å˜ä»¥åå„å±‚çš„å·¥ä½œç›®å½•çš„ä½ç½®ï¼Œé‚£ä¹ˆåº”è¯¥ä½¿ç”¨ <code>WORKDIR</code> æŒ‡ä»¤ã€‚</p>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/user">USER æŒ‡å®šå½“å‰ç”¨æˆ·</a></p>
<blockquote>
<p><code>USER</code> æŒ‡ä»¤å’Œ <code>WORKDIR</code> ç›¸ä¼¼ï¼Œéƒ½æ˜¯æ”¹å˜ç¯å¢ƒçŠ¶æ€å¹¶å½±å“ä»¥åçš„å±‚ã€‚<code>WORKDIR</code> æ˜¯æ”¹å˜å·¥ä½œç›®å½•ï¼Œ<code>USER</code> åˆ™æ˜¯æ”¹å˜ä¹‹åå±‚çš„æ‰§è¡Œ <code>RUN</code>, <code>CMD</code> ä»¥åŠ <code>ENTRYPOINT</code> è¿™ç±»å‘½ä»¤çš„èº«ä»½ã€‚</p>
<p><code>USER</code> åªæ˜¯å¸®åŠ©ä½ åˆ‡æ¢åˆ°æŒ‡å®šç”¨æˆ·è€Œå·²ï¼Œè¿™ä¸ªç”¨æˆ·å¿…é¡»æ˜¯äº‹å…ˆå»ºç«‹å¥½çš„ï¼Œå¦åˆ™æ— æ³•åˆ‡æ¢ã€‚</p>
</blockquote>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/healthcheck">HEALTHCHECK å¥åº·æ£€æŸ¥</a></p>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/onbuild">ONBUILD ä¸ºä»–äººä½œå«è¡£è£³</a></p>
<blockquote>
<p><code>ONBUILD</code> æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æŒ‡ä»¤ï¼Œå®ƒåé¢è·Ÿçš„æ˜¯å…¶å®ƒæŒ‡ä»¤ï¼Œæ¯”å¦‚ <code>RUN</code>, <code>COPY</code> ç­‰ï¼Œè€Œè¿™äº›æŒ‡ä»¤ï¼Œåœ¨å½“å‰é•œåƒæ„å»ºæ—¶å¹¶ä¸ä¼šè¢«æ‰§è¡Œã€‚åªæœ‰å½“ä»¥å½“å‰é•œåƒä¸ºåŸºç¡€é•œåƒï¼Œå»æ„å»ºä¸‹ä¸€çº§é•œåƒçš„æ—¶å€™æ‰ä¼šè¢«æ‰§è¡Œã€‚</p>
</blockquote>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/references">å‚è€ƒæ–‡æ¡£</a></p>
</blockquote>
<p>laravelè¿è¡Œçš„php-fpmå®¹å™¨Dockerfileé…ç½®å¥½ä¹‹åï¼Œæ¥ä¸‹æ¥æ˜¯é…ç½®å‰ç«¯nuxtéœ€è¦çš„nodeå®¹å™¨ã€‚</p>
<h5 id="nodeå®¹å™¨dockerfile">nodeå®¹å™¨Dockerfile</h5>
<pre><code class="language-yml">#ä½¿ç”¨node:12-alpine ä½œä¸ºåŸºç¡€è¿›è¡Œæ„å»º
FROM node:12-alpine

#åˆ›å»º/app ç›®å½•ä½œä¸ºéƒ¨ç½²ç›®å½•,åˆ›å»ºå®¹å™¨å®ä¾‹æ—¶,æŒ‚è½½æ­¤ç›®å½•
RUN mkdir -p /app

#ç§»åŠ¨å·¥ä½œç›®å½•åˆ° /app
WORKDIR /app

#å®‰è£… bash å’Œ busybox
RUN apk update \
        &amp;&amp; apk upgrade \
        &amp;&amp; apk add --no-cache bash \
        bash-doc \
        bash-completion \
        &amp;&amp; /bin/bash \
        &amp;&amp; apk add --no-cache busybox \
        &amp;&amp; rm -rf /var/cache/apk/*

#å®‰è£… git
RUN apk add git
		
#è®¾ç½®nodeç¯å¢ƒå˜é‡ä¸ºproduction
ENV NODE_ENV=production

# copy the app, note .dockerignore
COPY ./pets-client /app
RUN npm install

# build necessary, even if no static files are needed,
# since it builds the server as well
RUN npm run build
RUN npm cache clean --force

# set app serving to permissive / assigned
#ENV NUXT_HOST=0.0.0.0 å·²ç»åœ¨nuxt.config.jsä¸­è®¾ç½®äº†server block
# set app port
#ENV NUXT_PORT=5000 å·²ç»åœ¨nuxt.config.jsä¸­è®¾ç½®äº†server block

#è®¾ç½®å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œçš„å‘½ä»¤
#ENTRYPOINT [ &quot;npm&quot;,&quot;start&quot; ]
CMD [&quot;npm&quot;,&quot;start&quot;]
</code></pre>
<p>Dockerfileéƒ¨åˆ†åˆ°æ­¤å°±ç»“æŸäº†ï¼Œæ¥ä¸‹æ¥ï¼Œéœ€è¦äº†è§£Docker-Compose</p>
<h2 id="äºŒ-docker-compose">äºŒã€<a href="https://yeasy.gitbook.io/docker_practice/compose">Docker-Compose</a></h2>
<p>Docker-Compose æ˜¯ç”¨æ¥ç®¡ç†ä½ çš„å®¹å™¨çš„ï¼Œæœ‰ç‚¹åƒä¸€ä¸ªå®¹å™¨çš„ç®¡å®¶ï¼Œæƒ³è±¡ä¸€ä¸‹å½“ä½ çš„Dockerä¸­æœ‰æˆç™¾ä¸Šåƒçš„å®¹å™¨éœ€è¦å¯åŠ¨ï¼Œå¦‚æœä¸€ä¸ªä¸€ä¸ªçš„å¯åŠ¨é‚£å¾—å¤šè´¹æ—¶é—´ã€‚æœ‰äº†Docker-Composeä½ åªéœ€è¦ç¼–å†™ä¸€ä¸ªæ–‡ä»¶ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢å£°æ˜å¥½è¦å¯åŠ¨çš„å®¹å™¨ï¼Œé…ç½®ä¸€äº›å‚æ•°ï¼Œæ‰§è¡Œä¸€ä¸‹è¿™ä¸ªæ–‡ä»¶ï¼ŒDockerå°±ä¼šæŒ‰ç…§ä½ å£°æ˜çš„é…ç½®å»æŠŠæ‰€æœ‰çš„å®¹å™¨å¯åŠ¨èµ·æ¥ï¼Œåªéœ€docker-compose upå³å¯å¯åŠ¨æ‰€æœ‰çš„å®¹å™¨ï¼Œä½†æ˜¯Docker-Composeåªèƒ½ç®¡ç†å½“å‰ä¸»æœºä¸Šçš„Dockerï¼Œä¹Ÿå°±æ˜¯è¯´ä¸èƒ½å»å¯åŠ¨å…¶ä»–ä¸»æœºä¸Šçš„Dockerå®¹å™¨ã€‚</p>
<p>è¡¥å……</p>
<blockquote>
<p>Docker Swarm<br>
Docker Swarm æ˜¯ä¸€æ¬¾ç”¨æ¥ç®¡ç†å¤šä¸»æœºä¸Šçš„Dockerå®¹å™¨çš„å·¥å…·ï¼Œå¯ä»¥è´Ÿè´£å¸®ä½ å¯åŠ¨å®¹å™¨ï¼Œç›‘æ§å®¹å™¨çŠ¶æ€ï¼Œå¦‚æœå®¹å™¨çš„çŠ¶æ€ä¸æ­£å¸¸å®ƒä¼šå¸®ä½ é‡æ–°å¸®ä½ å¯åŠ¨ä¸€ä¸ªæ–°çš„å®¹å™¨ï¼Œæ¥æä¾›æœåŠ¡ï¼ŒåŒæ—¶ä¹Ÿæä¾›æœåŠ¡ä¹‹é—´çš„è´Ÿè½½å‡è¡¡ï¼Œè€Œè¿™äº›ä¸œè¥¿Docker-Compose æ˜¯åšä¸åˆ°çš„</p>
<p><a href="https://yeasy.gitbook.io/docker_practice/kubernetes/intro">Kubernetes</a><br>
Kuberneteså®ƒæœ¬èº«çš„è§’è‰²å®šä½æ˜¯å’ŒDocker Swarm æ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä»–ä»¬è´Ÿè´£çš„å·¥ä½œåœ¨å®¹å™¨é¢†åŸŸæ¥è¯´æ˜¯ç›¸åŒçš„éƒ¨åˆ†ï¼Œéƒ½æ˜¯ä¸€ä¸ªè·¨ä¸»æœºçš„å®¹å™¨ç®¡ç†å¹³å°ï¼Œå½“ç„¶ä¹Ÿæœ‰è‡ªå·±ä¸€äº›ä¸ä¸€æ ·çš„ç‰¹ç‚¹ï¼Œk8sæ˜¯è°·æ­Œå…¬å¸æ ¹æ®è‡ªèº«çš„å¤šå¹´çš„è¿ç»´ç»éªŒç ”å‘çš„ä¸€æ¬¾å®¹å™¨ç®¡ç†å¹³å°ã€‚è€ŒDocker Swarmåˆ™æ˜¯ç”±Docker å…¬å¸ç ”å‘çš„ã€‚<strong>ç°åœ¨å¸¸ç”¨Kubernetes</strong></p>
</blockquote>
<p>å®ƒå…è®¸ç”¨æˆ·é€šè¿‡ä¸€ä¸ªå•ç‹¬çš„ <code>docker-compose.yml</code> æ¨¡æ¿æ–‡ä»¶ï¼ˆYAML æ ¼å¼ï¼‰æ¥å®šä¹‰ä¸€ç»„ç›¸å…³è”çš„åº”ç”¨å®¹å™¨ä¸ºä¸€ä¸ªé¡¹ç›®ï¼ˆprojectï¼‰ã€‚</p>
<p><code>Compose</code> ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼š</p>
<ul>
<li>æœåŠ¡ (<code>service</code>)ï¼šä¸€ä¸ªåº”ç”¨çš„å®¹å™¨ï¼Œå®é™…ä¸Šå¯ä»¥åŒ…æ‹¬è‹¥å¹²è¿è¡Œç›¸åŒé•œåƒçš„å®¹å™¨å®ä¾‹ã€‚</li>
<li>é¡¹ç›® (<code>project</code>)ï¼šç”±ä¸€ç»„å…³è”çš„åº”ç”¨å®¹å™¨ç»„æˆçš„ä¸€ä¸ªå®Œæ•´ä¸šåŠ¡å•å…ƒï¼Œåœ¨ <code>docker-compose.yml</code> æ–‡ä»¶ä¸­å®šä¹‰ã€‚</li>
</ul>
<p><code>Compose</code> çš„é»˜è®¤ç®¡ç†å¯¹è±¡æ˜¯é¡¹ç›®ï¼Œé€šè¿‡å­å‘½ä»¤å¯¹é¡¹ç›®ä¸­çš„ä¸€ç»„å®¹å™¨è¿›è¡Œä¾¿æ·åœ°ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚</p>
<p>æœ¬èŠ‚çš„å®‰è£…é“¾æ¥å·²ç»æœ‰å®‰è£…æ•™ç¨‹ï¼Œå®‰è£…æ­¤å¤„ç•¥</p>
<p>ç»™å‡ºæœ¬æ¬¡é¡¹ç›®çš„å®Œæˆç‰ˆæœ¬<code>docker-compose.prod.yml</code></p>
<h4 id="å®Œæˆç‰ˆæœ¬docker-composeprodyml">å®Œæˆç‰ˆæœ¬<code>docker-compose.prod.yml</code></h4>
<pre><code class="language-yml">version: &quot;3.7&quot;
services:
  app:
    build:
      args:
        user: petapi
        uid: 1000
      context: ./
      dockerfile: Dockerfile
    image: petapii
    container_name: petapi-app
    restart: unless-stopped
    working_dir: /var/www/
    volumes:
      - ./:/var/www
    networks:
      - petapin
  frontapp:
    build:
      context: ~/petclient/dockerfiles/node/
      dockerfile:  Dockerfile
    image: frontapp
    container_name: petclient-frontapp
    restart: unless-stopped
    working_dir: /app
    networks:
      - petclientn
  db:
    image: mysql:5.7
    container_name: petapi-db
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_USER: ${DB_USERNAME}
      SERVICE_TAGS: dev
      SERVICE_NAME: mysql
    volumes:
      - ./docker-compose/mysql:/docker-entrypoint-initdb.d
    networks:
      - petapin
  nginx:
    image: nginx:1.19.1-alpine
    container_name: pet-nginx
    restart: always
    depends_on:
      - app
      - frontapp
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./:/var/www
      - ./docker-compose/nginx:/etc/nginx/conf.d
      - ./docker-compose/nginx/certs:/etc/nginx/certs
    networks:
      - petapin
      - petclientn
networks:
  petapin:
    driver: bridge
  petclientn:
    driver: bridge
</code></pre>
<p>æ¥ä¸‹æ¥ç»†åˆ†æ‹†è§£ï¼›</p>
<h3 id="appéƒ¨åˆ†">appéƒ¨åˆ†ï¼š</h3>
<pre><code class="language-yml">app:
    build:
      args:
        user: petapi
        uid: 1000
      context: ./
      dockerfile: Dockerfile
    image: petapii
    container_name: petapi-app
    restart: unless-stopped
    working_dir: /var/www/
    volumes:
      - ./:/var/www
    networks:
      - petapin
</code></pre>
<p>è¿™æ˜¯å®šä¹‰çš„ç¬¬ä¸€ä¸ªæœåŠ¡ï¼Œ</p>
<p>appã€phpã€‘çš„Dockerfileé‡Œï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªå‚æ•° user å’Œ uid ï¼Œè¿™é‡Œè¿›è¡Œäº†èµ‹å€¼ã€‚</p>
<p>å› ä¸ºä½¿ç”¨buildæŒ‡ä»¤ï¼Œæ‰€ä»¥å¿…é¡»ç»™åˆ°context å’Œ Dockerfileï¼Œè¿™ä¸ªcontextå³å·²ç»åœ¨ <a href="#%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E4%B8%8A%E4%B8%8B%E6%96%87%EF%BC%88Context%EF%BC%89">å‰é¢æåˆ°è¿‡çš„é•œåƒæ„å»ºä¸Šä¸‹æ–‡ã€‚</a></p>
<p>buildå¯ä»¥ä¸ç»™context ç›´æ¥ç»™è·¯å¾„å¦‚ï¼š<code>build: ./dir</code> éœ€è¦æ³¨æ„çš„æ ¼å¼æ˜¯ <code>build:[ç©ºæ ¼]./dir</code> <strong>ç©ºæ ¼ä¸èƒ½å°‘</strong></p>
<p>image æ˜¯ç»™è¿™ä¸ªç”Ÿæˆçš„é•œåƒçš„åå­—ï¼Œå¦‚æœæ²¡æœ‰buildè€Œæ˜¯ç›´æ¥ç»™imageï¼Œdockerä¼šå»dockerhubå®˜æ–¹æœè¿™ä¸ªåŒ…ï¼Œæœåˆ°äº†å°±ç»™pullä¸‹æ¥ã€‚</p>
<p>app å…¶è¿è¡Œèµ·æ¥çš„å®¹å™¨åå«petapi-appï¼Œè¿™ä¸ªåå­—å¾ˆé‡è¦ï¼Œnginxçš„confé‡Œï¼Œæˆ‘ä»¬ä¼šç”¨åˆ°è¿™ä¸ªï¼š</p>
<blockquote>
<pre><code class="language-conf">server {
listen 80;
   listen [::]:80;
   server_name api.example.com;
   return 301 https://$http_host$request_uri;
   #rewrite ^(.*)$ https://$host$1 permanent; we just replace request to https
}
server{
listen 443 ssl;
   listen [::]:443 ssl;
   server_name api.example.com;
   #ssl on; no need this anymore please change use listen 443 ssl only
   ssl_certificate /etc/nginx/certs/cert.pem;
   ssl_certificate_key /etc/nginx/certs/key.pem;
   #ssl_session_timeout 5m;
   #ssl_protocols read blow info please;
   # By default nginx uses â€œssl_protocols TLSv1 TLSv1.1 TLSv1.2â€ and 
#â€œssl_ciphers HIGH:!aNULL:!MD5â€, so configuring them explicitly is 
#generally not needed.
   index index.php index.html;
   error_log /var/log/nginx/error.log;
   access_log /var/log/nginx/access.log;
   root /var/www/public;
   location ~ \.php$ {
           try_files $uri =404;
           fastcgi_split_path_info ^(.+\.php)(/.+)$;
           fastcgi_pass petapi-app:9000;
           fastcgi_index index.php;
           include fastcgi_params;
           fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
           fastcgi_param PATH_INFO $fastcgi_path_info;
           }
   location / {
            try_files $uri $uri/ /index.php?$query_string;
            gzip_static on;
            }
    }   
</code></pre>
</blockquote>
<p>æ³¨æ„ <code>fastcgi_pass petapi-app:9000;</code> æˆ‘ä»¬ç”¨åˆ°äº†container_name å³è¿™ä¸ªappå®¹å™¨çš„åå­—ã€‚9000æ˜¯é»˜è®¤php-fpmçš„ç«¯å£ã€‚</p>
<p>å…¶æ¬¡ï¼Œæˆ‘ä»¬Dockerfileä¹‹å‰æ²¡æœ‰è®¾ç½®æ•°æ®å·ï¼Œè¿™é‡Œè®¾ç½®äº†åŠ è½½ <code>docker-compose.prod.yml</code>æ‰€åœ¨æ–‡ä»¶å¤¹å…¨éƒ¨å†…å®¹ åˆ°å®¹å™¨ä¸­</p>
<p>restart:  æŒ‡å®šå®¹å™¨é€€å‡ºåçš„é‡å¯ç­–ç•¥ä¸ºå§‹ç»ˆé‡å¯ã€‚è¯¥å‘½ä»¤å¯¹ä¿æŒæœåŠ¡å§‹ç»ˆè¿è¡Œååˆ†æœ‰æ•ˆï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ¨èé…ç½®ä¸º <code>always</code> æˆ–è€… <code>unless-stopped</code>ã€‚</p>
<p>networks:  é…ç½®å®¹å™¨è¿æ¥çš„ç½‘ç»œã€‚è¿™ä¸ªç½‘ç»œä¸»è¦æ˜¯ç»™æœåŠ¡å®¹å™¨ä¹‹é—´é€šä¿¡çš„ï¼Œdbæˆ‘ä»¬ç”¨çš„mysqlé€šè¿‡è¿™ä¸ªç½‘ç»œå’Œappé€šä¿¡ï¼Œnginxä¹Ÿé€šè¿‡è¿™ä¸ªç½‘ç»œå’Œappé€šä¿¡ã€‚è¿™ä¸‰ä¸ªå…¬ç”¨çš„ petapin è¿™ä¸ªç½‘è·¯ï¼Œè¿™ä¸ªç½‘ç»œæ˜¯åœ¨ å¤–å±‚ networks:ä¸­å®šä¹‰çš„ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œdocker -compose å°±æ˜¯ï¼š</p>
<pre><code class="language-yml">version: 
services:
networks:
</code></pre>
<p>è¿™ä¸‰ä¸ªã€‚<s>networks çš„ driver å¯ä»¥å‚è€ƒ network_modeã€‚</s>  <strong>é”™å•¦ï¼networks åº”è¯¥å‚è€ƒ <a href="https://docs.docker.com/compose/compose-file/#network-configuration-reference">Network configuration reference</a></strong></p>
<p>å…³äºnetworkså’Œlinks è¯·çœ‹ <a href="https://docs.docker.com/compose/networking/">Networking in Compose</a></p>
<blockquote>
<p>compose é»˜è®¤ä¼šæä¾›ä¸€ä¸ªnetwork ï¼Œæ¯ä¸ªæœåŠ¡éƒ½ä¼šåŠ å…¥è¿™ä¸ªnetworkï¼Œä¸”é»˜è®¤äº’é€šï¼Œå®ƒä»¬ä¹‹é—´ä»¥ä¸€ä¸ªåŸºäºå®¹å™¨åç”Ÿæˆçš„åä½œåŒºåˆ†ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ç½‘ç»œååŸºäºé¡¹ç›®åã€é¡¹ç›®åŸºäºå­˜æ”¾å…¶çš„æ–‡ä»¶å¤¹åã€‘</p>
<p>æ¯”å¦‚è¯´, å‡è®¾ä½ çš„appå­˜æ”¾äºä¸€ä¸ªå«<code>myapp</code>çš„æ–‡ä»¶å¤¹é‡Œ, ä½ çš„ <code>docker-compose.yml</code> é…ç½®å¦‚ä¸‹:</p>
<pre><code>version: &quot;3&quot;
services:
web:
build: .
ports:
    - &quot;8000:8000&quot;
db:
  image: postgres
  ports:
    - &quot;8001:5432&quot;
</code></pre>
<p>å½“ä½ æ‰§è¡Œ <code>docker-compose up</code>,çš„æ—¶å€™ ï¼Œä¼šæœ‰å¦‚ä¸‹æµç¨‹:</p>
<ol>
<li>ä¸€ä¸ªåå«<code>myapp_default</code>çš„ç½‘ç»œè¢«åˆ›å»º ã€‚</li>
<li>ä½¿ç”¨ <code>web</code>é…ç½®åˆ›å»ºä¸€ä¸ªå®¹å™¨. è¯¥å®¹å™¨åŠ å…¥ <code>myapp_default</code> ç½‘ç»œå¹¶ä¸”èµ‹äºˆä¸€ä¸ªæ ‡è¯†å <code>web</code>.</li>
<li>ä½¿ç”¨ <code>db</code>é…ç½®åˆ›å»ºä¸€ä¸ªå®¹å™¨.  è¯¥å®¹å™¨åŠ å…¥ <code>myapp_default</code> ç½‘ç»œå¹¶ä¸”èµ‹äºˆä¸€ä¸ªæ ‡è¯†å db.</li>
</ol>
<p>æ¯ä¸€ä¸ªå®¹å™¨éƒ½å¯ä»¥é€šè¿‡æ ‡è¯†å<code>web</code>,<code>db</code>æŸ¥è¯¢åˆ°è¿™ä¸¤å®¹å™¨ï¼Œå¹¶è·å¾—è¿™ä¸¤å®¹å™¨çš„ipåœ°å€ï¼Œæ¯”å¦‚ï¼Œwebå®¹å™¨é‡Œçš„ç¨‹åºä»£ç å¯ä»¥é€šè¿‡<code>postgres:5342</code>é“¾æ¥åˆ°<code>db</code>å®¹å™¨ï¼Œå°±å¯ä»¥ä½¿ç”¨postgresæ•°æ®åº“å•¦ã€‚</p>
<p>It is important to note the distinction between <code>HOST_PORT</code> and <code>CONTAINER_PORT</code>. In the above example, for <code>db</code>, the <code>HOST_PORT</code> is <code>8001</code> and the container port is <code>5432</code> (postgres default). Networked service-to-service communication use the <code>CONTAINER_PORT</code>. When <code>HOST_PORT</code> is defined, the service is accessible outside the swarm as well.</p>
<p>Within the <code>web</code> container, your connection string to <code>db</code> would look like <code>postgres://db:5432</code>, and from the host machine, the connection string would look like <code>postgres://{DOCKER_IP}:8001</code>.</p>
<h2 id="linksäº†è§£å°±è¡Œ"><a href="https://docs.docker.com/compose/networking/#links">Linksäº†è§£å°±è¡Œ</a></h2>
<p>è¿™ä¸ªå‚è€ƒ <a href="https://docs.docker.com/compose/compose-file/#links"><strong>linkså°†ä¼šåœ¨ä»Šåè¢«ç§»é™¤</strong></a>ï¼ŒåæœŸè¿™ä¸ªæ²¡æœ‰äº†ï¼Œç°åœ¨äº†è§£å°±è¡Œï¼Œä¸æ¨èä½¿ç”¨ã€‚</p>
<p>Links allow you to define extra aliases by which a service is reachable from another service. They are not required to enable services to communicate - by default, any service can reach any other service at that serviceâ€™s name. In the following example, <code>db</code> is reachable from <code>web</code> at the hostnames <code>db</code> and <code>database</code>:</p>
<pre><code>version: &quot;3&quot;
services:

web:
  build: .
  links:
    - &quot;db:database&quot;
db:
  image: postgres
</code></pre>
<p>See the <a href="https://docs.docker.com/compose/compose-file/compose-file-v2/#links">links reference</a> for more information.</p>
<h2 id="networks"><a href="https://docs.docker.com/compose/compose-file/#networks">NETWORKS</a></h2>
<p>æˆ‘ä»¬è¿™é‡Œç”¨çš„å°±æ˜¯è¿™ä¸ªã€‚</p>
</blockquote>
<p>æ›´å¤šçš„æŒ‡ä»¤å‚è€ƒ <a href="https://yeasy.gitbook.io/docker_practice/compose/compose_file">docker compose æŒ‡ä»¤</a></p>
<p>frontappé…ç½®å‚è€ƒä¸Šé¢çš„è‡ªå·±ç†è§£ï¼Œ</p>
<h3 id="dbéƒ¨åˆ†">dbéƒ¨åˆ†ï¼š</h3>
<pre><code class="language-yml">  db:
    image: mysql:5.7
    container_name: petapi-db
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_USER: ${DB_USERNAME}
      SERVICE_TAGS: dev
      SERVICE_NAME: mysql
    volumes:
      - ./docker-compose/mysql:/docker-entrypoint-initdb.d
    networks:
      - petapin
</code></pre>
<p>æ•°æ®åº“åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªå¯¼å…¥çš„æ“ä½œï¼Œå¦‚æœä»¥åç½‘ç«™ä¸»æœºè¿ç§»ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥æ‰“åŒ…å¯¼å…¥ï¼Œæ•™ç¨‹åœ¨cnblogæœ‰ã€‚</p>
<p>æ•°æ®åº“éƒ¨åˆ†å…¶ä½™çš„éƒ½æ²¡å•¥å¥½è¯´çš„ï¼Œä¸»è¦æ˜¯environmenté‡Œçš„é…ç½®ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä½¿ç”¨çš„æ˜¯</p>
<pre><code class="language-yml">environment:
  RACK_ENV: development
  SHOW: 'true'
  SESSION_SECRET:
environment:
  - RACK_ENV=development
  - SHOW=true
  - SESSION_SECRET
</code></pre>
<p>è¿™ç§èµ‹å€¼æ ¼å¼ã€‚</p>
<p>ä½†æ˜¯<code>${...}</code> æ€ä¹ˆç†è§£ï¼Ÿ</p>
<blockquote>
<p>You can use environment variables in configuration values with a Bash-like <code>${VARIABLE}</code> syntax - see <a href="https://docs.docker.com/compose/compose-file/#variable-substitution">variable substitution</a> for full details.</p>
<p>å°±æ˜¯è¯´ï¼Œ<code>${...}</code>æ˜¯å¯ä»¥è¯»å–è®¾ç½®åœ¨<code>.env</code>æ–‡ä»¶ä¸­çš„å€¼çš„ï¼Œä½†æ˜¯å¿…é¡»åœ¨æ‰§è¡Œ <code>docker-compose up</code>çš„æ—¶å€™ï¼Œå¦‚æœåœ¨æ‰§è¡Œçš„æ—¶å€™å¦è¡Œèµ‹å€¼ <code>--name=...</code>ä¼šè¦†ç›–<code>.env</code>ä¸­çš„å€¼ã€‚<code>.env</code>æ–‡ä»¶ä¸­é…ç½®çš„å€¼åªåœ¨ <code>docker-compose up</code>æ‰§è¡Œçš„æ—¶å€™èµ·ä½œç”¨ï¼Œ<code>docker stack deploy</code>ä¸èµ·ä½œç”¨ã€‚</p>
<p>å…¶ä»–ç”¨æ³•ï¼š <code>${VARIABLE:-default}</code>åŠ<code>${VARIABLE-default}</code> åŠ<code>${VARIABLE:?err}</code>åŠ<code>${VARIABLE?err}</code></p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸Šé¢é…ç½®dbå®¹å™¨çš„å€¼ï¼Œåœ¨docker-compose upçš„æ—¶å€™ï¼Œè¯»å–åŒç›®å½•ä¸‹.envæ–‡ä»¶ä¸­é…ç½®çš„å€¼ã€‚</p>
<h3 id="nginxéƒ¨åˆ†">nginxéƒ¨åˆ†</h3>
<pre><code class="language-yml">nginx:
    image: nginx:1.19.1-alpine
    container_name: pet-nginx
    restart: always
    depends_on:
      - app
      - frontapp
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./:/var/www
      - ./docker-compose/nginx:/etc/nginx/conf.d
      - ./docker-compose/nginx/certs:/etc/nginx/certs
    networks:
      - petapin
      - petclientn
</code></pre>
<p>nginxé…ç½®ä¸­æˆ‘ä»¬ä½¿ç”¨äº†ä¸¤ä¸ªconfï¼Œpetapi.confåŠ petclient.confå­˜æ”¾äº ./docker-compose/nginxç›®å½•ä¸‹ã€‚é€šè¿‡volumesé…ç½®ï¼ŒåŠ è½½åˆ°äº†nginxå®¹å™¨å†…çš„/etc/nginx/conf.dæ–‡ä»¶å¤¹ä¸­ã€‚</p>
<p>ç„¶åæ˜¯sslçš„key.pemå’Œcert.pemæ–‡ä»¶å­˜æ”¾åœ¨./docker-compose/nginx/certsæ–‡ä»¶å¤¹ä¸‹ã€‚é€šè¿‡volumesé…ç½®ï¼ŒåŠ è½½åˆ°äº†nginxå®¹å™¨å†…çš„/etc/nginx/certsæ–‡ä»¶å¤¹å†…ã€‚</p>
<p>ä¸ºä»€ä¹ˆé…ç½® ./åŠ è½½åˆ°/var/wwwæ–‡ä»¶å¤¹ä¸­å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬çœ‹çœ‹petapi.conf:</p>
<pre><code class="language-conf">server {
   listen 80;
        ç•¥...
     }
server{
   listen 443 ssl;
        listen [::]:443 ssl;
        server_name api.example.com;
        ssl_certificate /etc/nginx/certs/cert.pem;
        ssl_certificate_key /etc/nginx/certs/key.pem;
        index index.php index.html;
        error_log /var/log/nginx/error.log;
        access_log /var/log/nginx/access.log;
        root /var/www/public;
        location ~ \.php$ {
                try_files $uri =404;
                fastcgi_split_path_info ^(.+\.php)(/.+)$;
                fastcgi_pass petapi-app:9000;
                fastcgi_index index.php;
                }
        location / {
                 try_files $uri $uri/ /index.php?$query_string;
                 gzip_static on;
                 }
         }
</code></pre>
<p>å†çœ‹ç›®å½•ç»“æ„</p>
<pre><code>drwxrwxr-x 16 ***** *****     4096 Jul 18 15:05 ./
drwxrwxr-x  4 ***** *****      4096 Jul 13 07:09 ../
drwxrwxr-x 11 ***** *****      4096 Jul 12 17:00 app/
-rw-rw-r--  1 ***** *****      1686 Jul 12 17:00 artisan
drwxrwxr-x  3 ***** *****      4096 Jul 12 17:00 bootstrap/ 
-rw-rw-r--  1 ***** *****      1660 Jul 12 17:00 composer.json
-rw-rw-r--  1 ***** *****    208927 Jul 12 17:00 composer.lock
drwxrwxr-x  2 ***** *****      4096 Jul 12 17:00 config/
drwxrwxr-x  5 ***** *****      4096 Jul 12 17:00 database/
drwxrwxr-x  4 ***** *****      4096 Jul 16 06:15 docker-compose/
-rw-rw-r--  1 ***** *****      1806 Jul 18 13:06 docker-compose.prod.yml
-rw-rw-r--  1 ***** *****       741 Jul 12 17:12 Dockerfile
drwxrwxr-x  3 ***** *****      4096 Jul 15 18:07 dockerfiles/
-rw-rw-r--  1 ***** *****       220 Jul 12 17:00 .editorconfig
-rw-rw-r--  1 ***** *****       844 Jul 12 18:37 .env
-rw-rw-r--  1 ***** *****       778 Jul 12 17:00 .env.example
drwxrwxr-x  8 ***** *****      4096 Jul 12 17:00 .git/
-rw-rw-r--  1 ***** *****       111 Jul 12 17:00 .gitattributes
-rw-rw-r--  1 ***** *****       163 Jul 12 17:00 .gitignore
drwxrwxr-x  2 ***** *****      4096 Jul 12 17:00 .idea/
-rw-rw-r--  1 ***** *****      1013 Jul 12 17:00 package.json
-rw-rw-r--  1 ***** *****    462139 Jul 12 17:00 package-lock.json
-rw-rw-r--  1 ***** *****      1197 Jul 12 17:00 phpunit.xml
drwxrwxr-x  2 ***** *****      4096 Jul 13 14:46 public/
-rw-rw-r--  1 ***** *****      4497 Jul 12 17:00 README.md
drwxrwxr-x  6 ***** *****      4096 Jul 12 17:00 resources/
drwxrwxr-x  2 ***** *****      4096 Jul 12 17:00 routes/
-rw-rw-r--  1 ***** *****       563 Jul 12 17:00 server.php
drwxrwxr-x  5 ***** ********   4096 Jul 12 17:00 storage/
-rw-rw-r--  1 ***** *****       174 Jul 12 17:00 .styleci.yml
drwxrwxr-x  4 ***** *****      4096 Jul 12 17:00 tests/
drwxr-xr-x 48 ***** *****      4096 Jul 12 18:28 vendor/
-rw-rw-r--  1 ***** *****       538 Jul 12 17:00 webpack.mix.js
</code></pre>
<p>nginxåœ¨ api.example.com:80æˆ–443è¯·æ±‚çš„æ—¶å€™ï¼Œ80å¼ºåˆ¶è½¬443ï¼Œç„¶åçœ‹443ä¸­å¤„ç†é€»è¾‘ã€‚</p>
<p>å®¹å™¨ä¸­çš„<code>root /var/www/public/</code>å¯¹åº”çš„å°±æ˜¯å®¿ä¸»æœº publicæ–‡ä»¶å¤¹ã€‚</p>
<pre><code>location / {
	try_files $uri $uri/ /index.php?$query_string;
	gzip_static on;
	}
</code></pre>
<p>è®¿é—®çš„æ—¶å€™ï¼Œå°è¯•çš„æ˜¯æ¯”å¦‚	<code>http://api.exampl.com/api/pigs/all/1</code>ä¼šè§£æå‡ºuri <code>api/pigs/all/1</code>ï¼Œè¿™ä¸ªuriæ–‡ä»¶åœ¨publicç›®å½•ä¸­æ˜¯æ²¡æœ‰çš„ã€‚</p>
<p>publicç›®å½•ï¼š</p>
<pre><code>drwxrwxr-x  2 ***** ***** 4096 Jul 13 14:46 ./
drwxrwxr-x 16 ***** ***** 4096 Jul 18 15:05 ../
-rw-rw-r--  1 ***** *****    0 Jul 12 17:00 favicon.ico
-rw-rw-r--  1 ***** *****  603 Jul 12 17:00 .htaccess
-rw-rw-r--  1 ***** ***** 1823 Jul 12 17:00 index.php
-rw-rw-r--  1 ***** *****   24 Jul 12 17:00 robots.txt
lrwxrwxrwx  1 ***** *****   27 Jul 13 14:46 storage -&gt; /var/www/storage/app/public
-rw-rw-r--  1 ***** ***** 1194 Jul 12 17:00 web.config
</code></pre>
<p>æ‰€ä»¥ç›´æ¥è·³è§£æ<code>/index.php?$query_string;</code> ç„¶å$query_stringå°±æ˜¯<code>api/pigs/all/1</code>ï¼Œç„¶åå°±æ˜¯laravelå·¥ä½œé€»è¾‘äº†ã€‚è§£æå‡ºrequestï¼Œparameters...</p>
<p>æ‰€ä»¥è¿™ä¸ªåŠ è½½åˆ°nginxä¸­æ˜¯å¿…è¦çš„ï¼Œå¦‚æœä¸ç”¨try_fileså‘¢ã€æ²¡è¯•è¿‡ã€‘ï¼Ÿé‚£åº”è¯¥å°±appå®¹å™¨å¼€ä¸€ä¸ªç«¯å£[æ¯”å¦‚12343]ï¼Œç„¶ånginxä½¿ç”¨proxy_pass petapi-app:å¼€çš„ç«¯å£å·[12343] ï¼Œè¿™æ ·å°±okäº†å§ã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹çœ‹sslé…ç½®ï¼Œå‰é¢è¯´åˆ°</p>
<blockquote>
<p>sslçš„key.pemå’Œcert.pemæ–‡ä»¶å­˜æ”¾åœ¨./docker-compose/nginx/certsæ–‡ä»¶å¤¹ä¸‹ã€‚é€šè¿‡volumesé…ç½®ï¼ŒåŠ è½½åˆ°äº†nginxå®¹å™¨å†…çš„/etc/nginx/certsæ–‡ä»¶å¤¹å†…ã€‚</p>
</blockquote>
<p>æ‰€ä»¥ssléƒ¨åˆ†çš„é…ç½®æœ‰ï¼š</p>
<pre><code>ssl_certificate /etc/nginx/certs/cert.pem;
ssl_certificate_key /etc/nginx/certs/key.pem;
</code></pre>
<p>åŒæ ·çš„æ¥çœ‹çœ‹</p>
<p>frontappéƒ¨åˆ†çš„confé…ç½®ï¼š</p>
<pre><code>server {
listen 80;
listen [::]:80;
server_name example.com www.example.com;
return 301 https://$http_host$request_uri;
#rewrite ^(.*)$ https://$host$1 permanent; we just replace request to https
}
server{
listen 443 ssl;
listen [::]:443 ssl;
server_name example.com www.example.com;
#ssl on; no need this anymore please change use listen 443 ssl only
ssl_certificate /etc/nginx/certs/cert.pem;
ssl_certificate_key /etc/nginx/certs/key.pem;
#ssl_session_timeout 5m;
#ssl_protocols read blow info please;
# By default nginx uses â€œssl_protocols TLSv1 TLSv1.1 TLSv1.2â€ and 
#â€œssl_ciphers HIGH:!aNULL:!MD5â€, so configuring them explicitly is generally 
#not needed.
index index.php index.html;
error_log /var/log/nginx/error.log;
access_log /var/log/nginx/access.log;
root /var/www/public;
location ~ \.php$ {
try_files $uri =404;
fastcgi_split_path_info ^(.+\.php)(/.+)$;
fastcgi_pass frontapp:9000;
fastcgi_index index.php;
include fastcgi_params;
fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
fastcgi_param PATH_INFO $fastcgi_path_info;
}
location / {
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header Host  $http_host;
proxy_set_header X-Nginx-Proxy true;
proxy_set_header Connection &quot;&quot;;
proxy_pass http://frontapp:8000; #å› ä¸ºåœ¨nuxtä¸­ serveré…ç½®å°±è¿™ä¸ª
gzip_static on;
}
}
</code></pre>
<p>ä¸petapi.confä¸åŒçš„å°±æ˜¯</p>
<pre><code>location / {
                proxy_set_header X-Real-IP $remote_addr;
				proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
				proxy_set_header Host  $http_host;
				proxy_set_header X-Nginx-Proxy true;
				proxy_set_header Connection &quot;&quot;;
				proxy_pass http://frontapp:8000; #å› ä¸ºåœ¨nuxtä¸­ serveré…ç½®å°±è¿™ä¸ª
                gzip_static on;
                }
</code></pre>
<p>proxy_passä¸€å®šæ˜¯ http://å¼€å¤´+ip+:+ç«¯å£ï¼Œ</p>
<p>ipç”¨äº†å®¹å™¨å‚æ•°ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºå•¥nginxå®¹å™¨çš„depends_onè®¾ç½®äº†appå’Œfrontappä¸¤ä¸ªå®¹å™¨ï¼Œå› ä¸ºè¦ç”¨å•Šã€‚</p>
<p>ç«¯å£è®¾ç½®ä¸º8000æ˜¯å› ä¸ºnuxtä¸­<code>nuxt.config.js</code>å€¼ä¸ºï¼š</p>
<pre><code class="language-js">  server: {
    port: 8000, // default: 3000
    host: '0.0.0.0', // default: localhost,
    timing: false
    // timing: {
    //   total: true
    // }
  },
</code></pre>
<p>ç«¯å£ç»™è®¾ç½®äº†8000ï¼Œnodeçš„<a href="#node%E5%AE%B9%E5%99%A8Dockerfile">Dockerfile</a>æˆ‘ä»¬ä¹Ÿå°±æ²¡æœ‰å¼€ç«¯å£äº†ã€‚</p>
<p>å¦‚æœç»™docker-compose.prod.ymlåŠ ä¸€ä¸ª</p>
<pre><code class="language-yml">  frontapp:
    build:
      context: ~/petclient/dockerfiles/node/
      dockerfile:  Dockerfile
    image: frontapp
    container_name: petclient-frontapp
    restart: unless-stopped
    working_dir: /app
    ports:
     - 800:8000
    networks:
      - petclientn
</code></pre>
<p>æ³¨æ„å…¶ä¸­</p>
<pre><code class="language-yml">    ports:
     - 800:8000
</code></pre>
<p>åŠ ä¸Šäº†å°±å¯ä»¥é€šè¿‡å®¿ä¸»æœºip[å½“å‰ç¯å¢ƒä¸‹å°±æ˜¯æœåŠ¡å™¨ip]:8000ç›´æ¥è®¿é—®nuxtåº”ç”¨ã€‚æˆ‘ä»¬è¿™é‡Œä¸ç”¨ï¼Œåªæ˜¯è¯´åŸç†å¦‚æ­¤ã€‚ä½†æ˜¯å¦‚æœä½ ç»™å¼€ä¸ª443ç«¯å£è®¿é—®è¿™ä¸ª8000ç«¯å£ï¼Œä¼šä¸è¡Œï¼Œä¼šæŠ¥ç«¯å£å·²ç»è¢«(å°±æ˜¯nginxå®¹å™¨)å ç”¨ã€‚</p>
<p>docker-compose.prod.ymlé…ç½®å®Œäº†ï¼Œç„¶åæ‰§è¡Œ <code>docker-compose -f docker-compose.prod.yml build app frontapp</code>ç»™çˆ·ç”Ÿæˆè¿™ä¸¤å®¹å™¨çš„é•œåƒå‡ºæ¥ã€‚ç”Ÿæˆå®Œäº† æ‰§è¡Œ <code>docker-compose -f docker-compose.prod.yml up -d</code>å°±å¯ä»¥è·‘èµ·æ¥äº†ã€‚æ‰§è¡Œå‘½ä»¤åˆ‡æ¢åˆ° docker-compose.prod.ymlæ–‡ä»¶çš„ç›®å½•ä¸‹ï¼Œè¿™æ ·-fæŒ‡å®šå…å¾—ç»™ä¸€ä¸²é•¿çš„åœ°å€ã€‚</p>
<h2 id="ä¸‰-laravelå‘å¸ƒéœ€è¦å‡†å¤‡çš„æ–‡ä»¶å’Œç”Ÿäº§ç¯å¢ƒè¦åšçš„ä¸€äº›æ“ä½œ">ä¸‰ã€laravelå‘å¸ƒéœ€è¦å‡†å¤‡çš„æ–‡ä»¶å’Œç”Ÿäº§ç¯å¢ƒè¦åšçš„ä¸€äº›æ“ä½œ</h2>
<p>laravelçš„ä»£ç ï¼Œæˆ‘æ˜¯ç›´æ¥git clone ä¸‹æ¥ç„¶åè¿›åˆ°appå®¹å™¨é‡Œ</p>
<p>æ‰§è¡Œ</p>
<p><code>cp .env.example .env</code> .envæ–‡ä»¶ã€‚</p>
<p>ç‰¹åˆ«æ³¨æ„</p>
<pre><code>APP_ENV=production
APP_DEBUG=false
APP_URL
</code></pre>
<p><code>php artisan key:generate</code> ç”Ÿæˆkey</p>
<p>ç„¶åè‡ªå·±é…ç½®.envæ–‡ä»¶ä¸­çš„å€¼ï¼Œmailå•Š jwtå•Š mysqlä¹‹ç±»çš„ã€‚</p>
<p><code>php artisan migrate</code> æ•°æ®åº“</p>
<p>ç„¶åå°±æ˜¯è¿›å…¥dbæ•°æ®åº“å®¹å™¨ï¼Œæ£€æŸ¥ç”¨æˆ·ï¼Œè¡¨ï¼Œå¯¼å…¥æ‰“åŒ…çš„æ•°æ®åº“ã€‚</p>
<p>æ¥ç€å°±æ˜¯æŠŠstorageé‡Œçš„æ–‡ä»¶ç”¨rsyncç»™ä¼ åˆ°æœåŠ¡å™¨[å®¿ä¸»æœº]çš„laravelå­˜æ”¾æ–‡ä»¶å¤¹é‡Œçš„storageå¯¹åº”çš„æ–‡ä»¶å¤¹é‡Œã€‚</p>
<p>å†åœ¨appå®¹å™¨æ‰§è¡Œ</p>
<p><code>php artisan storage:link</code></p>
<p>ç„¶åå°±å¯ä»¥ç”¨äº†ã€‚</p>
<p><code>php artisan optimize</code></p>
<p>è‡³äºé‚®ä»¶ï¼Œéœ€è¦å¼€å¯queueï¼Œä»¥åŠ<a href="https://medium.com/@ahmeeddhon/laravel-docker-using-alpine-1f80fab7359b">supervisor</a>ã€‚ã€æš‚ç¼ºã€‘ã€ä¸ç”¨supervisorä¹Ÿå¯ä»¥å¼€å¯queueå¹¶ç¡®ä¿ä¸service down å‚è€ƒ<a href="#%E4%B8%83%E3%80%81%E6%9B%B4%E6%96%B0">æ›´æ–°éƒ¨åˆ†</a> ã€‘</p>
<h2 id="å››-nuxté‡åˆ°çš„å‘">å››ã€nuxté‡åˆ°çš„å‘</h2>
<p>å¦‚æœæœ‰ä»£ç ç”¨åˆ°äº†</p>
<p><code>target: (process.env.NODE_ENV === &quot;production&quot;) ? process.env.API_URL : &quot;http://petapi.test/api&quot;,</code></p>
<p>è¿™æ ·çš„ï¼Œé‚£envæ–‡ä»¶å¿…é¡»è¦æœ‰ã€‚å¦åˆ™å¿…ç„¶æŠ¥target null ç±»å‹é”™è¯¯ã€‚</p>
<p>è¿˜è¦å®‰è£…<a href="https://github.com/nuxt-community/dotenv-module">dotenv</a> ,ä¸”é…ç½®å¦‚ä¸‹ï¼š</p>
<pre><code class="language-js">require('dotenv').config(); //https://github.com/nuxt-community/proxy-module/issues/3


export default{
    ...
    modules: [
   ...
    // Doc: https://github.com/nuxt-community/dotenv-module
    '@nuxtjs/dotenv',
    ...
  ],
        ...
}

</code></pre>
<p>æˆ‘è¿™ä¸ªç›´æ¥ç”¨çš„ssrï¼Œç›®å‰è¿˜æ˜¯æœ‰ä¸ªé—®é¢˜å°±æ˜¯jsåŒ…å¤ªå¤§ï¼Œè¦ç²¾ç®€ä¸€ä¸‹ã€‚è™½ç„¶nuxtå¯ä»¥ç›´æ¥æsslä¸ç”¨nginxï¼Œä½†æ˜¯è¿™é‡Œ443ç«¯å£è¢«nginxå ç”¨äº†ï¼Œå¦å¤–nginxè¿˜æ˜¯æ¯”nodeè¦å¼ºã€‚node+nginxæ¨èã€‚</p>
<p>ä¹Ÿæ˜¯å‚è€ƒçš„ https://jonathanmh.com/deploying-a-nuxt-js-app-with-docker/</p>
<p>å…ˆç›´æ¥git cloneä»£ç ï¼Œç„¶åCOPYåˆ°frontappå®¹å™¨ï¼Œç„¶ånpm installï¼Œbuildï¼Œstartã€<a href="#node%E5%AE%B9%E5%99%A8Dockerfile">Dockerfileé‡Œæœ‰é…ç½®</a>ã€‘ã€‚</p>
<p>è¿™é‡Œå…¶å®å¯ä»¥ç”¨volumeåŠ è½½åˆ°å®¹å™¨çš„ï¼Œæˆ‘æ˜¯COPYï¼Œåæ­£å‰ç«¯ä¹Ÿæ²¡å•¥å˜åŒ–ï¼Œå˜åŒ–äº†å°±åˆè¦install buildä¸€å¥—ï¼Œvolumeé—®é¢˜ä¸å¤§ã€‚</p>
<p>å› ä¸ºnuxtå¼€å‘çš„.gitignoreæ²¡æœ‰æ·»åŠ staticæ–‡ä»¶å¤¹ï¼Œæ‰€ä»¥git cloneçš„æ—¶å€™å°±æœ‰äº†staticæ–‡ä»¶å¤¹é‡Œçš„æ–‡ä»¶ï¼Œå°±ä¸rsyncä¸Šä¼ äº†ã€‚</p>
<p>è®°å¾—nano .envæ·»åŠ  .envæ–‡ä»¶å¹¶é…ç½®éœ€è¦çš„å€¼ã€‚</p>
<p>æˆ‘é…ç½®çš„å°±æœ‰ï¼š</p>
<pre><code class="language-env">API_URL=&quot;https://api.example.com/api&quot;
NODE_ENV=&quot;production&quot;
AUTH_URL=&quot;https://api.example.com/api/auth&quot;
</code></pre>
<h2 id="äº”-mysql">äº”ã€mysql</h2>
<p>æ‰§è¡Œ<code>docker cp ./****.sql ***api-db:/tmp/</code>copyåˆ°mysqlé‡Œï¼›</p>
<p>è¿™ä¸ªå®¹å™¨ç”¨çš„é»˜è®¤çš„æ²¡æœ‰bashï¼Œåªæœ‰shã€‚</p>
<p>ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤ã€‚</p>
<p>mysql -uroot -p</p>
<p>show databases;</p>
<p>use databaseA;</p>
<p>show datatables;</p>
<p>selecr * from datatableA1;</p>
<p>source æ‰“åŒ…çš„åœ°å€.sql ã€è¿™ä¸ªç”¨æ¥å¯¼å…¥çš„ã€‘</p>
<p>exit</p>
<h2 id="å…­-nginx">å…­ã€nginx</h2>
<p>ä¸Šé¢æåˆ°çš„petapi.confå’Œpetclient.confæ˜¯æ€ä¹ˆåŠ è½½è¿›nginxçš„å‘¢ï¼Ÿ</p>
<p>é¦–å…ˆè¿™ä¸¤ä¸ªé€šè¿‡<a href="#%E5%AE%8C%E6%88%90%E7%89%88%E6%9C%AC%60docker-compose.prod.yml%60">docker-compose.prod.yml</a> åŠ è½½è¿›äº†å®¹å™¨çš„ /etc/nginx/conf.dæ–‡ä»¶å¤¹é‡Œï¼Œç„¶å</p>
<p>çœ‹çœ‹nginx.confæ–‡ä»¶ï¼š</p>
<p>æ‰§è¡Œ<code>docker exec -it pet-nginx sh</code>è¿›åˆ°nginxå®¹å™¨ï¼Œå› ä¸ºæ²¡æœ‰å®‰è£…bashæ‰€ä»¥ç”¨shã€‚</p>
<p>æ‰¾åˆ°nginx.confæ‰“å¼€ï¼š</p>
<pre><code class="language-conf">user  nginx;
worker_processes  auto;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;
events {
	worker_connections  1024;
}
http {
	include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '
                      '$status $body_bytes_sent &quot;$http_referer&quot; '
                      '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;

    include /etc/nginx/conf.d/*.conf;
}
</code></pre>
<p>æ³¨æ„å°±æ˜¯æœ€åä¸€è¡Œ<code>include /etc/nginx/conf.d/*.conf;</code>å¼•å…¥äº†è¿™ä¸¤ä¸ªconfæ–‡ä»¶ã€‚</p>
<p>åŒæ—¶æˆ‘ä»¬æ³¨æ„æƒé™ï¼š</p>
<pre><code class="language-drwxr-xr-x">drwxr-xr-x    1 root     root          4096 Jul 18 15:11 ..
drwxrwxr-x    2 1000     1000          4096 Jul 15 16:54 certs
drwxrwxr-x    3 1000     1000          4096 Jul 19 18:06 conf.d
-rw-r--r--    1 root     root          1077 Jul  7 16:14 fastcgi.conf
-rw-r--r--    1 root     root          1007 Jul  7 16:14 fastcgi_params
-rw-r--r--    1 root     root          2837 Jul  7 16:14 koi-utf
-rw-r--r--    1 root     root          2223 Jul  7 16:14 koi-win
-rw-r--r--    1 root     root          5231 Jul  7 16:14 mime.types
lrwxrwxrwx    1 root     root            22 Jul 10 20:27 modules -&gt; /usr/lib/nginx/modules
-rw-r--r--    1 root     root           646 Jul  7 16:14 nginx.conf
-rw-r--r--    1 root     root           636 Jul  7 16:14 scgi_params
-rw-r--r--    1 root     root           664 Jul  7 16:14 uwsgi_params
-rw-r--r--    1 root     root          3610 Jul  7 16:14 win-utf
</code></pre>
<p>è¿™é‡Œé¢certså’Œconf.dæ–‡ä»¶å¤¹çš„ownerå’Œç»„éƒ½æ˜¯1000ï¼Œå°±æ˜¯appå®¹å™¨é‡Œçš„ç”¨æˆ·ã€‚é‡Œé¢çš„æ–‡ä»¶ä¹Ÿæ˜¯è¿™æ ·çš„ã€‚</p>
<pre><code class="language-drwxrwxr-x">drwxr-xr-x    1 root     root          4096 Jul 18 15:11 ..
drwxrwxr-x    2 1000     1000          4096 Jul 15 16:54 certs
-rw-rw-r--    1 1000     1000          1465 Jul 19 18:06 petapi.conf
-rw-rw-r--    1 1000     1000          1709 Jul 18 15:07 petclient.conf
</code></pre>
<p><strong>æ³¨æ„è¿™æ˜¯åœ¨nginxå®¹å™¨é‡Œäº†ã€‚</strong></p>
<p>å¯¹æ¯”ä¸€çœ‹ certsæ–‡ä»¶å¤¹å¥½åƒé‡å¤äº†ã€‚å¯ä»¥æ”¹ï¼Œè¿™æ · æ³¨é‡Šæ‰<code>- ./docker-compose/nginx/certs:/etc/nginx/certs</code></p>
<p>ç„¶åæŠŠpetapi.confå’Œpetclient.confé‡ŒåŠ è½½sslæ–‡ä»¶çš„è·¯å¾„ç”±ï¼š</p>
<pre><code class="language-conf">ssl_certificate /etc/nginx/certs/cert.pem;
ssl_certificate_key /etc/nginx/certs/key.pem;
</code></pre>
<p>æ”¹ä¸ºï¼š</p>
<pre><code class="language-yml">ssl_certificate /etc/nginx/conf.d/certs/cert.pem;
ssl_certificate_key /etc/nginx/conf.d/certs/key.pem;
</code></pre>
<p>nginxè§£æä»£ç†é…ç½®ï¼Œæ¯”å¦‚ï¼š</p>
<pre><code class="language-conf">location /some/path/ {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_pass http://localhost:8000;
}
</code></pre>
<p>å‚è€ƒï¼š<a href="https://docs.nginx.com/nginx/admin-guide/web-server/reverse-proxy/">NGINX Reverse Proxy</a></p>
<p>è¿˜æœ‰ä¸ªUpstream å‚è€ƒ <a href="https://docs.nginx.com/nginx/admin-guide/security-controls/securing-http-traffic-upstream/">Securing HTTP Traffic to Upstream Servers</a></p>
<p>ä»¥åŠ <a href="https://www.thepolyglotdeveloper.com/2017/03/nginx-reverse-proxy-containerized-docker-applications/">Use NGINX As A Reverse Proxy To Your Containerized Docker Applications</a></p>
<p>ä»¥åŠ <a href="https://www.freecodecamp.org/news/docker-nginx-letsencrypt-easy-secure-reverse-proxy-40165ba3aee2/">How to set up an easy and secure reverse proxy with Docker, Nginx &amp; Letsencrypt</a></p>
<h4 id="ç›®å‰å­˜åœ¨çš„bug">ç›®å‰å­˜åœ¨çš„bugï¼š</h4>
<p>ç½‘ç«™æ ‡é¢˜æ²¡æœ‰<img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/%E6%89%B9%E6%B3%A8%202020-07-20%20141957.png" alt="æ‰¹æ³¨ 2020-07-20 141957" loading="lazy"></p>
<p>privacyæ²¡æœ‰ã€å·²æ·»åŠ é¡µé¢ã€‘ï¼Œcontactä¹ˆæœ‰ã€ä¸è¦ã€‘ï¼Œfooteræ²¡æœ‰ã€å·²æ·»åŠ ã€‘ï¼Œé‚®ä»¶ ã€åæœŸç”³è¯·äº†æœåŠ¡åæ›´æ–°envæ–‡ä»¶å³å¯ã€‘jwtæ²¡é…ç½®ã€å·²é…ç½®ã€‘ï¼Œæ²¡å¼€queueã€è§ä¸‹æ–¹ã€‘ï¼Œrecaptchaæ²¡é…ç½®ã€å·²ç»è®¾ç½®ä¸ºç”±envæ–‡ä»¶é…ç½®ã€‘ã€‚</p>
<p>è‡³äºqueueï¼ŒåŸæœ¬æ‰“ç®—ä½¿ç”¨supervisordï¼Œä½†æ˜¯å‚è€ƒï¼š</p>
<p><a href="https://www.reddit.com/r/docker/comments/8zlakh/advice_best_approach_to_getting_supervisor_setup/">[Advice] Best approach to getting Supervisor setup with a docker compose setup?</a></p>
<blockquote>
<p>â€‹	There is no need for supervisor, just add another php service to your file (same volumes) and add a command line with your queue cmd.</p>
<pre><code class="language-yml">php-queue:
 restart: always
 image: php:7.2-fpm
 command: php artisan queue:work
 volumes:
        - ./www:/var/www
</code></pre>
<p>è¿™é‡Œé¢restart alwayså°±èƒ½ä¿è¯é‡å¯ç»´æŠ¤äº†ã€‚</p>
<p>If I wanted to have multiple works would I just setup multiple <code>php-queue</code> containers? Would I need to be concerned about running to many PHP containers on one server?</p>
<blockquote>
<p>If you mean multiple queues then i think that queue:work has a --queue argument so you can specify multiple queues.</p>
<p>If you mean multiple processes then you can use the <code>scale</code> argument in docker-compose, something like:</p>
<pre><code>docker-compose up -d --scale php-queue=3
</code></pre>
<p>For Swarm mode you can use the <a href="https://docs.docker.com/compose/compose-file/#replicas"><code>replicas</code></a> option.</p>
<p><a href="https://github.com/maitrungduc1410/docker-laravel-horizon-load-balancing">Option --scale webserver=3 will create 3 instances of <code>webserver</code> service (you can choose any number of instances you like)</a></p>
</blockquote>
<p>That is an interesting approach. How would you handle reboots and auto running the command?</p>
<blockquote>
<p>Thats what <a href="https://docs.docker.com/compose/compose-file/#restart"><code>restart: always</code></a> does, it will restart the container if it crashes and autostarts them on boot. If you are using Swarm then you should use <a href="https://docs.docker.com/compose/compose-file/#restart_policy">restart-policy</a> instead.</p>
</blockquote>
<p>I would spin up an new container for supervisor Just use the same app path</p>
<p>Remember you need an redis also</p>
</blockquote>
<p>å¦‚æœç¡®å®éœ€è¦supervisordå¯ä»¥å‚è€ƒ<a href="https://stackoverflow.com/a/57353086">How to keep Laravel Queue system running on server</a> ï¼Œä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨bashè„šæœ¬ï¼š<br>
<a href="https://laravel-news.com/laravel-scheduler-queue-docker">Running the Laravel Scheduler and Queue with Docker</a></p>
<p>æ‰€ä»¥æœ€åå®Œæˆç‰ˆæœ¬çš„docker-composer.prod.ymlå¦‚ä¸‹ï¼š</p>
<h2 id="ä¸ƒ-æ›´æ–°">ä¸ƒã€æ›´æ–°</h2>
<h3 id="updated-docker-compose-prodyml">Updated docker-compose-prod.yml</h3>
<pre><code class="language-yml">version: &quot;3.7&quot;
services:
  app:
    build:
      args:
        user: petapi
        uid: 1000
      context: ./
      dockerfile: Dockerfile
    image: petapii
    container_name: petapi-app
    restart: unless-stopped
    working_dir: /var/www/
    volumes:
      - ./:/var/www
    networks:
      - petapin
  php-queue:
    image: php:7.2.19-fpm
    container_name: petapi-app-queue
    command: php artisan queue:work
    working_dir: /var/www/
    restart: always
    volumes:
      - ./:/var/www
    networks:
      - petapin
  frontapp:
    build:
      context: ~/petclient/dockerfiles/node/
      dockerfile:  Dockerfile
    image: frontapp
    container_name: petclient-frontapp
    restart: unless-stopped
    working_dir: /app
    networks:
      - petclientn
  db:
    image: mysql:5.7
    container_name: petapi-db
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_USER: ${DB_USERNAME}
      SERVICE_TAGS: dev
      SERVICE_NAME: mysql
    volumes:
      - ./docker-compose/mysql:/docker-entrypoint-initdb.d
    networks:
      - petapin
  nginx:
    image: nginx:1.19.1-alpine
    container_name: pet-nginx
    restart: always
    depends_on:
      - app
      - frontapp
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./:/var/www
      - ./docker-compose/nginx:/etc/nginx/conf.d
      - ./docker-compose/nginx/certs:/etc/nginx/certs
    networks:
      - petapin
      - petclientn
networks:
  petapin:
    driver: bridge
  petclientn:
    driver: bridge
</code></pre>
<p>ç”±äºè¿›è¡Œäº†ä¸€äº›æºä»£ç çš„æ›´æ–°ï¼Œç‰¹åˆ«æ˜¯å‰ç«¯çš„ä»£ç ï¼Œæ‰€ä»¥è¿™é‡Œé¡ºå¸¦è®²è§£ä¸€ä¸‹ä»¥åä¹Ÿå¯ä»¥å‚è€ƒï¼Œå¦‚ä½•è¿›è¡Œæ›´æ–°ã€‚</p>
<p>è¯·å¼€å§‹å‰å‚è€ƒ [Updated docker-compose-prod.yml](#Updated docker-compose-prod.yml) æŠŠ<code>docker-compose-prod.yml</code> æ›´æ”¹å®Œæ¯•ã€‚</p>
<h3 id="ä¸ƒ-ä¸€-sqlæ•°æ®åº“è¿ç§»">ä¸ƒã€ï¼ˆä¸€ï¼‰ SQLæ•°æ®åº“è¿ç§»</h3>
<p>é¦–å…ˆæ˜¯åç«¯apiï¼Œå¦‚æœéœ€è¦å¤§æ›´æ–°ç‰¹åˆ«æ˜¯æ¶‰åŠåˆ°æ•°æ®åº“çš„ï¼Œsqlæ•°æ®åº“å¤‡ä»½å¾ˆé‡è¦ã€‚</p>
<p>ä¸¤ç§æ–¹å¼:</p>
<h5 id="ç¬¬ä¸€ç§æ‰‹åŠ¨ä¸ºäº†èµ°ä¸€éæµç¨‹">ç¬¬ä¸€ç§ï¼Œæ‰‹åŠ¨ã€ä¸ºäº†èµ°ä¸€éæµç¨‹ã€‘</h5>
<p>æ‰§è¡Œ<code>docker exec -it petapi-db bash</code>è¿›å…¥dbå®¹å™¨</p>
<figure data-type="image" tabindex="1"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/image-20200724023050297.png" alt="image-20200724023050297" loading="lazy"></figure>
<p>æ‰§è¡Œ<code>mysql -uroot -p</code> å¹¶è¾“å…¥å¯†ç ï¼Œç™»å½•æ•°æ®åº“</p>
<figure data-type="image" tabindex="2"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/image-20200724023113362.png" alt="" loading="lazy"></figure>
<p>ç™»å½•åæ‰§è¡Œ<code>show databases;</code>æ£€æŸ¥æ•°æ®åº“ï¼Œç„¶åç¡®è®¤æˆ‘ä»¬è¦å¤‡ä»½çš„æ•°æ®åº“</p>
<figure data-type="image" tabindex="3"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/image-20200724023211774.png" alt="" loading="lazy"></figure>
<p>æ¥ä¸‹æ¥æ‰§è¡Œ<code>exit</code>é€€å‡ºæ•°æ®åº“ç™»å½•ï¼Œ</p>
<p>åœ¨dbå®¹å™¨shellæ‰§è¡Œ<code>mysqldump -uroot -p ***api &gt; backup.sql</code> å°±å¯ä»¥äº†ï¼Œæ ¼å¼å‚è€ƒ<a href="https://blog.shanelee.name/2017/04/09/how-to-import-and-export-databases-in-mysql-or-mariadb-with-docker/">How To Import and Export Databases in MySQL or MariaDB with Docker</a>ä¸ºï¼š</p>
<pre><code class="language-bash">mysqldump -u username -p database_name &gt; dump.sql  
</code></pre>
<figure data-type="image" tabindex="4"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/image-20200724023446387.png" alt="" loading="lazy"></figure>
<p>å¯ä»¥æ‰§è¡Œ<code>head -n 5 backup.sql</code> æ£€æŸ¥ç»“æœï¼›<code>5</code>ä¸å¤Ÿå¯ä»¥è®¾ç½®<code>20</code></p>
<figure data-type="image" tabindex="5"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/image-20200724023737718.png" alt="" loading="lazy"></figure>
<p>ç”±äºæˆ‘ä»¬çš„dbå®¹å™¨æŠŠæ•°æ®å·è®¾ç½®åœ¨äº†<code>docker-entrypoint-initdb.d</code>æ–‡ä»¶å¤¹é‡Œï¼Œæ‰€ä»¥æœ€å¥½æ˜¯å¤‡ä»½åˆ°è¿™æ–‡ä»¶å¤¹é‡Œã€‚è¿™æ ·å®¿ä¸»æœºå¤‡ä»½åï¼Œå®¿ä¸»æœºå¯ä»¥ç›´æ¥æ‹¿åˆ°ï¼Œè¿™é‡Œæˆ‘å°±ç›´æ¥ç»™mvåˆ°æ–‡ä»¶å¤¹é‡Œå»äº†ã€‚</p>
<p><code>exit</code>é€€å‡ºå®¹å™¨ï¼Œç„¶åå°±å¯ä»¥åœ¨å®¿ä¸»æœº <code>docker-compose.prod.yml</code>çš„ä¸Šä¸‹æ–‡<code>./docker-compose/mysql</code>æ–‡ä»¶å¤¹è·¯å¾„é‡Œçœ‹åˆ°æˆ‘ä»¬åˆšdumpæ‰“åŒ…çš„æ•°æ®åº“å¤‡ä»½æ–‡ä»¶äº†ã€‚</p>
<figure data-type="image" tabindex="6"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/image-20200724024534310.png" alt="" loading="lazy"></figure>
<p>æ¥ä¸‹æ¥å°±æ˜¯<a href="#%E4%BA%94%E3%80%81mysql">å‚è€ƒä¹‹å‰çš„å¯¼å…¥æ–¹æ³•</a>å¯¼å…¥åˆ°æ–°æ•°æ®åº“å³å¯ã€‚</p>
<h5 id="ç¬¬äºŒç§ä½¿ç”¨databackmysql-backup">ç¬¬äºŒç§ï¼Œä½¿ç”¨<a href="https://hub.docker.com/r/databack/mysql-backup">databack/mysql-backup</a></h5>
<p>å»ºè®®ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œå› ä¸ºå¯ä»¥è‡ªåŠ¨æ‰§è¡Œå¤‡ä»½ã€‚å³ä½¿ä¸è¿ç§»ï¼Œå¹³æ—¶çš„è¿ç»´ä¹Ÿåº”è¯¥è¿™ä¹ˆåšå¥½å¤‡ä»½æ¯”è¾ƒå®‰å…¨ã€‚å¤‡ä»½å®Œæˆä¹‹åï¼Œå»ºè®®ç›´æ¥å‘é€æˆ–ä¸Šä¼ åˆ°åº“ã€‚</p>
<h3 id="ä¸ƒ-äºŒpull-æ›´æ–°åçš„laravel-apiåç«¯ä»£ç ">ä¸ƒã€ï¼ˆäºŒï¼‰pull æ›´æ–°åçš„laravel apiåç«¯ä»£ç </h3>
<p>å…¶å®å°±æ˜¯é‡å¤æ“ä½œ <a href="#%E4%B8%89%E3%80%81laravel%E5%8F%91%E5%B8%83%E9%9C%80%E8%A6%81%E5%87%86%E5%A4%87%E7%9A%84%E6%96%87%E4%BB%B6%E5%92%8C%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E8%A6%81%E5%81%9A%E7%9A%84%E4%B8%80%E4%BA%9B%E6%93%8D%E4%BD%9C">ä¸‰ã€laravelå‘å¸ƒéœ€è¦å‡†å¤‡çš„æ–‡ä»¶å’Œç”Ÿäº§ç¯å¢ƒè¦åšçš„ä¸€äº›æ“ä½œ</a></p>
<h3 id="ä¸ƒ-ä¸‰-å‰ç«¯éƒ¨åˆ†">ä¸ƒã€ï¼ˆä¸‰ï¼‰ å‰ç«¯éƒ¨åˆ†</h3>
<p>æ•´ä½“æ¥è¯´å¯ä»¥å‚è€ƒ<a href="#%E5%9B%9B%E3%80%81nuxt%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91">å››ã€nuxté‡åˆ°çš„å‘</a> ï¼Œè¿™é‡Œå½“ç„¶è¯¦ç»†è®²è§£ä¸€ä¸‹ã€‚</p>
<p>é¦–å…ˆæ˜¯æŠŠä»£ç æ›´æ–°åˆ°githubã€‚</p>
<p>æ‰§è¡Œ <code>ssh user_name@server_ip_address</code>ç™»å½•åˆ°æœåŠ¡å™¨ã€‚</p>
<p>nodeçš„Dockerfileä¸éœ€è¦æ›´æ–°äº†ã€‚</p>
<p>æˆ‘ä»¬ç›´æ¥åˆ‡åˆ° <a href="#node%E5%AE%B9%E5%99%A8Dockerfile">nodeå®¹å™¨Dockerfile</a> ä¸Šä¸‹æ–‡çš„è·¯å¾„ <code>./pet-client</code>ä¸‹ï¼Œå‚è€ƒ [<code>docker-compose.prod.yml</code>](#Updated docker-compose-prod.yml)ä¸­frontappéƒ¨åˆ†å®šä¹‰çš„context:<code>context: ~/petclient/dockerfiles/node/</code> ï¼Œå³åˆ‡æ¢åˆ°çš„è·¯å¾„æ˜¯<code>~/petclient/dockerfiles/node/pet-client</code> è¿™é‡Œé¢å°±æ˜¯æˆ‘ä»¬å‰ç«¯ä»£ç å­˜æ”¾çš„ä½ç½®äº†ã€‚</p>
<p>åœ¨ <code>~/petclient/dockerfiles/node/</code>è¿™ä¸ªè·¯å¾„ä¸‹æ‰§è¡Œï¼š<code>rm -rf pets-client/</code>åˆ é™¤æ‰å‰ç«¯ä»£ç ï¼Œå› ä¸ºæˆ‘ä»¬çš„å®¹å™¨é•œåƒï¼Œæ‰“åŒ…çš„æ—¶å€™æ˜¯ç›´æ¥COPYåˆ°å®¹å™¨å†…çš„ã€‚æ›´æ–°çš„æ—¶å€™ï¼Œåˆ é™¤è¿™ä¸ªæ–‡ä»¶å¤¹ï¼Œç„¶åç¨ååˆ é™¤é•œåƒï¼Œé‡æ–°æ‰“åŒ…å¯åŠ¨å³å¯ã€‚</p>
<p>ç„¶åæ‰§è¡Œ <code>git clone https://github.com/****/******.git</code> æŠŠä»£ç æ‹‰åˆ°å®¿ä¸»æœºå†…ã€‚å¦‚æœå·²ç»cloneè¿‡çš„ å¯ä»¥<code>git pull https://github.com/****/******.git</code>è¿›è¡Œupdateã€‚</p>
<p>ç„¶ååˆ‡æ¢åˆ°<code>docker-compose.prod.yml</code>æ‰€åœ¨æ–‡ä»¶å¤¹è·¯å¾„ä¸‹æ‰§è¡Œ: <code>docker-compose -f docker-compose.prod.yml down</code>å…³é—­æ‰€æœ‰æœåŠ¡ã€‚</p>
<figure data-type="image" tabindex="7"><img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/image-20200724141740430.png" alt="" loading="lazy"></figure>
<blockquote>
<p>è¿™ä¸ªè­¦å‘Šæ˜¯å› ä¸ºæˆ‘ä»¬ç¼–è¾‘è¿‡<code>docker-compose.prod.yml</code>ï¼Œä½†æ˜¯è¿è¡Œçš„æœåŠ¡å¹¶ä¸æ˜¯è¿™ä¸ªç¼–è¾‘è¿‡çš„ã€‚ä»¥åæœ€å¥½æ˜¯å…¨éƒ¨åœäº†ä¹‹åï¼Œå†ç¼–è¾‘ã€‚</p>
</blockquote>
<p>æ¥ä¸‹æ¥æ‰§è¡Œ <code>docker ps -a</code>æŸ¥çœ‹å®¹å™¨ï¼Œç§»é™¤æ‰æ—§ç‰ˆæœ¬çš„å®¹å™¨ã€‚</p>
<p>æ¥ä¸‹æ¥æ‰§è¡Œ <code>docker images</code>æŸ¥çœ‹é•œåƒï¼Œç„¶åæ‰§è¡Œ<code>docker rmi é•œåƒå</code>çš„æ–¹å¼ç§»é™¤æ‰nodeï¼Œfrontappé•œåƒï¼Œ</p>
<p>ç„¶åæ‰§è¡Œ<code>docker-compose -f docker-compose.prod.yml build frontapp</code> æ„å»ºfrontappçš„é•œåƒã€‚</p>
<p>æ„å»ºå®Œæˆ æ‰§è¡Œ <code>docker-compose -f docker-compose.prod.yml up -d</code>å³å¯ã€‚</p>
<p>å®¹å™¨å®Œå…¨æ„å»ºå¥½äº†å¹¶å¯åŠ¨ä¹‹åï¼Œç»§ç»­ä¸‹é¢çš„æ“ä½œã€‚</p>
<h3 id="ä¸ƒ-å››é…ç½®envæ–‡ä»¶">ä¸ƒã€ï¼ˆå››ï¼‰é…ç½®.envæ–‡ä»¶</h3>
<blockquote>
<p><strong>å¦‚æœdocker-compose.ymlæ–‡ä»¶å’ŒDockerfileæå‰éœ€è¦.envæ–‡ä»¶ä¸­è®¾ç½®çš„å€¼ï¼Œé‚£æ­¤æ­¥éª¤éœ€è¦åœ¨buildå‰æ“ä½œã€‚</strong></p>
<p>å› ä¸ºåç«¯apiæ˜¯æ•°æ®å·æŒ‚è½½åˆ°å®¹å™¨å†…çš„ï¼Œæ‰€ä»¥.envæ–‡ä»¶å¯ä»¥å®¿ä¸»æœºé‡Œç¼–è¾‘ã€‚</p>
<p>frontappæ˜¯COPYåˆ°å®¹å™¨å†…çš„ï¼Œæ‰€ä»¥éœ€è¦åˆ‡æ¢åˆ°å®¹å™¨å†…ï¼Œæˆ–è€…<strong>åœ¨buildå‰å»ºç«‹å¥½ï¼Œbuildæ‰§è¡Œçš„æ—¶å€™ç›´æ¥COPYåˆ°å®¹å™¨å†…äº†</strong>ï¼Œå»ºè®®æå‰åœ¨petclientè¢«cloneåˆ°æœ¬åœ°åå°±ç¼–è¾‘å¥½ã€‚</p>
<p>å¦‚æœæ˜¯éœ€è¦å®¹å™¨å†…ä¿®æ”¹ï¼Œ</p>
<p>æ‰§è¡Œ<code>docker exec -it petclient-frontapp bash</code>è¿›å…¥å®¹å™¨å†…ã€‚</p>
<p>æ‰§è¡Œ vi .env ç„¶åç¼–è¾‘ç„¶åä¿å­˜é€€å‡ºã€‚</p>
</blockquote>
<p>å®Œæˆã€‚</p>
<p>è¡¥å……ï¼Œæœ€å¥½ç²¾ç®€ä¸€ä¸‹css åŠ jsä»£ç ã€‚</p>
<h3 id="ä¸ƒ-äº”å‚è€ƒmysql-dockerå®¹å™¨å…³äºå¦‚ä½•å¤„ç†downåupæ•°æ®å°±ä¸¢å¤±çš„é—®é¢˜ä»¥åŠåŸç†-é˜²æ­¢æ¯æ¬¡é‡æ–°é…ç½®æ•°æ®åº“">ä¸ƒã€ï¼ˆäº”ï¼‰å‚è€ƒ<a href="https://dzkjz.github.io/post/mysql-docker-rong-qi-guan-yu-ru-he-chu-li-down-hou-up-shu-ju-jiu-diu-shi-de-wen-ti-yi-ji-yuan-li/">Mysql Dockerå®¹å™¨å…³äºå¦‚ä½•å¤„ç†downåupæ•°æ®å°±ä¸¢å¤±çš„é—®é¢˜ä»¥åŠåŸç†</a> é˜²æ­¢æ¯æ¬¡é‡æ–°é…ç½®æ•°æ®åº“</h3>
<p><code>docker-compose.prod.yml</code>æ›´æ–°ä¸ºï¼š</p>
<pre><code class="language-yml">version: &quot;3.7&quot;
services:
  app:
    build:
      args:
        user: petapi
        uid: 1000
      context: ./
      dockerfile: Dockerfile
    image: petapii
    container_name: petapi-app
    restart: unless-stopped
    working_dir: /var/www/
    volumes:
      - ./:/var/www
    networks:
      - petapin
  php-queue:
    restart: always
    container_name: petapi-app-queue
    working_dir: /var/www/
    image: php:7.2.19-fpm
    command: php artisan queue:work
    volumes:
      - ./:/var/www
    networks:
      - petapin
  frontapp:
    build:
      context: ~/petclient/dockerfiles/node/
      dockerfile:  Dockerfile
    image: frontapp
    container_name: petclient-frontapp
    restart: unless-stopped
    networks:
      - petclientn
  db:
    image: mysql:5.7
    container_name: petapi-db
    restart: unless-stopped
    env_file:
      - ~/petapi/pets-api/.env
    environment:
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_USER: ${DB_USERNAME}
      SERVICE_TAGS: dev
      SERVICE_NAME: mysql
    volumes:
      - ./docker-compose/mysql:/docker-entrypoint-initdb.d
      - ./docker-compose/mysql/data:/var/lib/mysql
    networks:
      - petapin
  nginx:
    image: nginx:1.19.1-alpine
    container_name: pet-nginx
    restart: always
    depends_on:
      - app
      - frontapp
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./:/var/www
      - ./docker-compose/nginx:/etc/nginx/conf.d
      - ./docker-compose/nginx/certs:/etc/nginx/certs
    networks:
      - petapin
      - petclientn
networks:
  petapin:
    driver: bridge
  petclientn:
    driver: bridge
</code></pre>
<h2 id="å…«-ssl-cronjob-ä¸-supervisorä»‹ç»">å…«ã€ssl cronJob ä¸ supervisorä»‹ç»</h2>
]]></content>
    </entry>
</feed>