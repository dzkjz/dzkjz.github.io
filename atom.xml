<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://dzkjz.github.io/</id>
    <title>JojoLegend</title>
    <updated>2020-07-20T06:23:25.690Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://dzkjz.github.io/"/>
    <link rel="self" href="https://dzkjz.github.io/atom.xml"/>
    <subtitle>Something for age</subtitle>
    <logo>https://dzkjz.github.io/images/avatar.png</logo>
    <icon>https://dzkjz.github.io/favicon.ico</icon>
    <rights>All rights reserved 2020, JojoLegend</rights>
    <entry>
        <title type="html"><![CDATA[æ€»ç»“nuxt laravel nginx mysql docker ubuntuéƒ¨ç½²çš„æµç¨‹]]></title>
        <id>https://dzkjz.github.io/post/zong-jie-nuxt-laravel-nginx-mysql-docker-ubuntu-bu-shu-de-liu-cheng/</id>
        <link href="https://dzkjz.github.io/post/zong-jie-nuxt-laravel-nginx-mysql-docker-ubuntu-bu-shu-de-liu-cheng/">
        </link>
        <updated>2020-07-19T06:40:35.000Z</updated>
        <content type="html"><![CDATA[<p>æ€»ç»“åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li>
<p>docker</p>
</li>
<li>
<p>docker-compose</p>
</li>
<li>
<p>æ³¨æ„äº‹é¡¹</p>
</li>
<li>
<p>laravelå‘å¸ƒéœ€è¦å‡†å¤‡çš„æ–‡ä»¶å’Œç”Ÿäº§ç¯å¢ƒè¦åšçš„ä¸€äº›æ“ä½œ</p>
</li>
<li>
<p>nuxté‡åˆ°çš„å‘</p>
</li>
<li>
<p>mysql</p>
</li>
<li>
<p>nginx</p>
</li>
</ol>
<h2 id="ä¸€-docker">ä¸€ã€Docker</h2>
<p>ä»€ä¹ˆæ˜¯dockerå¯ä»¥å‚è€ƒ:<a href="https://yeasy.gitbook.io/docker_practice/introduction/what">ä»€ä¹ˆæ˜¯ Docker</a></p>
<p>åœ¨è¿›è¡Œä¸‹é¢çš„æ“ä½œä¹‹å‰ï¼Œè¯·å…ˆ<a href="https://yeasy.gitbook.io/docker_practice/install">å®‰è£…Docker </a></p>
<p>é’ˆå¯¹è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯ï¼š</p>
<ol>
<li>ä¸€ä¸ªå®¹å™¨è¿è¡Œnginx</li>
<li>ä¸€ä¸ªå®¹å™¨è¿è¡Œphp-fpm</li>
<li>ä¸€ä¸ªå®¹å™¨è¿è¡Œmysql</li>
<li>ä¸€ä¸ªå®¹å™¨è¿è¡Œnode</li>
</ol>
<p>å››ä¸ªå®¹å™¨ï¼š</p>
<ul>
<li>
<p>nginxå’Œmysqlå®¹å™¨å¯ä»¥ç›´æ¥ç”¨å®˜æ–¹çš„é•œåƒã€‚<em>æ‰€ä»¥è¿™ä¸¤ä¸ªå®¹å™¨ä¸éœ€è¦Dockerfile</em>ï¼›</p>
</li>
<li>
<p>php-fpmå®¹å™¨ ä¸»è¦æ˜¯è¿è¡Œ laravelï¼›</p>
</li>
<li>
<p>å¦å¤–éœ€è¦ä¸€ä¸ªä¸´æ—¶å®¹å™¨ç»™å®‰è£…composerï¼Œå®‰è£…å®Œæˆååˆ é™¤è¿™ä¸ªä¸´æ—¶å®¹å™¨å°±è¡Œï¼›</p>
</li>
<li>
<p>nodeå®¹å™¨ç”¨äºè¿è¡Œnuxtã€‚</p>
</li>
</ul>
<p>php-fpmå®¹å™¨æˆ‘ä»¬éœ€è¦å®‰è£…ä¸€äº›æ‰©å±•åŒ…ï¼Œæ‰§è¡Œcomposerå®‰è£…ï¼Œæ‰€ä»¥ç”¨Dockerfileé…ç½®ï¼š</p>
<p>æ›´å¤šDockerfileé…ç½®çš„æŒ‡ä»¤ä»‹ç»å‚è€ƒï¼š<a href="https://yeasy.gitbook.io/docker_practice/image/build">ä½¿ç”¨ Dockerfile å®šåˆ¶é•œåƒ</a></p>
<p>è¯·æ³¨æ„æ•™ç¨‹ä¸­çš„</p>
<blockquote>
<p>æ­¤å¤–ï¼Œè¿˜å¯ä»¥çœ‹åˆ°è¿™ä¸€ç»„å‘½ä»¤çš„æœ€åæ·»åŠ äº†æ¸…ç†å·¥ä½œçš„å‘½ä»¤ï¼Œåˆ é™¤äº†ä¸ºäº†ç¼–è¯‘æ„å»ºæ‰€éœ€è¦çš„è½¯ä»¶ï¼Œæ¸…ç†äº†æ‰€æœ‰ä¸‹è½½ã€å±•å¼€çš„æ–‡ä»¶ï¼Œå¹¶ä¸”è¿˜æ¸…ç†äº† <code>apt</code> ç¼“å­˜æ–‡ä»¶ã€‚è¿™æ˜¯å¾ˆé‡è¦çš„ä¸€æ­¥ï¼Œæˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼Œé•œåƒæ˜¯å¤šå±‚å­˜å‚¨ï¼Œæ¯ä¸€å±‚çš„ä¸œè¥¿å¹¶ä¸ä¼šåœ¨ä¸‹ä¸€å±‚è¢«åˆ é™¤ï¼Œä¼šä¸€ç›´è·Ÿéšç€é•œåƒã€‚å› æ­¤é•œåƒæ„å»ºæ—¶ï¼Œä¸€å®šè¦ç¡®ä¿æ¯ä¸€å±‚åªæ·»åŠ çœŸæ­£éœ€è¦æ·»åŠ çš„ä¸œè¥¿ï¼Œä»»ä½•æ— å…³çš„ä¸œè¥¿éƒ½åº”è¯¥æ¸…ç†æ‰ã€‚</p>
<p><strong>å¾ˆå¤šäººåˆå­¦ Docker åˆ¶ä½œå‡ºäº†å¾ˆè‡ƒè‚¿çš„é•œåƒçš„åŸå› ä¹‹ä¸€ï¼Œå°±æ˜¯å¿˜è®°äº†æ¯ä¸€å±‚æ„å»ºçš„æœ€åä¸€å®šè¦æ¸…ç†æ‰æ— å…³æ–‡ä»¶ã€‚</strong></p>
</blockquote>
<p>ä»¥åŠå¯¹è·¯å¾„ä¸Šä¸‹æ–‡çš„è§£é‡Š</p>
<blockquote>
<h3 id="é•œåƒæ„å»ºä¸Šä¸‹æ–‡context"><a href="https://yeasy.gitbook.io/docker_practice/image/build#jing-xiang-gou-jian-shang-xia-wen-context">é•œåƒæ„å»ºä¸Šä¸‹æ–‡ï¼ˆContextï¼‰</a></h3>
<p>è¿™ä¸ªä¹Ÿæ˜¯å¾ˆå¥‡è‘©çš„ï¼Œåˆå­¦çš„æ—¶å€™ï¼Œæ˜¯å•çº¯çš„è®¤ä¸º ä¸‹é¢è¿™ä¸ªå‘½ä»¤</p>
<p>COPY ./somefiles /var/www</p>
<p>å°±æ˜¯å¤åˆ¶Dockerfileæ‰€åœ¨çš„æ–‡ä»¶å¤¹ä¸‹somefilesæ–‡ä»¶å¤¹åŠå…¶å†…éƒ¨æ–‡ä»¶åˆ° æ­¤é•œåƒæ„å»ºçš„å®¹å™¨å†…çš„ /var/wwwç›®å½•é‡Œã€‚</p>
<p>ä½†æ˜¯è¿™ä¹ˆç†è§£ä¼šå‡ºé—®é¢˜ï¼Œé¦–å…ˆï¼Œå¯ä»¥ç”¨~/sub/fab/docker/somotherfiles/ è¿™ä¹ˆæŒ‡å®šå®¿ä¸»æœºæ–‡ä»¶å¤¹è·¯å¾„å—ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯ä¸è¡Œçš„ã€‚ä¼šæŠ¥é”™æ‰¾ä¸åˆ°ã€‚</p>
<p>ç„¶åï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ ../this/somefiles/æŒ‡å®šå®¿ä¸»æœºæ–‡ä»¶å¤¹è·¯å¾„å—ï¼Ÿ</p>
<p>ç­”æ¡ˆä¹Ÿæ˜¯ä¸è¡Œçš„ï¼Œä¹Ÿæ˜¯æŠ¥é”™æ‰¾ä¸åˆ°ã€‚</p>
<p>å…·ä½“æ¶‰åŠåˆ°çš„æ˜¯ Docker å¼•æ“ï¼Œå…·ä½“çœ‹æ•™ç¨‹è§£é‡Šï¼Œä¸è¿‡å¯ä»¥ç®€å•çš„è¿™ä¹ˆè¯´ï¼Œå°±æ˜¯æ„å»ºçš„æ—¶å€™ï¼Œåªæ‰“åŒ…dockerfileæ–‡ä»¶è·¯å¾„ä¸‹çš„<strong>æ‰€æœ‰å†…å®¹</strong>ä¼ åˆ°dockerå¼•æ“ï¼Œæ‰€ä»¥æ˜¯ä¸åŒ…å«å¤–éƒ¨çš„ä»¥åŠå¯ä»¥ç”¨~æŒ‡å®šçš„è·¯å¾„ä¸‹çš„ã€‚åŒæ—¶ä¹Ÿè¦æ³¨æ„ï¼Œè¿™ä¸ªdockerfileæ–‡ä»¶æ‰“åŒ…çš„æ‰€æœ‰å†…å®¹å¦‚æœä½ ç»™çš„æ–‡ä»¶å¤ªå¤§äº†ï¼Œé‚£ä¼ è¾“èµ·æ¥å°±ç‰›äº†ï¼Œæœ‰çš„å‡ åä¸ªGB ä¼ è¾“å¾ˆå¤´ç–¼çš„ï¼Œæ‰€ä»¥éœ€è¦æ³¨æ„ï¼Œdockerfileæ‰€åœ¨æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶å†…å®¹ï¼Œåªç•™ä¸‹éœ€è¦çš„ã€‚</p>
<p>è¿˜æœ‰ä¸Šé¢æ˜¯ç¬¼ç»Ÿçš„è¯´æˆæ˜¯dockerfileæ–‡ä»¶æ‰€åœ¨æ–‡ä»¶å¤¹ï¼Œå…¶å®ä¹Ÿæ˜¯ä¸å®Œå…¨æ­£ç¡®çš„ã€‚</p>
<p>å› ä¸ºå¯ä»¥ -f ../Dockerfilev3 è¿™ä¹ˆæŒ‡å®šéœ€è¦çš„Dockerfile é¦–å…ˆè·¯å¾„åœ¨å¤–é¢ï¼Œç„¶ååå­—ä¹Ÿä¸åŒï¼Œä¸è¿‡ä¸€èˆ¬æƒ…å†µä¸è¿™ä¹ˆå¹²ã€‚é»˜è®¤çŠ¶æ€ä¸‹å‰é¢è¯´çš„ä¸ä¸¥è°¨ä½†ä¹Ÿå¯ä»¥æ˜¯å¯¹çš„ã€‚è¿˜æœ‰<a href="https://yeasy.gitbook.io/docker_practice/image/build#qi-ta-docker-build-de-yong-fa">å…¶å®ƒ <code>docker build</code> çš„ç”¨æ³•ã€‚</a></p>
</blockquote>
<pre><code class="language-yml">FROM php:7.2.19-fpm #æŒ‡å®š åŸºç¡€é•œåƒ

# Arguments defined in docker-compose.yml
ARG user #å®šä¹‰å‚æ•°
ARG uid  #å®šä¹‰å‚æ•°

# Install system dependencies å®‰è£…ç³»ç»Ÿä¾èµ– #RUN æŒ‡ä»¤æ˜¯ç”¨æ¥æ‰§è¡Œå‘½ä»¤è¡Œå‘½ä»¤çš„
# Dockerfile æ”¯æŒ Shell ç±»çš„è¡Œå°¾æ·»åŠ  \ çš„å‘½ä»¤æ¢è¡Œæ–¹å¼ï¼Œä»¥åŠè¡Œé¦– # è¿›è¡Œæ³¨é‡Šçš„æ ¼å¼
RUN apt-get update &amp;&amp; apt-get install -y \
    git \
    curl \
    libpng-dev \
    libonig-dev \
    libxml2-dev \
    zip \
    unzip


# Clear cache æ¸…ç†cache
RUN apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/* #ä½¿ç”¨ &amp;&amp; å°†å„ä¸ªæ‰€éœ€å‘½ä»¤ä¸²è”èµ·æ¥

# Install PHP extensions å®‰è£…æ‰©å±•
RUN docker-php-ext-install pdo_mysql mbstring exif pcntl bcmath gd

# Get latest Composer è¿™é‡Œæ˜¯æŠŠcomposerç»™å¤åˆ¶åˆ° æœ¬Dockerfileå®šä¹‰çš„å®¹å™¨çš„ /usr/bin/composeré‡Œ
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Create system user to run Composer and Artisan Commands
# åˆ›å»ºç³»ç»Ÿç”¨æˆ·ç”¨äºæ‰§è¡Œ composerå’Œ artisan å‘½ä»¤ å®é™…æ˜¯ç»™æƒé™ã€‚
RUN useradd -G www-data,root -u $uid -d /home/$user $user
RUN mkdir -p /home/$user/.composer &amp;&amp; \
    chown -R $user:$user /home/$user

# Set working directory æœ¬å®¹å™¨çš„å·¥ä½œæ–‡ä»¶å¤¹
WORKDIR /var/www

USER $user #è®¾ç½®å®¹å™¨çš„ç”¨æˆ·

</code></pre>
<blockquote>
<p>éœ€è¦äº†è§£æ›´å¤šæŒ‡ä»¤å¯ä»¥å‚è€ƒï¼š</p>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/copy">COPY å¤åˆ¶æ–‡ä»¶</a></p>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/add">ADD æ›´é«˜çº§çš„å¤åˆ¶æ–‡ä»¶</a></p>
<p>[Dockerfile æœ€ä½³å®è·µæ–‡æ¡£](Dockerfile æœ€ä½³å®è·µæ–‡æ¡£)</p>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/cmd">CMD å®¹å™¨å¯åŠ¨å‘½ä»¤</a></p>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/entrypoint">ENTRYPOINT å…¥å£ç‚¹</a></p>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/env">ENV è®¾ç½®ç¯å¢ƒå˜é‡</a></p>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/arg">ARG æ„å»ºå‚æ•°</a></p>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/volume">VOLUME å®šä¹‰åŒ¿åå·</a> ä¸Šé¢çš„dockerfileæ²¡æœ‰æŒ‚è½½æ•°æ®å·åˆ°å®¹å™¨å†…ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨docker-composeé‡ŒæŒ‚è½½äº†ï¼Œåé¢è®²ã€‚</p>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/expose">EXPOSE æš´éœ²ç«¯å£</a> <code>EXPOSE</code> æŒ‡ä»¤æ˜¯å£°æ˜è¿è¡Œæ—¶å®¹å™¨æä¾›æœåŠ¡ç«¯å£ï¼Œè¿™åªæ˜¯ä¸€ä¸ªå£°æ˜ï¼Œåœ¨è¿è¡Œæ—¶å¹¶ä¸ä¼šå› ä¸ºè¿™ä¸ªå£°æ˜åº”ç”¨å°±ä¼šå¼€å¯è¿™ä¸ªç«¯å£çš„æœåŠ¡ï¼Œ æ˜ç¡® -Péšæœºæ˜ å°„ç«¯å£æ—¶ä¼šæ˜ å°„åˆ°EXPOSEçš„ç«¯å£ï¼Œ-pæŒ‡å®šæ—¶ï¼Œæ˜¯æŒ‰-pæŒ‡å®šçš„æ¥ã€‚</p>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/workdir">WORKDIR æŒ‡å®šå·¥ä½œç›®å½•</a></p>
<p><strong>è¯·æ³¨æ„<code>Dockerfile</code> æ„å»ºåˆ†å±‚å­˜å‚¨çš„æ¦‚å¿µã€‚</strong></p>
<p>æ¯ä¸€ä¸ª <code>RUN</code> éƒ½æ˜¯å¯åŠ¨ä¸€ä¸ªå®¹å™¨ã€æ‰§è¡Œå‘½ä»¤ã€ç„¶åæäº¤å­˜å‚¨å±‚æ–‡ä»¶å˜æ›´ã€‚</p>
<blockquote>
<pre><code class="language-yml">RUN cd /app
RUN echo &quot;hello&quot; &gt; world.txt
</code></pre>
<p>å¦‚æœå°†è¿™ä¸ª <code>Dockerfile</code> è¿›è¡Œæ„å»ºé•œåƒè¿è¡Œåï¼Œä¼šå‘ç°æ‰¾ä¸åˆ° <code>/app/world.txt</code> æ–‡ä»¶ï¼Œæˆ–è€…å…¶å†…å®¹ä¸æ˜¯ <code>hello</code></p>
<p>ç¬¬ä¸€å±‚ <code>RUN cd /app</code> çš„æ‰§è¡Œä»…ä»…æ˜¯å½“å‰è¿›ç¨‹çš„å·¥ä½œç›®å½•å˜æ›´ï¼Œä¸€ä¸ªå†…å­˜ä¸Šçš„å˜åŒ–è€Œå·²ï¼Œå…¶ç»“æœä¸ä¼šé€ æˆä»»ä½•æ–‡ä»¶å˜æ›´ã€‚è€Œåˆ°ç¬¬äºŒå±‚çš„æ—¶å€™ï¼Œå¯åŠ¨çš„æ˜¯ä¸€ä¸ªå…¨æ–°çš„å®¹å™¨ï¼Œè·Ÿç¬¬ä¸€å±‚çš„å®¹å™¨æ›´å®Œå…¨æ²¡å…³ç³»ï¼Œè‡ªç„¶ä¸å¯èƒ½ç»§æ‰¿å‰ä¸€å±‚æ„å»ºè¿‡ç¨‹ä¸­çš„å†…å­˜å˜åŒ–ã€‚</p>
</blockquote>
<p>å› æ­¤å¦‚æœéœ€è¦æ”¹å˜ä»¥åå„å±‚çš„å·¥ä½œç›®å½•çš„ä½ç½®ï¼Œé‚£ä¹ˆåº”è¯¥ä½¿ç”¨ <code>WORKDIR</code> æŒ‡ä»¤ã€‚</p>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/user">USER æŒ‡å®šå½“å‰ç”¨æˆ·</a></p>
<blockquote>
<p><code>USER</code> æŒ‡ä»¤å’Œ <code>WORKDIR</code> ç›¸ä¼¼ï¼Œéƒ½æ˜¯æ”¹å˜ç¯å¢ƒçŠ¶æ€å¹¶å½±å“ä»¥åçš„å±‚ã€‚<code>WORKDIR</code> æ˜¯æ”¹å˜å·¥ä½œç›®å½•ï¼Œ<code>USER</code> åˆ™æ˜¯æ”¹å˜ä¹‹åå±‚çš„æ‰§è¡Œ <code>RUN</code>, <code>CMD</code> ä»¥åŠ <code>ENTRYPOINT</code> è¿™ç±»å‘½ä»¤çš„èº«ä»½ã€‚</p>
<p><code>USER</code> åªæ˜¯å¸®åŠ©ä½ åˆ‡æ¢åˆ°æŒ‡å®šç”¨æˆ·è€Œå·²ï¼Œè¿™ä¸ªç”¨æˆ·å¿…é¡»æ˜¯äº‹å…ˆå»ºç«‹å¥½çš„ï¼Œå¦åˆ™æ— æ³•åˆ‡æ¢ã€‚</p>
</blockquote>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/healthcheck">HEALTHCHECK å¥åº·æ£€æŸ¥</a></p>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/onbuild">ONBUILD ä¸ºä»–äººä½œå«è¡£è£³</a></p>
<blockquote>
<p><code>ONBUILD</code> æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æŒ‡ä»¤ï¼Œå®ƒåé¢è·Ÿçš„æ˜¯å…¶å®ƒæŒ‡ä»¤ï¼Œæ¯”å¦‚ <code>RUN</code>, <code>COPY</code> ç­‰ï¼Œè€Œè¿™äº›æŒ‡ä»¤ï¼Œåœ¨å½“å‰é•œåƒæ„å»ºæ—¶å¹¶ä¸ä¼šè¢«æ‰§è¡Œã€‚åªæœ‰å½“ä»¥å½“å‰é•œåƒä¸ºåŸºç¡€é•œåƒï¼Œå»æ„å»ºä¸‹ä¸€çº§é•œåƒçš„æ—¶å€™æ‰ä¼šè¢«æ‰§è¡Œã€‚</p>
</blockquote>
<p><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/references">å‚è€ƒæ–‡æ¡£</a></p>
</blockquote>
<p>laravelè¿è¡Œçš„php-fpmå®¹å™¨Dockerfileé…ç½®å¥½ä¹‹åï¼Œæ¥ä¸‹æ¥æ˜¯é…ç½®å‰ç«¯nuxtéœ€è¦çš„nodeå®¹å™¨ã€‚</p>
<h5 id="nodeå®¹å™¨dockerfile">nodeå®¹å™¨Dockerfile</h5>
<pre><code class="language-yml">#ä½¿ç”¨node:12-alpine ä½œä¸ºåŸºç¡€è¿›è¡Œæ„å»º
FROM node:12-alpine

#åˆ›å»º/app ç›®å½•ä½œä¸ºéƒ¨ç½²ç›®å½•,åˆ›å»ºå®¹å™¨å®ä¾‹æ—¶,æŒ‚è½½æ­¤ç›®å½•
RUN mkdir -p /app

#ç§»åŠ¨å·¥ä½œç›®å½•åˆ° /app
WORKDIR /app

#å®‰è£… bash å’Œ busybox
RUN apk update \
        &amp;&amp; apk upgrade \
        &amp;&amp; apk add --no-cache bash \
        bash-doc \
        bash-completion \
        &amp;&amp; /bin/bash \
        &amp;&amp; apk add --no-cache busybox \
        &amp;&amp; rm -rf /var/cache/apk/*

#å®‰è£… git
RUN apk add git
		
#è®¾ç½®nodeç¯å¢ƒå˜é‡ä¸ºproduction
ENV NODE_ENV=production

# copy the app, note .dockerignore
COPY ./pets-client /app
RUN npm install

# build necessary, even if no static files are needed,
# since it builds the server as well
RUN npm run build
RUN npm cache clean --force

# set app serving to permissive / assigned
#ENV NUXT_HOST=0.0.0.0 å·²ç»åœ¨nuxt.config.jsä¸­è®¾ç½®äº†server block
# set app port
#ENV NUXT_PORT=5000 å·²ç»åœ¨nuxt.config.jsä¸­è®¾ç½®äº†server block

#è®¾ç½®å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œçš„å‘½ä»¤
#ENTRYPOINT [ &quot;npm&quot;,&quot;start&quot; ]
CMD [&quot;npm&quot;,&quot;start&quot;]
</code></pre>
<p>Dockerfileéƒ¨åˆ†åˆ°æ­¤å°±ç»“æŸäº†ï¼Œæ¥ä¸‹æ¥ï¼Œéœ€è¦äº†è§£Docker-Compose</p>
<h2 id="äºŒ-docker-compose">äºŒã€<a href="https://yeasy.gitbook.io/docker_practice/compose">Docker-Compose</a></h2>
<p>Docker-Compose æ˜¯ç”¨æ¥ç®¡ç†ä½ çš„å®¹å™¨çš„ï¼Œæœ‰ç‚¹åƒä¸€ä¸ªå®¹å™¨çš„ç®¡å®¶ï¼Œæƒ³è±¡ä¸€ä¸‹å½“ä½ çš„Dockerä¸­æœ‰æˆç™¾ä¸Šåƒçš„å®¹å™¨éœ€è¦å¯åŠ¨ï¼Œå¦‚æœä¸€ä¸ªä¸€ä¸ªçš„å¯åŠ¨é‚£å¾—å¤šè´¹æ—¶é—´ã€‚æœ‰äº†Docker-Composeä½ åªéœ€è¦ç¼–å†™ä¸€ä¸ªæ–‡ä»¶ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢å£°æ˜å¥½è¦å¯åŠ¨çš„å®¹å™¨ï¼Œé…ç½®ä¸€äº›å‚æ•°ï¼Œæ‰§è¡Œä¸€ä¸‹è¿™ä¸ªæ–‡ä»¶ï¼ŒDockerå°±ä¼šæŒ‰ç…§ä½ å£°æ˜çš„é…ç½®å»æŠŠæ‰€æœ‰çš„å®¹å™¨å¯åŠ¨èµ·æ¥ï¼Œåªéœ€docker-compose upå³å¯å¯åŠ¨æ‰€æœ‰çš„å®¹å™¨ï¼Œä½†æ˜¯Docker-Composeåªèƒ½ç®¡ç†å½“å‰ä¸»æœºä¸Šçš„Dockerï¼Œä¹Ÿå°±æ˜¯è¯´ä¸èƒ½å»å¯åŠ¨å…¶ä»–ä¸»æœºä¸Šçš„Dockerå®¹å™¨ã€‚</p>
<p>è¡¥å……</p>
<blockquote>
<p>Docker Swarm<br>
Docker Swarm æ˜¯ä¸€æ¬¾ç”¨æ¥ç®¡ç†å¤šä¸»æœºä¸Šçš„Dockerå®¹å™¨çš„å·¥å…·ï¼Œå¯ä»¥è´Ÿè´£å¸®ä½ å¯åŠ¨å®¹å™¨ï¼Œç›‘æ§å®¹å™¨çŠ¶æ€ï¼Œå¦‚æœå®¹å™¨çš„çŠ¶æ€ä¸æ­£å¸¸å®ƒä¼šå¸®ä½ é‡æ–°å¸®ä½ å¯åŠ¨ä¸€ä¸ªæ–°çš„å®¹å™¨ï¼Œæ¥æä¾›æœåŠ¡ï¼ŒåŒæ—¶ä¹Ÿæä¾›æœåŠ¡ä¹‹é—´çš„è´Ÿè½½å‡è¡¡ï¼Œè€Œè¿™äº›ä¸œè¥¿Docker-Compose æ˜¯åšä¸åˆ°çš„</p>
<p><a href="https://yeasy.gitbook.io/docker_practice/kubernetes/intro">Kubernetes</a><br>
Kuberneteså®ƒæœ¬èº«çš„è§’è‰²å®šä½æ˜¯å’ŒDocker Swarm æ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä»–ä»¬è´Ÿè´£çš„å·¥ä½œåœ¨å®¹å™¨é¢†åŸŸæ¥è¯´æ˜¯ç›¸åŒçš„éƒ¨åˆ†ï¼Œéƒ½æ˜¯ä¸€ä¸ªè·¨ä¸»æœºçš„å®¹å™¨ç®¡ç†å¹³å°ï¼Œå½“ç„¶ä¹Ÿæœ‰è‡ªå·±ä¸€äº›ä¸ä¸€æ ·çš„ç‰¹ç‚¹ï¼Œk8sæ˜¯è°·æ­Œå…¬å¸æ ¹æ®è‡ªèº«çš„å¤šå¹´çš„è¿ç»´ç»éªŒç ”å‘çš„ä¸€æ¬¾å®¹å™¨ç®¡ç†å¹³å°ã€‚è€ŒDocker Swarmåˆ™æ˜¯ç”±Docker å…¬å¸ç ”å‘çš„ã€‚<strong>ç°åœ¨å¸¸ç”¨Kubernetes</strong></p>
</blockquote>
<p>å®ƒå…è®¸ç”¨æˆ·é€šè¿‡ä¸€ä¸ªå•ç‹¬çš„ <code>docker-compose.yml</code> æ¨¡æ¿æ–‡ä»¶ï¼ˆYAML æ ¼å¼ï¼‰æ¥å®šä¹‰ä¸€ç»„ç›¸å…³è”çš„åº”ç”¨å®¹å™¨ä¸ºä¸€ä¸ªé¡¹ç›®ï¼ˆprojectï¼‰ã€‚</p>
<p><code>Compose</code> ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼š</p>
<ul>
<li>æœåŠ¡ (<code>service</code>)ï¼šä¸€ä¸ªåº”ç”¨çš„å®¹å™¨ï¼Œå®é™…ä¸Šå¯ä»¥åŒ…æ‹¬è‹¥å¹²è¿è¡Œç›¸åŒé•œåƒçš„å®¹å™¨å®ä¾‹ã€‚</li>
<li>é¡¹ç›® (<code>project</code>)ï¼šç”±ä¸€ç»„å…³è”çš„åº”ç”¨å®¹å™¨ç»„æˆçš„ä¸€ä¸ªå®Œæ•´ä¸šåŠ¡å•å…ƒï¼Œåœ¨ <code>docker-compose.yml</code> æ–‡ä»¶ä¸­å®šä¹‰ã€‚</li>
</ul>
<p><code>Compose</code> çš„é»˜è®¤ç®¡ç†å¯¹è±¡æ˜¯é¡¹ç›®ï¼Œé€šè¿‡å­å‘½ä»¤å¯¹é¡¹ç›®ä¸­çš„ä¸€ç»„å®¹å™¨è¿›è¡Œä¾¿æ·åœ°ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚</p>
<p>æœ¬èŠ‚çš„å®‰è£…é“¾æ¥å·²ç»æœ‰å®‰è£…æ•™ç¨‹ï¼Œå®‰è£…æ­¤å¤„ç•¥</p>
<p>ç»™å‡ºæœ¬æ¬¡é¡¹ç›®çš„å®Œæˆç‰ˆæœ¬<code>docker-compose.prod.yml</code></p>
<h4 id="å®Œæˆç‰ˆæœ¬docker-composeprodyml">å®Œæˆç‰ˆæœ¬<code>docker-compose.prod.yml</code></h4>
<pre><code class="language-yml">version: &quot;3.7&quot;
services:
  app:
    build:
      args:
        user: petapi
        uid: 1000
      context: ./
      dockerfile: Dockerfile
    image: petapii
    container_name: petapi-app
    restart: unless-stopped
    working_dir: /var/www/
    volumes:
      - ./:/var/www
    networks:
      - petapin
  frontapp:
    build:
      context: ~/petclient/dockerfiles/node/
      dockerfile:  Dockerfile
    image: frontapp
    container_name: petclient-frontapp
    restart: unless-stopped
    working_dir: /app
    networks:
      - petclientn
  db:
    image: mysql:5.7
    container_name: petapi-db
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_USER: ${DB_USERNAME}
      SERVICE_TAGS: dev
      SERVICE_NAME: mysql
    volumes:
      - ./docker-compose/mysql:/docker-entrypoint-initdb.d
    networks:
      - petapin
  nginx:
    image: nginx:1.19.1-alpine
    container_name: pet-nginx
    restart: always
    depends_on:
      - app
      - frontapp
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./:/var/www
      - ./docker-compose/nginx:/etc/nginx/conf.d
      - ./docker-compose/nginx/certs:/etc/nginx/certs
    networks:
      - petapin
      - petclientn
networks:
  petapin:
    driver: bridge
  petclientn:
    driver: bridge
</code></pre>
<p>æ¥ä¸‹æ¥ç»†åˆ†æ‹†è§£ï¼›</p>
<h3 id="appéƒ¨åˆ†">appéƒ¨åˆ†ï¼š</h3>
<pre><code class="language-yml">app:
    build:
      args:
        user: petapi
        uid: 1000
      context: ./
      dockerfile: Dockerfile
    image: petapii
    container_name: petapi-app
    restart: unless-stopped
    working_dir: /var/www/
    volumes:
      - ./:/var/www
    networks:
      - petapin
</code></pre>
<p>è¿™æ˜¯å®šä¹‰çš„ç¬¬ä¸€ä¸ªæœåŠ¡ï¼Œ</p>
<p>appã€phpã€‘çš„Dockerfileé‡Œï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªå‚æ•° user å’Œ uid ï¼Œè¿™é‡Œè¿›è¡Œäº†èµ‹å€¼ã€‚</p>
<p>å› ä¸ºä½¿ç”¨buildæŒ‡ä»¤ï¼Œæ‰€ä»¥å¿…é¡»ç»™åˆ°context å’Œ Dockerfileï¼Œè¿™ä¸ªcontextå³å·²ç»åœ¨ <a href="#%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E4%B8%8A%E4%B8%8B%E6%96%87%EF%BC%88Context%EF%BC%89">å‰é¢æåˆ°è¿‡çš„é•œåƒæ„å»ºä¸Šä¸‹æ–‡ã€‚</a></p>
<p>buildå¯ä»¥ä¸ç»™context ç›´æ¥ç»™è·¯å¾„å¦‚ï¼š<code>build: ./dir</code> éœ€è¦æ³¨æ„çš„æ ¼å¼æ˜¯ <code>build:[ç©ºæ ¼]./dir</code> <strong>ç©ºæ ¼ä¸èƒ½å°‘</strong></p>
<p>image æ˜¯ç»™è¿™ä¸ªç”Ÿæˆçš„é•œåƒçš„åå­—ï¼Œå¦‚æœæ²¡æœ‰buildè€Œæ˜¯ç›´æ¥ç»™imageï¼Œdockerä¼šå»dockerhubå®˜æ–¹æœè¿™ä¸ªåŒ…ï¼Œæœåˆ°äº†å°±ç»™pullä¸‹æ¥ã€‚</p>
<p>app å…¶è¿è¡Œèµ·æ¥çš„å®¹å™¨åå«petapi-appï¼Œè¿™ä¸ªåå­—å¾ˆé‡è¦ï¼Œnginxçš„confé‡Œï¼Œæˆ‘ä»¬ä¼šç”¨åˆ°è¿™ä¸ªï¼š</p>
<blockquote>
<pre><code class="language-conf">server {
listen 80;
   listen [::]:80;
   server_name api.example.com;
   return 301 https://$http_host$request_uri;
   #rewrite ^(.*)$ https://$host$1 permanent; we just replace request to https
}
server{
listen 443 ssl;
   listen [::]:443 ssl;
   server_name api.example.com;
   #ssl on; no need this anymore please change use listen 443 ssl only
   ssl_certificate /etc/nginx/certs/cert.pem;
   ssl_certificate_key /etc/nginx/certs/key.pem;
   #ssl_session_timeout 5m;
   #ssl_protocols read blow info please;
   # By default nginx uses â€œssl_protocols TLSv1 TLSv1.1 TLSv1.2â€ and â€œssl_ciphers HIGH:!aNULL:!MD5â€, so configuring them explicitly is generally not needed.
   index index.php index.html;
   error_log /var/log/nginx/error.log;
   access_log /var/log/nginx/access.log;
   root /var/www/public;
   location ~ \.php$ {
           try_files $uri =404;
           fastcgi_split_path_info ^(.+\.php)(/.+)$;
           fastcgi_pass petapi-app:9000;
           fastcgi_index index.php;
           include fastcgi_params;
           fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
           fastcgi_param PATH_INFO $fastcgi_path_info;
           }
   location / {
            try_files $uri $uri/ /index.php?$query_string;
            gzip_static on;
            }
    }   
</code></pre>
</blockquote>
<pre><code> æ³¨æ„ `fastcgi_pass petapi-app:9000;` æˆ‘ä»¬ç”¨åˆ°äº†container_name å³è¿™ä¸ªappå®¹å™¨çš„åå­—ã€‚9000æ˜¯é»˜è®¤php-fpmçš„ç«¯å£ã€‚
</code></pre>
<p>å…¶æ¬¡ï¼Œæˆ‘ä»¬Dockerfileä¹‹å‰æ²¡æœ‰è®¾ç½®æ•°æ®å·ï¼Œè¿™é‡Œè®¾ç½®äº†åŠ è½½ <code>docker-compose.prod.yml</code>æ‰€åœ¨æ–‡ä»¶å¤¹å…¨éƒ¨å†…å®¹ åˆ°å®¹å™¨ä¸­</p>
<p>restart:  æŒ‡å®šå®¹å™¨é€€å‡ºåçš„é‡å¯ç­–ç•¥ä¸ºå§‹ç»ˆé‡å¯ã€‚è¯¥å‘½ä»¤å¯¹ä¿æŒæœåŠ¡å§‹ç»ˆè¿è¡Œååˆ†æœ‰æ•ˆï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ¨èé…ç½®ä¸º <code>always</code> æˆ–è€… <code>unless-stopped</code>ã€‚</p>
<p>networks:  é…ç½®å®¹å™¨è¿æ¥çš„ç½‘ç»œã€‚è¿™ä¸ªç½‘ç»œä¸»è¦æ˜¯ç»™æœåŠ¡å®¹å™¨ä¹‹é—´é€šä¿¡çš„ï¼Œdbæˆ‘ä»¬ç”¨çš„mysqlé€šè¿‡è¿™ä¸ªç½‘ç»œå’Œappé€šä¿¡ï¼Œnginxä¹Ÿé€šè¿‡è¿™ä¸ªç½‘ç»œå’Œappé€šä¿¡ã€‚è¿™ä¸‰ä¸ªå…¬ç”¨çš„ petapin è¿™ä¸ªç½‘è·¯ï¼Œè¿™ä¸ªç½‘ç»œæ˜¯åœ¨ å¤–å±‚ networks:ä¸­å®šä¹‰çš„ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œdocker -compose å°±æ˜¯ï¼š</p>
<pre><code class="language-yml">version: 
services:
networks:
</code></pre>
<p>è¿™ä¸‰ä¸ªã€‚<s>networks çš„ driver å¯ä»¥å‚è€ƒ network_modeã€‚</s>  <strong>é”™å•¦ï¼networks åº”è¯¥å‚è€ƒ <a href="https://docs.docker.com/compose/compose-file/#network-configuration-reference">Network configuration reference</a></strong></p>
<p>å…³äºnetworkså’Œlinks è¯·çœ‹ <a href="https://docs.docker.com/compose/networking/">Networking in Compose</a></p>
<blockquote>
<p>compose é»˜è®¤ä¼šæä¾›ä¸€ä¸ªnetwork ï¼Œæ¯ä¸ªæœåŠ¡éƒ½ä¼šåŠ å…¥è¿™ä¸ªnetworkï¼Œä¸”é»˜è®¤äº’é€šï¼Œå®ƒä»¬ä¹‹é—´ä»¥ä¸€ä¸ªåŸºäºå®¹å™¨åç”Ÿæˆçš„åä½œåŒºåˆ†ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ç½‘ç»œååŸºäºé¡¹ç›®åã€é¡¹ç›®åŸºäºå­˜æ”¾å…¶çš„æ–‡ä»¶å¤¹åã€‘</p>
<p>æ¯”å¦‚è¯´, å‡è®¾ä½ çš„appå­˜æ”¾äºä¸€ä¸ªå«<code>myapp</code>çš„æ–‡ä»¶å¤¹é‡Œ, ä½ çš„ <code>docker-compose.yml</code> é…ç½®å¦‚ä¸‹:</p>
<pre><code>version: &quot;3&quot;
services:
web:
build: .
ports:
    - &quot;8000:8000&quot;
db:
  image: postgres
  ports:
    - &quot;8001:5432&quot;
</code></pre>
<p>å½“ä½ æ‰§è¡Œ <code>docker-compose up</code>,çš„æ—¶å€™ ï¼Œä¼šæœ‰å¦‚ä¸‹æµç¨‹:</p>
<ol>
<li>ä¸€ä¸ªåå«<code>myapp_default</code>çš„ç½‘ç»œè¢«åˆ›å»º ã€‚</li>
<li>ä½¿ç”¨ <code>web</code>é…ç½®åˆ›å»ºä¸€ä¸ªå®¹å™¨. è¯¥å®¹å™¨åŠ å…¥ <code>myapp_default</code> ç½‘ç»œå¹¶ä¸”èµ‹äºˆä¸€ä¸ªæ ‡è¯†å <code>web</code>.</li>
<li>ä½¿ç”¨ <code>db</code>é…ç½®åˆ›å»ºä¸€ä¸ªå®¹å™¨.  è¯¥å®¹å™¨åŠ å…¥ <code>myapp_default</code> ç½‘ç»œå¹¶ä¸”èµ‹äºˆä¸€ä¸ªæ ‡è¯†å db.</li>
</ol>
<p>æ¯ä¸€ä¸ªå®¹å™¨éƒ½å¯ä»¥é€šè¿‡æ ‡è¯†å<code>web</code>,<code>db</code>æŸ¥è¯¢åˆ°è¿™ä¸¤å®¹å™¨ï¼Œå¹¶è·å¾—è¿™ä¸¤å®¹å™¨çš„ipåœ°å€ï¼Œæ¯”å¦‚ï¼Œwebå®¹å™¨é‡Œçš„ç¨‹åºä»£ç å¯ä»¥é€šè¿‡<code>postgres:5342</code>é“¾æ¥åˆ°<code>db</code>å®¹å™¨ï¼Œå°±å¯ä»¥ä½¿ç”¨postgresæ•°æ®åº“å•¦ã€‚</p>
<p>It is important to note the distinction between <code>HOST_PORT</code> and <code>CONTAINER_PORT</code>. In the above example, for <code>db</code>, the <code>HOST_PORT</code> is <code>8001</code> and the container port is <code>5432</code> (postgres default). Networked service-to-service communication use the <code>CONTAINER_PORT</code>. When <code>HOST_PORT</code> is defined, the service is accessible outside the swarm as well.</p>
<p>Within the <code>web</code> container, your connection string to <code>db</code> would look like <code>postgres://db:5432</code>, and from the host machine, the connection string would look like <code>postgres://{DOCKER_IP}:8001</code>.</p>
<h2 id="linksäº†è§£å°±è¡Œ"><a href="https://docs.docker.com/compose/networking/#links">Linksäº†è§£å°±è¡Œ</a></h2>
<p>è¿™ä¸ªå‚è€ƒ <a href="https://docs.docker.com/compose/compose-file/#links"><strong>linkså°†ä¼šåœ¨ä»Šåè¢«ç§»é™¤</strong></a>ï¼ŒåæœŸè¿™ä¸ªæ²¡æœ‰äº†ï¼Œç°åœ¨äº†è§£å°±è¡Œï¼Œä¸æ¨èä½¿ç”¨ã€‚</p>
<p>Links allow you to define extra aliases by which a service is reachable from another service. They are not required to enable services to communicate - by default, any service can reach any other service at that serviceâ€™s name. In the following example, <code>db</code> is reachable from <code>web</code> at the hostnames <code>db</code> and <code>database</code>:</p>
<pre><code>version: &quot;3&quot;
services:

web:
  build: .
  links:
    - &quot;db:database&quot;
db:
  image: postgres
</code></pre>
<p>See the <a href="https://docs.docker.com/compose/compose-file/compose-file-v2/#links">links reference</a> for more information.</p>
<h2 id="networks"><a href="https://docs.docker.com/compose/compose-file/#networks">NETWORKS</a></h2>
<p>æˆ‘ä»¬è¿™é‡Œç”¨çš„å°±æ˜¯è¿™ä¸ªã€‚</p>
</blockquote>
<p>æ›´å¤šçš„æŒ‡ä»¤å‚è€ƒ <a href="https://yeasy.gitbook.io/docker_practice/compose/compose_file">docker compose æŒ‡ä»¤</a></p>
<p>frontappé…ç½®å‚è€ƒä¸Šé¢çš„è‡ªå·±ç†è§£ï¼Œ</p>
<h3 id="dbéƒ¨åˆ†">dbéƒ¨åˆ†ï¼š</h3>
<pre><code class="language-yml">  db:
    image: mysql:5.7
    container_name: petapi-db
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_USER: ${DB_USERNAME}
      SERVICE_TAGS: dev
      SERVICE_NAME: mysql
    volumes:
      - ./docker-compose/mysql:/docker-entrypoint-initdb.d
    networks:
      - petapin
</code></pre>
<p>æ•°æ®åº“åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªå¯¼å…¥çš„æ“ä½œï¼Œå¦‚æœä»¥åç½‘ç«™ä¸»æœºè¿ç§»ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥æ‰“åŒ…å¯¼å…¥ï¼Œæ•™ç¨‹åœ¨cnblogæœ‰ã€‚</p>
<p>æ•°æ®åº“éƒ¨åˆ†å…¶ä½™çš„éƒ½æ²¡å•¥å¥½è¯´çš„ï¼Œä¸»è¦æ˜¯environmenté‡Œçš„é…ç½®ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä½¿ç”¨çš„æ˜¯</p>
<pre><code class="language-yml">environment:
  RACK_ENV: development
  SHOW: 'true'
  SESSION_SECRET:
environment:
  - RACK_ENV=development
  - SHOW=true
  - SESSION_SECRET
</code></pre>
<p>è¿™ç§èµ‹å€¼æ ¼å¼ã€‚</p>
<p>ä½†æ˜¯<code>${...}</code> æ€ä¹ˆç†è§£ï¼Ÿ</p>
<blockquote>
<p>You can use environment variables in configuration values with a Bash-like <code>${VARIABLE}</code> syntax - see <a href="https://docs.docker.com/compose/compose-file/#variable-substitution">variable substitution</a> for full details.</p>
<p>å°±æ˜¯è¯´ï¼Œ<code>${...}</code>æ˜¯å¯ä»¥è¯»å–è®¾ç½®åœ¨<code>.env</code>æ–‡ä»¶ä¸­çš„å€¼çš„ï¼Œä½†æ˜¯å¿…é¡»åœ¨æ‰§è¡Œ <code>docker-compose up</code>çš„æ—¶å€™ï¼Œå¦‚æœåœ¨æ‰§è¡Œçš„æ—¶å€™å¦è¡Œèµ‹å€¼ <code>--name=...</code>ä¼šè¦†ç›–<code>.env</code>ä¸­çš„å€¼ã€‚<code>.env</code>æ–‡ä»¶ä¸­é…ç½®çš„å€¼åªåœ¨ <code>docker-compose up</code>æ‰§è¡Œçš„æ—¶å€™èµ·ä½œç”¨ï¼Œ<code>docker stack deploy</code>ä¸èµ·ä½œç”¨ã€‚</p>
<p>å…¶ä»–ç”¨æ³•ï¼š <code>${VARIABLE:-default}</code>åŠ<code>${VARIABLE-default}</code> åŠ<code>${VARIABLE:?err}</code>åŠ<code>${VARIABLE?err}</code></p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸Šé¢é…ç½®dbå®¹å™¨çš„å€¼ï¼Œåœ¨docker-compose upçš„æ—¶å€™ï¼Œè¯»å–åŒç›®å½•ä¸‹.envæ–‡ä»¶ä¸­é…ç½®çš„å€¼ã€‚</p>
<h3 id="nginxéƒ¨åˆ†">nginxéƒ¨åˆ†</h3>
<pre><code class="language-yml">nginx:
    image: nginx:1.19.1-alpine
    container_name: pet-nginx
    restart: always
    depends_on:
      - app
      - frontapp
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./:/var/www
      - ./docker-compose/nginx:/etc/nginx/conf.d
      - ./docker-compose/nginx/certs:/etc/nginx/certs
    networks:
      - petapin
      - petclientn
</code></pre>
<p>nginxé…ç½®ä¸­æˆ‘ä»¬ä½¿ç”¨äº†ä¸¤ä¸ªconfï¼Œpetapi.confåŠ petclient.confå­˜æ”¾äº ./docker-compose/nginxç›®å½•ä¸‹ã€‚é€šè¿‡volumesé…ç½®ï¼ŒåŠ è½½åˆ°äº†nginxå®¹å™¨å†…çš„/etc/nginx/conf.dæ–‡ä»¶å¤¹ä¸­ã€‚</p>
<p>ç„¶åæ˜¯sslçš„key.pemå’Œcert.pemæ–‡ä»¶å­˜æ”¾åœ¨./docker-compose/nginx/certsæ–‡ä»¶å¤¹ä¸‹ã€‚é€šè¿‡volumesé…ç½®ï¼ŒåŠ è½½åˆ°äº†nginxå®¹å™¨å†…çš„/etc/nginx/certsæ–‡ä»¶å¤¹å†…ã€‚</p>
<p>ä¸ºä»€ä¹ˆé…ç½® ./åŠ è½½åˆ°/var/wwwæ–‡ä»¶å¤¹ä¸­å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬çœ‹çœ‹petapi.conf:</p>
<pre><code class="language-conf">server {
   listen 80;
        ç•¥...
     }
server{
   listen 443 ssl;
        listen [::]:443 ssl;
        server_name api.example.com;
        ssl_certificate /etc/nginx/certs/cert.pem;
        ssl_certificate_key /etc/nginx/certs/key.pem;
        index index.php index.html;
        error_log /var/log/nginx/error.log;
        access_log /var/log/nginx/access.log;
        root /var/www/public;
        location ~ \.php$ {
                try_files $uri =404;
                fastcgi_split_path_info ^(.+\.php)(/.+)$;
                fastcgi_pass petapi-app:9000;
                fastcgi_index index.php;
                }
        location / {
                 try_files $uri $uri/ /index.php?$query_string;
                 gzip_static on;
                 }
         }
</code></pre>
<p>å†çœ‹ç›®å½•ç»“æ„</p>
<pre><code>drwxrwxr-x 16 ***** *****     4096 Jul 18 15:05 ./                                         drwxrwxr-x  4 ***** *****      4096 Jul 13 07:09 ../                                         drwxrwxr-x 11 ***** *****      4096 Jul 12 17:00 app/                                       -rw-rw-r--  1 ***** *****      1686 Jul 12 17:00 artisan                                     drwxrwxr-x  3 ***** *****      4096 Jul 12 17:00 bootstrap/                                 -rw-rw-r--  1 ***** *****      1660 Jul 12 17:00 composer.json                               -rw-rw-r--  1 ***** *****    208927 Jul 12 17:00 composer.lock                               drwxrwxr-x  2 ***** *****      4096 Jul 12 17:00 config/                                     drwxrwxr-x  5 ***** *****      4096 Jul 12 17:00 database/                                   drwxrwxr-x  4 ***** *****      4096 Jul 16 06:15 docker-compose/                             -rw-rw-r--  1 ***** *****      1806 Jul 18 13:06 docker-compose.prod.yml                     -rw-rw-r--  1 ***** *****       741 Jul 12 17:12 Dockerfile                                 drwxrwxr-x  3 ***** *****      4096 Jul 15 18:07 dockerfiles/                               -rw-rw-r--  1 ***** *****       220 Jul 12 17:00 .editorconfig                               -rw-rw-r--  1 ***** *****       844 Jul 12 18:37 .env                                       -rw-rw-r--  1 ***** *****       778 Jul 12 17:00 .env.example                               drwxrwxr-x  8 ***** *****      4096 Jul 12 17:00 .git/                                       -rw-rw-r--  1 ***** *****       111 Jul 12 17:00 .gitattributes                             -rw-rw-r--  1 ***** *****       163 Jul 12 17:00 .gitignore                                 drwxrwxr-x  2 ***** *****      4096 Jul 12 17:00 .idea/                                     -rw-rw-r--  1 ***** *****      1013 Jul 12 17:00 package.json                               -rw-rw-r--  1 ***** *****    462139 Jul 12 17:00 package-lock.json                           -rw-rw-r--  1 ***** *****      1197 Jul 12 17:00 phpunit.xml                                 drwxrwxr-x  2 ***** *****      4096 Jul 13 14:46 public/
-rw-rw-r--  1 ***** *****      4497 Jul 12 17:00 README.md
drwxrwxr-x  6 ***** *****      4096 Jul 12 17:00 resources/
drwxrwxr-x  2 ***** *****      4096 Jul 12 17:00 routes/
-rw-rw-r--  1 ***** *****       563 Jul 12 17:00 server.php
drwxrwxr-x  5 ***** ********   4096 Jul 12 17:00 storage/
-rw-rw-r--  1 ***** *****       174 Jul 12 17:00 .styleci.yml
drwxrwxr-x  4 ***** *****      4096 Jul 12 17:00 tests/
drwxr-xr-x 48 ***** *****      4096 Jul 12 18:28 vendor/
-rw-rw-r--  1 ***** *****       538 Jul 12 17:00 webpack.mix.js
</code></pre>
<p>nginxåœ¨ api.example.com:80æˆ–443è¯·æ±‚çš„æ—¶å€™ï¼Œ80å¼ºåˆ¶è½¬443ï¼Œç„¶åçœ‹443ä¸­å¤„ç†é€»è¾‘ã€‚</p>
<p>å®¹å™¨ä¸­çš„<code>root /var/www/public/</code>å¯¹åº”çš„å°±æ˜¯å®¿ä¸»æœº publicæ–‡ä»¶å¤¹ã€‚</p>
<pre><code>location / {
                 try_files $uri $uri/ /index.php?$query_string;
                 gzip_static on;
                 }
         }
</code></pre>
<p>è®¿é—®çš„æ—¶å€™ï¼Œå°è¯•çš„æ˜¯æ¯”å¦‚	<code>http://api.exampl.com/api/pigs/all/1</code>ä¼šè§£æå‡ºuri <code>api/pigs/all/1</code>ï¼Œè¿™ä¸ªuriæ–‡ä»¶åœ¨publicç›®å½•ä¸­æ˜¯æ²¡æœ‰çš„ã€‚</p>
<p>publicç›®å½•ï¼š</p>
<pre><code>drwxrwxr-x  2 ***** ***** 4096 Jul 13 14:46 ./                                               drwxrwxr-x 16 ***** ***** 4096 Jul 18 15:05 ../                                             -rw-rw-r--  1 ***** *****    0 Jul 12 17:00 favicon.ico                                     -rw-rw-r--  1 ***** *****  603 Jul 12 17:00 .htaccess
-rw-rw-r--  1 ***** ***** 1823 Jul 12 17:00 index.php
-rw-rw-r--  1 ***** *****   24 Jul 12 17:00 robots.txt
lrwxrwxrwx  1 ***** *****   27 Jul 13 14:46 storage -&gt; /var/www/storage/app/public
-rw-rw-r--  1 ***** ***** 1194 Jul 12 17:00 web.config
</code></pre>
<p>æ‰€ä»¥ç›´æ¥è·³è§£æ<code>/index.php?$query_string;</code> ç„¶å$query_stringå°±æ˜¯<code>api/pigs/all/1</code>ï¼Œç„¶åå°±æ˜¯laravelå·¥ä½œé€»è¾‘äº†ã€‚è§£æå‡ºrequestï¼Œparameters...</p>
<p>æ‰€ä»¥è¿™ä¸ªåŠ è½½åˆ°nginxä¸­æ˜¯å¿…è¦çš„ï¼Œå¦‚æœä¸ç”¨try_fileså‘¢ã€æ²¡è¯•è¿‡ã€‘ï¼Ÿé‚£åº”è¯¥å°±appå®¹å™¨å¼€ä¸€ä¸ªç«¯å£[æ¯”å¦‚12343]ï¼Œç„¶ånginxä½¿ç”¨proxy_pass petapi-app:å¼€çš„ç«¯å£å·[12343] ï¼Œè¿™æ ·å°±okäº†å§ã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹çœ‹sslé…ç½®ï¼Œå‰é¢è¯´åˆ°</p>
<blockquote>
<p>sslçš„key.pemå’Œcert.pemæ–‡ä»¶å­˜æ”¾åœ¨./docker-compose/nginx/certsæ–‡ä»¶å¤¹ä¸‹ã€‚é€šè¿‡volumesé…ç½®ï¼ŒåŠ è½½åˆ°äº†nginxå®¹å™¨å†…çš„/etc/nginx/certsæ–‡ä»¶å¤¹å†…ã€‚</p>
</blockquote>
<p>æ‰€ä»¥ssléƒ¨åˆ†çš„é…ç½®æœ‰ï¼š</p>
<pre><code>ssl_certificate /etc/nginx/certs/cert.pem;
ssl_certificate_key /etc/nginx/certs/key.pem;
</code></pre>
<p>åŒæ ·çš„æ¥çœ‹çœ‹</p>
<p>frontappéƒ¨åˆ†çš„confé…ç½®ï¼š</p>
<pre><code>server {
        listen 80;
        listen [::]:80;
        server_name example.com www.example.com;
        return 301 https://$http_host$request_uri;
        #rewrite ^(.*)$ https://$host$1 permanent; we just replace request to https
}
server{
        listen 443 ssl;
        listen [::]:443 ssl;
        server_name example.com www.example.com;
        #ssl on; no need this anymore please change use listen 443 ssl only
        ssl_certificate /etc/nginx/certs/cert.pem;
        ssl_certificate_key /etc/nginx/certs/key.pem;
        #ssl_session_timeout 5m;
        #ssl_protocols read blow info please;
        # By default nginx uses â€œssl_protocols TLSv1 TLSv1.1 TLSv1.2â€ and â€œssl_ciphers HIGH:!aNULL:!MD5â€, so configuring them explicitly is generally not needed.
        index index.php index.html;
        error_log /var/log/nginx/error.log;
        access_log /var/log/nginx/access.log;
        root /var/www/public;
        location ~ \.php$ {
                try_files $uri =404;
                fastcgi_split_path_info ^(.+\.php)(/.+)$;
                fastcgi_pass frontapp:9000;
                fastcgi_index index.php;
                include fastcgi_params;
                fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                fastcgi_param PATH_INFO $fastcgi_path_info;
                }

        location / {
                proxy_set_header X-Real-IP $remote_addr;
				proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
				proxy_set_header Host  $http_host;
				proxy_set_header X-Nginx-Proxy true;
				proxy_set_header Connection &quot;&quot;;
				proxy_pass http://frontapp:8000; #å› ä¸ºåœ¨nuxtä¸­ serveré…ç½®å°±è¿™ä¸ª
                gzip_static on;
                }
        }
</code></pre>
<p>ä¸petapi.confä¸åŒçš„å°±æ˜¯</p>
<pre><code>location / {
                proxy_set_header X-Real-IP $remote_addr;
				proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
				proxy_set_header Host  $http_host;
				proxy_set_header X-Nginx-Proxy true;
				proxy_set_header Connection &quot;&quot;;
				proxy_pass http://frontapp:8000; #å› ä¸ºåœ¨nuxtä¸­ serveré…ç½®å°±è¿™ä¸ª
                gzip_static on;
                }
</code></pre>
<p>proxy_passä¸€å®šæ˜¯ http://å¼€å¤´+ip+:+ç«¯å£ï¼Œ</p>
<p>ipç”¨äº†å®¹å™¨å‚æ•°ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºå•¥nginxå®¹å™¨çš„depends_onè®¾ç½®äº†appå’Œfrontappä¸¤ä¸ªå®¹å™¨ï¼Œå› ä¸ºè¦ç”¨å•Šã€‚</p>
<p>ç«¯å£è®¾ç½®ä¸º8000æ˜¯å› ä¸ºnuxtä¸­<code>nuxt.config.js</code>å€¼ä¸ºï¼š</p>
<pre><code class="language-js">  server: {
    port: 8000, // default: 3000
    host: '0.0.0.0', // default: localhost,
    timing: false
    // timing: {
    //   total: true
    // }
  },
</code></pre>
<p>ç«¯å£ç»™è®¾ç½®äº†8000ï¼Œnodeçš„<a href="#node%E5%AE%B9%E5%99%A8Dockerfile">Dockerfile</a>æˆ‘ä»¬ä¹Ÿå°±æ²¡æœ‰å¼€ç«¯å£äº†ã€‚</p>
<p>å¦‚æœç»™docker-compose.prod.ymlåŠ ä¸€ä¸ª</p>
<pre><code class="language-yml">  frontapp:
    build:
      context: ~/petclient/dockerfiles/node/
      dockerfile:  Dockerfile
    image: frontapp
    container_name: petclient-frontapp
    restart: unless-stopped
    working_dir: /app
    ports:
     - 800:8000
    networks:
      - petclientn
</code></pre>
<p>æ³¨æ„å…¶ä¸­</p>
<pre><code class="language-yml">    ports:
     - 800:8000
</code></pre>
<p>åŠ ä¸Šäº†å°±å¯ä»¥é€šè¿‡å®¿ä¸»æœºip[å½“å‰ç¯å¢ƒä¸‹å°±æ˜¯æœåŠ¡å™¨ip]:8000ç›´æ¥è®¿é—®nuxtåº”ç”¨ã€‚æˆ‘ä»¬è¿™é‡Œä¸ç”¨ï¼Œåªæ˜¯è¯´åŸç†å¦‚æ­¤ã€‚ä½†æ˜¯å¦‚æœä½ ç»™å¼€ä¸ª443ç«¯å£è®¿é—®è¿™ä¸ª8000ç«¯å£ï¼Œä¼šä¸è¡Œï¼Œä¼šæŠ¥ç«¯å£å·²ç»è¢«(å°±æ˜¯nginxå®¹å™¨)å ç”¨ã€‚</p>
<p>docker-compose.prod.ymlé…ç½®å®Œäº†ï¼Œç„¶åæ‰§è¡Œ <code>docker-compose -f docker-compose.prod.yml build app frontapp</code>ç»™çˆ·ç”Ÿæˆè¿™ä¸¤å®¹å™¨çš„é•œåƒå‡ºæ¥ã€‚ç”Ÿæˆå®Œäº† æ‰§è¡Œ <code>docker-compose -f docker-compose.prod.yml up -d</code>å°±å¯ä»¥è·‘èµ·æ¥äº†ã€‚æ‰§è¡Œå‘½ä»¤åˆ‡æ¢åˆ° docker-compose.prod.ymlæ–‡ä»¶çš„ç›®å½•ä¸‹ï¼Œè¿™æ ·-fæŒ‡å®šå…å¾—ç»™ä¸€ä¸²é•¿çš„åœ°å€ã€‚</p>
<h2 id="ä¸‰-laravelå‘å¸ƒéœ€è¦å‡†å¤‡çš„æ–‡ä»¶å’Œç”Ÿäº§ç¯å¢ƒè¦åšçš„ä¸€äº›æ“ä½œ">ä¸‰ã€laravelå‘å¸ƒéœ€è¦å‡†å¤‡çš„æ–‡ä»¶å’Œç”Ÿäº§ç¯å¢ƒè¦åšçš„ä¸€äº›æ“ä½œ</h2>
<p>laravelçš„ä»£ç ï¼Œæˆ‘æ˜¯ç›´æ¥git clone ä¸‹æ¥ç„¶åè¿›åˆ°appå®¹å™¨é‡Œ</p>
<p>æ‰§è¡Œ</p>
<p><code>cp .env.example .env</code> .envæ–‡ä»¶ã€‚</p>
<p><code>php artisan key:generate</code> ç”Ÿæˆkey</p>
<p>ç„¶åè‡ªå·±é…ç½®.envæ–‡ä»¶ä¸­çš„å€¼ï¼Œmailå•Š jwtå•Š mysqlä¹‹ç±»çš„ã€‚</p>
<p><code>php artisan migrate</code> æ•°æ®åº“</p>
<p>ç„¶åå°±æ˜¯è¿›å…¥dbæ•°æ®åº“å®¹å™¨ï¼Œæ£€æŸ¥ç”¨æˆ·ï¼Œè¡¨ï¼Œå¯¼å…¥æ‰“åŒ…çš„æ•°æ®åº“ã€‚</p>
<p>æ¥ç€å°±æ˜¯æŠŠstorageé‡Œçš„æ–‡ä»¶ç”¨rsyncç»™ä¼ åˆ°æœåŠ¡å™¨[å®¿ä¸»æœº]çš„laravelå­˜æ”¾æ–‡ä»¶å¤¹é‡Œçš„storageå¯¹åº”çš„æ–‡ä»¶å¤¹é‡Œã€‚</p>
<p>å†åœ¨appå®¹å™¨æ‰§è¡Œ</p>
<p><code>php artisan storage:link</code></p>
<p>ç„¶åå°±å¯ä»¥ç”¨äº†ã€‚</p>
<p>è‡³äºé‚®ä»¶ï¼Œéœ€è¦å¼€å¯queueï¼Œä»¥åŠsupervisorã€‚ã€æš‚ç¼ºã€‘</p>
<h2 id="å››-nuxté‡åˆ°çš„å‘">å››ã€nuxté‡åˆ°çš„å‘</h2>
<p>å¦‚æœæœ‰ä»£ç ç”¨åˆ°äº†</p>
<pre><code class="language-js"> target: (process.env.NODE_ENV === &quot;production&quot;) ? process.env.API_URL : &quot;http://petapi.test/api&quot;,
</code></pre>
<p>è¿™æ ·çš„ï¼Œé‚£envæ–‡ä»¶å¿…é¡»è¦æœ‰ã€‚å¦åˆ™å¿…ç„¶æŠ¥target null ç±»å‹é”™è¯¯ã€‚</p>
<p>è¿˜è¦å®‰è£…<a href="https://github.com/nuxt-community/dotenv-module">dotenv</a> ,ä¸”é…ç½®å¦‚ä¸‹ï¼š</p>
<pre><code class="language-js">require('dotenv').config(); //https://github.com/nuxt-community/proxy-module/issues/3


export default{
    ...
    modules: [
   ...
    // Doc: https://github.com/nuxt-community/dotenv-module
    '@nuxtjs/dotenv',
    ...
  ],
        ...
}

</code></pre>
<p>æˆ‘è¿™ä¸ªç›´æ¥ç”¨çš„ssrï¼Œç›®å‰è¿˜æ˜¯æœ‰ä¸ªé—®é¢˜å°±æ˜¯jsåŒ…å¤ªå¤§ï¼Œè¦ç²¾ç®€ä¸€ä¸‹ã€‚è™½ç„¶nuxtå¯ä»¥ç›´æ¥æsslä¸ç”¨nginxï¼Œä½†æ˜¯è¿™é‡Œ443ç«¯å£è¢«nginxå ç”¨äº†ï¼Œå¦å¤–nginxè¿˜æ˜¯æ¯”nodeè¦å¼ºã€‚node+nginxæ¨èã€‚</p>
<p>ä¹Ÿæ˜¯å‚è€ƒçš„ https://jonathanmh.com/deploying-a-nuxt-js-app-with-docker/</p>
<p>å…ˆç›´æ¥git cloneä»£ç ï¼Œç„¶åCOPYåˆ°frontappå®¹å™¨ï¼Œç„¶ånpm installï¼Œbuildï¼Œstartã€<a href="#node%E5%AE%B9%E5%99%A8Dockerfile">Dockerfileé‡Œæœ‰é…ç½®</a>ã€‘ã€‚</p>
<p>è¿™é‡Œå…¶å®å¯ä»¥ç”¨volumeåŠ è½½åˆ°å®¹å™¨çš„ï¼Œæˆ‘æ˜¯COPYï¼Œåæ­£å‰ç«¯ä¹Ÿæ²¡å•¥å˜åŒ–ï¼Œå˜åŒ–äº†å°±åˆè¦install buildä¸€å¥—ï¼Œvolumeé—®é¢˜ä¸å¤§ã€‚</p>
<p>å› ä¸ºnuxtå¼€å‘çš„.gitignoreæ²¡æœ‰æ·»åŠ staticæ–‡ä»¶å¤¹ï¼Œæ‰€ä»¥git cloneçš„æ—¶å€™å°±æœ‰äº†staticæ–‡ä»¶å¤¹é‡Œçš„æ–‡ä»¶ï¼Œå°±ä¸rsyncä¸Šä¼ äº†ã€‚</p>
<p>è®°å¾—nano .envæ·»åŠ  .envæ–‡ä»¶å¹¶é…ç½®éœ€è¦çš„å€¼ã€‚</p>
<p>æˆ‘é…ç½®çš„å°±æœ‰ï¼š</p>
<pre><code class="language-env">API_URL=&quot;https://api.example.com/api&quot;
NODE_ENV=&quot;production&quot;
AUTH_URL=&quot;https://api.example.com/api/auth&quot;
</code></pre>
<h2 id="äº”-mysql">äº”ã€mysql</h2>
<p>è¿™ä¸ªå®¹å™¨ç”¨çš„é»˜è®¤çš„æ²¡æœ‰bashï¼Œåªæœ‰shã€‚</p>
<p>ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤ã€‚</p>
<p>mysql -uroot -p</p>
<p>show databases;</p>
<p>use databaseA;</p>
<p>show datatables;</p>
<p>selecr * from datatableA1;</p>
<p>source æ‰“åŒ…çš„åœ°å€.sql ã€è¿™ä¸ªç”¨æ¥å¯¼å…¥çš„ã€‘</p>
<p>exit</p>
<h2 id="å…­-nginx">å…­ã€nginx</h2>
<p>ä¸Šé¢æåˆ°çš„petapi.confå’Œpetclient.confæ˜¯æ€ä¹ˆåŠ è½½è¿›nginxçš„å‘¢ï¼Ÿ</p>
<p>é¦–å…ˆè¿™ä¸¤ä¸ªé€šè¿‡<a href="#%E5%AE%8C%E6%88%90%E7%89%88%E6%9C%AC%60docker-compose.prod.yml%60">docker-compose.prod.yml</a> åŠ è½½è¿›äº†å®¹å™¨çš„ /etc/nginx/conf.dæ–‡ä»¶å¤¹é‡Œï¼Œç„¶å</p>
<p>çœ‹çœ‹nginx.confæ–‡ä»¶ï¼š</p>
<p>æ‰§è¡Œ<code>docker exec -it pet-nginx sh</code>è¿›åˆ°nginxå®¹å™¨ï¼Œå› ä¸ºæ²¡æœ‰å®‰è£…bashæ‰€ä»¥ç”¨shã€‚</p>
<p>æ‰¾åˆ°nginx.confæ‰“å¼€ï¼š</p>
<pre><code class="language-conf">user  nginx;                                                                                 worker_processes  auto;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;
events {
	worker_connections  1024;
}
http {
	include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '
                      '$status $body_bytes_sent &quot;$http_referer&quot; '
                      '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;

    include /etc/nginx/conf.d/*.conf;
}
</code></pre>
<p>æ³¨æ„å°±æ˜¯æœ€åä¸€è¡Œ<code>include /etc/nginx/conf.d/*.conf;</code>å¼•å…¥äº†è¿™ä¸¤ä¸ªconfæ–‡ä»¶ã€‚</p>
<p>åŒæ—¶æˆ‘ä»¬æ³¨æ„æƒé™ï¼š</p>
<pre><code class="language-drwxr-xr-x">drwxr-xr-x    1 root     root          4096 Jul 18 15:11 ..
drwxrwxr-x    2 1000     1000          4096 Jul 15 16:54 certs
drwxrwxr-x    3 1000     1000          4096 Jul 19 18:06 conf.d
-rw-r--r--    1 root     root          1077 Jul  7 16:14 fastcgi.conf
-rw-r--r--    1 root     root          1007 Jul  7 16:14 fastcgi_params
-rw-r--r--    1 root     root          2837 Jul  7 16:14 koi-utf
-rw-r--r--    1 root     root          2223 Jul  7 16:14 koi-win
-rw-r--r--    1 root     root          5231 Jul  7 16:14 mime.types
lrwxrwxrwx    1 root     root            22 Jul 10 20:27 modules -&gt; /usr/lib/nginx/modules
-rw-r--r--    1 root     root           646 Jul  7 16:14 nginx.conf
-rw-r--r--    1 root     root           636 Jul  7 16:14 scgi_params
-rw-r--r--    1 root     root           664 Jul  7 16:14 uwsgi_params
-rw-r--r--    1 root     root          3610 Jul  7 16:14 win-utf
</code></pre>
<p>è¿™é‡Œé¢certså’Œconf.dæ–‡ä»¶å¤¹çš„ownerå’Œç»„éƒ½æ˜¯1000ï¼Œå°±æ˜¯appå®¹å™¨é‡Œçš„ç”¨æˆ·ã€‚é‡Œé¢çš„æ–‡ä»¶ä¹Ÿæ˜¯è¿™æ ·çš„ã€‚</p>
<pre><code class="language-drwxrwxr-x">drwxr-xr-x    1 root     root          4096 Jul 18 15:11 ..
drwxrwxr-x    2 1000     1000          4096 Jul 15 16:54 certs
-rw-rw-r--    1 1000     1000          1465 Jul 19 18:06 petapi.conf
-rw-rw-r--    1 1000     1000          1709 Jul 18 15:07 petclient.conf
</code></pre>
<p><strong>æ³¨æ„è¿™æ˜¯åœ¨nginxå®¹å™¨é‡Œäº†ã€‚</strong></p>
<p>å¯¹æ¯”ä¸€çœ‹ certsæ–‡ä»¶å¤¹å¥½åƒé‡å¤äº†ã€‚å¯ä»¥æ”¹ï¼Œè¿™æ · æ³¨é‡Šæ‰<code>- ./docker-compose/nginx/certs:/etc/nginx/certs</code></p>
<p>ç„¶åæŠŠpetapi.confå’Œpetclient.confé‡ŒåŠ è½½sslæ–‡ä»¶çš„è·¯å¾„ç”±ï¼š</p>
<pre><code class="language-conf">ssl_certificate /etc/nginx/certs/cert.pem;
ssl_certificate_key /etc/nginx/certs/key.pem;
</code></pre>
<p>æ”¹ä¸ºï¼š</p>
<pre><code class="language-yml">ssl_certificate /etc/nginx/conf.d/certs/cert.pem;
ssl_certificate_key /etc/nginx/conf.d/certs/key.pem;
</code></pre>
<p>nginxè§£æä»£ç†é…ç½®ï¼Œæ¯”å¦‚ï¼š</p>
<pre><code class="language-conf">location /some/path/ {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_pass http://localhost:8000;
}
</code></pre>
<p>å‚è€ƒï¼š<a href="https://docs.nginx.com/nginx/admin-guide/web-server/reverse-proxy/">NGINX Reverse Proxy</a></p>
<p>è¿˜æœ‰ä¸ªUpstream å‚è€ƒ <a href="https://docs.nginx.com/nginx/admin-guide/security-controls/securing-http-traffic-upstream/">Securing HTTP Traffic to Upstream Servers</a></p>
<p>ä»¥åŠ <a href="https://www.thepolyglotdeveloper.com/2017/03/nginx-reverse-proxy-containerized-docker-applications/">Use NGINX As A Reverse Proxy To Your Containerized Docker Applications</a></p>
<p>ä»¥åŠ <a href="https://www.freecodecamp.org/news/docker-nginx-letsencrypt-easy-secure-reverse-proxy-40165ba3aee2/">How to set up an easy and secure reverse proxy with Docker, Nginx &amp; Letsencrypt</a></p>
<h2 id="æœ€åç›®å‰å­˜åœ¨çš„bug">æœ€åï¼Œç›®å‰å­˜åœ¨çš„bugï¼š</h2>
<p>ç½‘ç«™æ ‡é¢˜æ²¡æœ‰<img src="https://raw.githubusercontent.com/dzkjz/images-repo/master/%E6%89%B9%E6%B3%A8%202020-07-20%20141957.png" alt="æ‰¹æ³¨ 2020-07-20 141957" loading="lazy"></p>
<p>privacyæ²¡æœ‰ï¼Œcontactä¹ˆæœ‰ï¼Œfooteræ²¡æœ‰ï¼Œé‚®ä»¶ jwtæ²¡é…ç½®ï¼Œæ²¡å¼€queueï¼Œrecaptchaæ²¡é…ç½®ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Hello Gridea]]></title>
        <id>https://dzkjz.github.io/post/hello-gridea/</id>
        <link href="https://dzkjz.github.io/post/hello-gridea/">
        </link>
        <updated>2018-12-11T16:00:00.000Z</updated>
        <summary type="html"><![CDATA[<p>ğŸ‘  æ¬¢è¿ä½¿ç”¨ <strong>Gridea</strong> ï¼<br>
âœï¸  <strong>Gridea</strong> ä¸€ä¸ªé™æ€åšå®¢å†™ä½œå®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥è®°å½•ä½ çš„ç”Ÿæ´»ã€å¿ƒæƒ…ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„... ...</p>
]]></summary>
        <content type="html"><![CDATA[<p>ğŸ‘  æ¬¢è¿ä½¿ç”¨ <strong>Gridea</strong> ï¼<br>
âœï¸  <strong>Gridea</strong> ä¸€ä¸ªé™æ€åšå®¢å†™ä½œå®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥è®°å½•ä½ çš„ç”Ÿæ´»ã€å¿ƒæƒ…ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„... ...</p>
<!-- more -->
<p><a href="https://github.com/getgridea/gridea">Github</a><br>
<a href="https://gridea.dev/">Gridea ä¸»é¡µ</a><br>
<a href="http://fehey.com/">ç¤ºä¾‹ç½‘ç«™</a></p>
<h2 id="ç‰¹æ€§">ç‰¹æ€§ğŸ‘‡</h2>
<p>ğŸ“  ä½ å¯ä»¥ä½¿ç”¨æœ€é…·çš„ <strong>Markdown</strong> è¯­æ³•ï¼Œè¿›è¡Œå¿«é€Ÿåˆ›ä½œ</p>
<p>ğŸŒ‰  ä½ å¯ä»¥ç»™æ–‡ç« é…ä¸Šç²¾ç¾çš„å°é¢å›¾å’Œåœ¨æ–‡ç« ä»»æ„ä½ç½®æ’å…¥å›¾ç‰‡</p>
<p>ğŸ·ï¸  ä½ å¯ä»¥å¯¹æ–‡ç« è¿›è¡Œæ ‡ç­¾åˆ†ç»„</p>
<p>ğŸ“‹  ä½ å¯ä»¥è‡ªå®šä¹‰èœå•ï¼Œç”šè‡³å¯ä»¥åˆ›å»ºå¤–éƒ¨é“¾æ¥èœå•</p>
<p>ğŸ’»  ä½ å¯ä»¥åœ¨ <strong>Windows</strong>ï¼Œ<strong>MacOS</strong> æˆ– <strong>Linux</strong> è®¾å¤‡ä¸Šä½¿ç”¨æ­¤å®¢æˆ·ç«¯</p>
<p>ğŸŒ  ä½ å¯ä»¥ä½¿ç”¨ <strong>ğ–¦ğ—‚ğ—ğ—ğ—ğ–» ğ–¯ğ–ºğ—€ğ–¾ğ—Œ</strong> æˆ– <strong>Coding Pages</strong> å‘ä¸–ç•Œå±•ç¤ºï¼Œæœªæ¥å°†æ”¯æŒæ›´å¤šå¹³å°</p>
<p>ğŸ’¬  ä½ å¯ä»¥è¿›è¡Œç®€å•çš„é…ç½®ï¼Œæ¥å…¥ <a href="https://github.com/gitalk/gitalk">Gitalk</a> æˆ– <a href="https://github.com/SukkaW/DisqusJS">DisqusJS</a> è¯„è®ºç³»ç»Ÿ</p>
<p>ğŸ‡¬ğŸ‡§  ä½ å¯ä»¥ä½¿ç”¨<strong>ä¸­æ–‡ç®€ä½“</strong>æˆ–<strong>è‹±è¯­</strong></p>
<p>ğŸŒ  ä½ å¯ä»¥ä»»æ„ä½¿ç”¨åº”ç”¨å†…é»˜è®¤ä¸»é¢˜æˆ–ä»»æ„ç¬¬ä¸‰æ–¹ä¸»é¢˜ï¼Œå¼ºå¤§çš„ä¸»é¢˜è‡ªå®šä¹‰èƒ½åŠ›</p>
<p>ğŸ–¥  ä½ å¯ä»¥è‡ªå®šä¹‰æºæ–‡ä»¶å¤¹ï¼Œåˆ©ç”¨ OneDriveã€ç™¾åº¦ç½‘ç›˜ã€iCloudã€Dropbox ç­‰è¿›è¡Œå¤šè®¾å¤‡åŒæ­¥</p>
<p>ğŸŒ± å½“ç„¶ <strong>Gridea</strong> è¿˜å¾ˆå¹´è½»ï¼Œæœ‰å¾ˆå¤šä¸è¶³ï¼Œä½†è¯·ç›¸ä¿¡ï¼Œå®ƒä¼šä¸åœå‘å‰ ğŸƒ</p>
<p>æœªæ¥ï¼Œå®ƒä¸€å®šä¼šæˆä¸ºä½ ç¦»ä¸å¼€çš„ä¼™ä¼´</p>
<p>å°½æƒ…å‘æŒ¥ä½ çš„æ‰åå§ï¼</p>
<p>ğŸ˜˜ Enjoy~</p>
]]></content>
    </entry>
</feed>